<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="generator" content="pdoc 14.4.0"/>
    <title>source.core.architecture API documentation</title>

    <style>/*! * Bootstrap Reboot v5.0.0 (https://getbootstrap.com/) * Copyright 2011-2021 The Bootstrap Authors * Copyright 2011-2021 Twitter, Inc. * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE) * Forked from Normalize.css, licensed MIT (https://github.com/necolas/normalize.css/blob/master/LICENSE.md) */*,::after,::before{box-sizing:border-box}@media (prefers-reduced-motion:no-preference){:root{scroll-behavior:smooth}}body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans","Liberation Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";font-size:1rem;font-weight:400;line-height:1.5;color:#212529;background-color:#fff;-webkit-text-size-adjust:100%;-webkit-tap-highlight-color:transparent}hr{margin:1rem 0;color:inherit;background-color:currentColor;border:0;opacity:.25}hr:not([size]){height:1px}h1,h2,h3,h4,h5,h6{margin-top:0;margin-bottom:.5rem;font-weight:500;line-height:1.2}h1{font-size:calc(1.375rem + 1.5vw)}@media (min-width:1200px){h1{font-size:2.5rem}}h2{font-size:calc(1.325rem + .9vw)}@media (min-width:1200px){h2{font-size:2rem}}h3{font-size:calc(1.3rem + .6vw)}@media (min-width:1200px){h3{font-size:1.75rem}}h4{font-size:calc(1.275rem + .3vw)}@media (min-width:1200px){h4{font-size:1.5rem}}h5{font-size:1.25rem}h6{font-size:1rem}p{margin-top:0;margin-bottom:1rem}abbr[data-bs-original-title],abbr[title]{-webkit-text-decoration:underline dotted;text-decoration:underline dotted;cursor:help;-webkit-text-decoration-skip-ink:none;text-decoration-skip-ink:none}address{margin-bottom:1rem;font-style:normal;line-height:inherit}ol,ul{padding-left:2rem}dl,ol,ul{margin-top:0;margin-bottom:1rem}ol ol,ol ul,ul ol,ul ul{margin-bottom:0}dt{font-weight:700}dd{margin-bottom:.5rem;margin-left:0}blockquote{margin:0 0 1rem}b,strong{font-weight:bolder}small{font-size:.875em}mark{padding:.2em;background-color:#fcf8e3}sub,sup{position:relative;font-size:.75em;line-height:0;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}a{color:#0d6efd;text-decoration:underline}a:hover{color:#0a58ca}a:not([href]):not([class]),a:not([href]):not([class]):hover{color:inherit;text-decoration:none}code,kbd,pre,samp{font-family:SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:1em;direction:ltr;unicode-bidi:bidi-override}pre{display:block;margin-top:0;margin-bottom:1rem;overflow:auto;font-size:.875em}pre code{font-size:inherit;color:inherit;word-break:normal}code{font-size:.875em;color:#d63384;word-wrap:break-word}a>code{color:inherit}kbd{padding:.2rem .4rem;font-size:.875em;color:#fff;background-color:#212529;border-radius:.2rem}kbd kbd{padding:0;font-size:1em;font-weight:700}figure{margin:0 0 1rem}img,svg{vertical-align:middle}table{caption-side:bottom;border-collapse:collapse}caption{padding-top:.5rem;padding-bottom:.5rem;color:#6c757d;text-align:left}th{text-align:inherit;text-align:-webkit-match-parent}tbody,td,tfoot,th,thead,tr{border-color:inherit;border-style:solid;border-width:0}label{display:inline-block}button{border-radius:0}button:focus:not(:focus-visible){outline:0}button,input,optgroup,select,textarea{margin:0;font-family:inherit;font-size:inherit;line-height:inherit}button,select{text-transform:none}[role=button]{cursor:pointer}select{word-wrap:normal}select:disabled{opacity:1}[list]::-webkit-calendar-picker-indicator{display:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]:not(:disabled),[type=reset]:not(:disabled),[type=submit]:not(:disabled),button:not(:disabled){cursor:pointer}::-moz-focus-inner{padding:0;border-style:none}textarea{resize:vertical}fieldset{min-width:0;padding:0;margin:0;border:0}legend{float:left;width:100%;padding:0;margin-bottom:.5rem;font-size:calc(1.275rem + .3vw);line-height:inherit}@media (min-width:1200px){legend{font-size:1.5rem}}legend+*{clear:left}::-webkit-datetime-edit-day-field,::-webkit-datetime-edit-fields-wrapper,::-webkit-datetime-edit-hour-field,::-webkit-datetime-edit-minute,::-webkit-datetime-edit-month-field,::-webkit-datetime-edit-text,::-webkit-datetime-edit-year-field{padding:0}::-webkit-inner-spin-button{height:auto}[type=search]{outline-offset:-2px;-webkit-appearance:textfield}::-webkit-search-decoration{-webkit-appearance:none}::-webkit-color-swatch-wrapper{padding:0}::file-selector-button{font:inherit}::-webkit-file-upload-button{font:inherit;-webkit-appearance:button}output{display:inline-block}iframe{border:0}summary{display:list-item;cursor:pointer}progress{vertical-align:baseline}[hidden]{display:none!important}</style>
    <style>/*! syntax-highlighting.css */pre{line-height:125%;}span.linenos{color:inherit; background-color:transparent; padding-left:5px; padding-right:20px;}.pdoc-code .hll{background-color:#ffffcc}.pdoc-code{background:#f8f8f8;}.pdoc-code .c{color:#3D7B7B; font-style:italic}.pdoc-code .err{border:1px solid #FF0000}.pdoc-code .k{color:#008000; font-weight:bold}.pdoc-code .o{color:#666666}.pdoc-code .ch{color:#3D7B7B; font-style:italic}.pdoc-code .cm{color:#3D7B7B; font-style:italic}.pdoc-code .cp{color:#9C6500}.pdoc-code .cpf{color:#3D7B7B; font-style:italic}.pdoc-code .c1{color:#3D7B7B; font-style:italic}.pdoc-code .cs{color:#3D7B7B; font-style:italic}.pdoc-code .gd{color:#A00000}.pdoc-code .ge{font-style:italic}.pdoc-code .gr{color:#E40000}.pdoc-code .gh{color:#000080; font-weight:bold}.pdoc-code .gi{color:#008400}.pdoc-code .go{color:#717171}.pdoc-code .gp{color:#000080; font-weight:bold}.pdoc-code .gs{font-weight:bold}.pdoc-code .gu{color:#800080; font-weight:bold}.pdoc-code .gt{color:#0044DD}.pdoc-code .kc{color:#008000; font-weight:bold}.pdoc-code .kd{color:#008000; font-weight:bold}.pdoc-code .kn{color:#008000; font-weight:bold}.pdoc-code .kp{color:#008000}.pdoc-code .kr{color:#008000; font-weight:bold}.pdoc-code .kt{color:#B00040}.pdoc-code .m{color:#666666}.pdoc-code .s{color:#BA2121}.pdoc-code .na{color:#687822}.pdoc-code .nb{color:#008000}.pdoc-code .nc{color:#0000FF; font-weight:bold}.pdoc-code .no{color:#880000}.pdoc-code .nd{color:#AA22FF}.pdoc-code .ni{color:#717171; font-weight:bold}.pdoc-code .ne{color:#CB3F38; font-weight:bold}.pdoc-code .nf{color:#0000FF}.pdoc-code .nl{color:#767600}.pdoc-code .nn{color:#0000FF; font-weight:bold}.pdoc-code .nt{color:#008000; font-weight:bold}.pdoc-code .nv{color:#19177C}.pdoc-code .ow{color:#AA22FF; font-weight:bold}.pdoc-code .w{color:#bbbbbb}.pdoc-code .mb{color:#666666}.pdoc-code .mf{color:#666666}.pdoc-code .mh{color:#666666}.pdoc-code .mi{color:#666666}.pdoc-code .mo{color:#666666}.pdoc-code .sa{color:#BA2121}.pdoc-code .sb{color:#BA2121}.pdoc-code .sc{color:#BA2121}.pdoc-code .dl{color:#BA2121}.pdoc-code .sd{color:#BA2121; font-style:italic}.pdoc-code .s2{color:#BA2121}.pdoc-code .se{color:#AA5D1F; font-weight:bold}.pdoc-code .sh{color:#BA2121}.pdoc-code .si{color:#A45A77; font-weight:bold}.pdoc-code .sx{color:#008000}.pdoc-code .sr{color:#A45A77}.pdoc-code .s1{color:#BA2121}.pdoc-code .ss{color:#19177C}.pdoc-code .bp{color:#008000}.pdoc-code .fm{color:#0000FF}.pdoc-code .vc{color:#19177C}.pdoc-code .vg{color:#19177C}.pdoc-code .vi{color:#19177C}.pdoc-code .vm{color:#19177C}.pdoc-code .il{color:#666666}</style>
    <style>/*! theme.css */:root{--pdoc-background:#fff;}.pdoc{--text:#212529;--muted:#6c757d;--link:#3660a5;--link-hover:#1659c5;--code:#f8f8f8;--active:#fff598;--accent:#eee;--accent2:#c1c1c1;--nav-hover:rgba(255, 255, 255, 0.5);--name:#0066BB;--def:#008800;--annotation:#007020;}</style>
    <style>/*! layout.css */html, body{width:100%;height:100%;}html, main{scroll-behavior:smooth;}body{background-color:var(--pdoc-background);}@media (max-width:769px){#navtoggle{cursor:pointer;position:absolute;width:50px;height:40px;top:1rem;right:1rem;border-color:var(--text);color:var(--text);display:flex;opacity:0.8;z-index:999;}#navtoggle:hover{opacity:1;}#togglestate + div{display:none;}#togglestate:checked + div{display:inherit;}main, header{padding:2rem 3vw;}header + main{margin-top:-3rem;}.git-button{display:none !important;}nav input[type="search"]{max-width:77%;}nav input[type="search"]:first-child{margin-top:-6px;}nav input[type="search"]:valid ~ *{display:none !important;}}@media (min-width:770px){:root{--sidebar-width:clamp(12.5rem, 28vw, 22rem);}nav{position:fixed;overflow:auto;height:100vh;width:var(--sidebar-width);}main, header{padding:3rem 2rem 3rem calc(var(--sidebar-width) + 3rem);width:calc(54rem + var(--sidebar-width));max-width:100%;}header + main{margin-top:-4rem;}#navtoggle{display:none;}}#togglestate{position:absolute;height:0;opacity:0;}nav.pdoc{--pad:clamp(0.5rem, 2vw, 1.75rem);--indent:1.5rem;background-color:var(--accent);border-right:1px solid var(--accent2);box-shadow:0 0 20px rgba(50, 50, 50, .2) inset;padding:0 0 0 var(--pad);overflow-wrap:anywhere;scrollbar-width:thin; scrollbar-color:var(--accent2) transparent; z-index:1}nav.pdoc::-webkit-scrollbar{width:.4rem; }nav.pdoc::-webkit-scrollbar-thumb{background-color:var(--accent2); }nav.pdoc > div{padding:var(--pad) 0;}nav.pdoc .module-list-button{display:inline-flex;align-items:center;color:var(--text);border-color:var(--muted);margin-bottom:1rem;}nav.pdoc .module-list-button:hover{border-color:var(--text);}nav.pdoc input[type=search]{display:block;outline-offset:0;width:calc(100% - var(--pad));}nav.pdoc .logo{max-width:calc(100% - var(--pad));max-height:35vh;display:block;margin:0 auto 1rem;transform:translate(calc(-.5 * var(--pad)), 0);}nav.pdoc ul{list-style:none;padding-left:0;}nav.pdoc > div > ul{margin-left:calc(0px - var(--pad));}nav.pdoc li a{padding:.2rem 0 .2rem calc(var(--pad) + var(--indent));}nav.pdoc > div > ul > li > a{padding-left:var(--pad);}nav.pdoc li{transition:all 100ms;}nav.pdoc li:hover{background-color:var(--nav-hover);}nav.pdoc a, nav.pdoc a:hover{color:var(--text);}nav.pdoc a{display:block;}nav.pdoc > h2:first-of-type{margin-top:1.5rem;}nav.pdoc .class:before{content:"class ";color:var(--muted);}nav.pdoc .function:after{content:"()";color:var(--muted);}nav.pdoc footer:before{content:"";display:block;width:calc(100% - var(--pad));border-top:solid var(--accent2) 1px;margin-top:1.5rem;padding-top:.5rem;}nav.pdoc footer{font-size:small;}</style>
    <style>/*! content.css */.pdoc{color:var(--text);box-sizing:border-box;line-height:1.5;background:none;}.pdoc .pdoc-button{cursor:pointer;display:inline-block;border:solid black 1px;border-radius:2px;font-size:.75rem;padding:calc(0.5em - 1px) 1em;transition:100ms all;}.pdoc .pdoc-alert{padding:1rem 1rem 1rem calc(1.5rem + 24px);border:1px solid transparent;border-radius:.25rem;background-repeat:no-repeat;background-position:1rem center;margin-bottom:1rem;}.pdoc .pdoc-alert > *:last-child{margin-bottom:0;}.pdoc .pdoc-alert-note {color:#084298;background-color:#cfe2ff;border-color:#b6d4fe;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23084298%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8%2016A8%208%200%201%200%208%200a8%208%200%200%200%200%2016zm.93-9.412-1%204.705c-.07.34.029.533.304.533.194%200%20.487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703%200-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381%202.29-.287zM8%205.5a1%201%200%201%201%200-2%201%201%200%200%201%200%202z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-warning{color:#664d03;background-color:#fff3cd;border-color:#ffecb5;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23664d03%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M8.982%201.566a1.13%201.13%200%200%200-1.96%200L.165%2013.233c-.457.778.091%201.767.98%201.767h13.713c.889%200%201.438-.99.98-1.767L8.982%201.566zM8%205c.535%200%20.954.462.9.995l-.35%203.507a.552.552%200%200%201-1.1%200L7.1%205.995A.905.905%200%200%201%208%205zm.002%206a1%201%200%201%201%200%202%201%201%200%200%201%200-2z%22/%3E%3C/svg%3E");}.pdoc .pdoc-alert-danger{color:#842029;background-color:#f8d7da;border-color:#f5c2c7;background-image:url("data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%2224%22%20height%3D%2224%22%20fill%3D%22%23842029%22%20viewBox%3D%220%200%2016%2016%22%3E%3Cpath%20d%3D%22M5.52.359A.5.5%200%200%201%206%200h4a.5.5%200%200%201%20.474.658L8.694%206H12.5a.5.5%200%200%201%20.395.807l-7%209a.5.5%200%200%201-.873-.454L6.823%209.5H3.5a.5.5%200%200%201-.48-.641l2.5-8.5z%22/%3E%3C/svg%3E");}.pdoc .visually-hidden{position:absolute !important;width:1px !important;height:1px !important;padding:0 !important;margin:-1px !important;overflow:hidden !important;clip:rect(0, 0, 0, 0) !important;white-space:nowrap !important;border:0 !important;}.pdoc h1, .pdoc h2, .pdoc h3{font-weight:300;margin:.3em 0;padding:.2em 0;}.pdoc > section:not(.module-info) h1{font-size:1.5rem;font-weight:500;}.pdoc > section:not(.module-info) h2{font-size:1.4rem;font-weight:500;}.pdoc > section:not(.module-info) h3{font-size:1.3rem;font-weight:500;}.pdoc > section:not(.module-info) h4{font-size:1.2rem;}.pdoc > section:not(.module-info) h5{font-size:1.1rem;}.pdoc a{text-decoration:none;color:var(--link);}.pdoc a:hover{color:var(--link-hover);}.pdoc blockquote{margin-left:2rem;}.pdoc pre{border-top:1px solid var(--accent2);border-bottom:1px solid var(--accent2);margin-top:0;margin-bottom:1em;padding:.5rem 0 .5rem .5rem;overflow-x:auto;background-color:var(--code);}.pdoc code{color:var(--text);padding:.2em .4em;margin:0;font-size:85%;background-color:var(--accent);border-radius:6px;}.pdoc a > code{color:inherit;}.pdoc pre > code{display:inline-block;font-size:inherit;background:none;border:none;padding:0;}.pdoc > section:not(.module-info){margin-bottom:1.5rem;}.pdoc .modulename{margin-top:0;font-weight:bold;}.pdoc .modulename a{color:var(--link);transition:100ms all;}.pdoc .git-button{float:right;border:solid var(--link) 1px;}.pdoc .git-button:hover{background-color:var(--link);color:var(--pdoc-background);}.view-source-toggle-state,.view-source-toggle-state ~ .pdoc-code{display:none;}.view-source-toggle-state:checked ~ .pdoc-code{display:block;}.view-source-button{display:inline-block;float:right;font-size:.75rem;line-height:1.5rem;color:var(--muted);padding:0 .4rem 0 1.3rem;cursor:pointer;text-indent:-2px;}.view-source-button > span{visibility:hidden;}.module-info .view-source-button{float:none;display:flex;justify-content:flex-end;margin:-1.2rem .4rem -.2rem 0;}.view-source-button::before{position:absolute;content:"View Source";display:list-item;list-style-type:disclosure-closed;}.view-source-toggle-state:checked ~ .attr .view-source-button::before,.view-source-toggle-state:checked ~ .view-source-button::before{list-style-type:disclosure-open;}.pdoc .docstring{margin-bottom:1.5rem;}.pdoc section:not(.module-info) .docstring{margin-left:clamp(0rem, 5vw - 2rem, 1rem);}.pdoc .docstring .pdoc-code{margin-left:1em;margin-right:1em;}.pdoc h1:target,.pdoc h2:target,.pdoc h3:target,.pdoc h4:target,.pdoc h5:target,.pdoc h6:target,.pdoc .pdoc-code > pre > span:target{background-color:var(--active);box-shadow:-1rem 0 0 0 var(--active);}.pdoc .pdoc-code > pre > span:target{display:block;}.pdoc div:target > .attr,.pdoc section:target > .attr,.pdoc dd:target > a{background-color:var(--active);}.pdoc *{scroll-margin:2rem;}.pdoc .pdoc-code .linenos{user-select:none;}.pdoc .attr:hover{filter:contrast(0.95);}.pdoc section, .pdoc .classattr{position:relative;}.pdoc .headerlink{--width:clamp(1rem, 3vw, 2rem);position:absolute;top:0;left:calc(0rem - var(--width));transition:all 100ms ease-in-out;opacity:0;}.pdoc .headerlink::before{content:"#";display:block;text-align:center;width:var(--width);height:2.3rem;line-height:2.3rem;font-size:1.5rem;}.pdoc .attr:hover ~ .headerlink,.pdoc *:target > .headerlink,.pdoc .headerlink:hover{opacity:1;}.pdoc .attr{display:block;margin:.5rem 0 .5rem;padding:.4rem .4rem .4rem 1rem;background-color:var(--accent);overflow-x:auto;}.pdoc .classattr{margin-left:2rem;}.pdoc .name{color:var(--name);font-weight:bold;}.pdoc .def{color:var(--def);font-weight:bold;}.pdoc .signature{background-color:transparent;}.pdoc .param, .pdoc .return-annotation{white-space:pre;}.pdoc .signature.multiline .param{display:block;}.pdoc .signature.condensed .param{display:inline-block;}.pdoc .annotation{color:var(--annotation);}.pdoc .view-value-toggle-state,.pdoc .view-value-toggle-state ~ .default_value{display:none;}.pdoc .view-value-toggle-state:checked ~ .default_value{display:inherit;}.pdoc .view-value-button{font-size:.5rem;vertical-align:middle;border-style:dashed;margin-top:-0.1rem;}.pdoc .view-value-button:hover{background:white;}.pdoc .view-value-button::before{content:"show";text-align:center;width:2.2em;display:inline-block;}.pdoc .view-value-toggle-state:checked ~ .view-value-button::before{content:"hide";}.pdoc .inherited{margin-left:2rem;}.pdoc .inherited dt{font-weight:700;}.pdoc .inherited dt, .pdoc .inherited dd{display:inline;margin-left:0;margin-bottom:.5rem;}.pdoc .inherited dd:not(:last-child):after{content:", ";}.pdoc .inherited .class:before{content:"class ";}.pdoc .inherited .function a:after{content:"()";}.pdoc .search-result .docstring{overflow:auto;max-height:25vh;}.pdoc .search-result.focused > .attr{background-color:var(--active);}.pdoc .attribution{margin-top:2rem;display:block;opacity:0.5;transition:all 200ms;filter:grayscale(100%);}.pdoc .attribution:hover{opacity:1;filter:grayscale(0%);}.pdoc .attribution img{margin-left:5px;height:35px;vertical-align:middle;width:70px;transition:all 200ms;}.pdoc table{display:block;width:max-content;max-width:100%;overflow:auto;margin-bottom:1rem;}.pdoc table th{font-weight:600;}.pdoc table th, .pdoc table td{padding:6px 13px;border:1px solid var(--accent2);}</style>
    <style>/*! custom.css */</style></head>
<body>
    <nav class="pdoc">
        <label id="navtoggle" for="togglestate" class="pdoc-button"><svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'><path stroke-linecap='round' stroke="currentColor" stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/></svg></label>
        <input id="togglestate" type="checkbox" aria-hidden="true" tabindex="-1">
        <div>




            <h2>API Documentation</h2>
                <ul class="memberlist">
            <li>
                    <a class="function" href="#complexity">complexity</a>
            </li>
            <li>
                    <a class="function" href="#create_attention_masks">create_attention_masks</a>
            </li>
            <li>
                    <a class="class" href="#LearnedTensor">LearnedTensor</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#LearnedTensor.__init__">LearnedTensor</a>
                        </li>
                        <li>
                                <a class="variable" href="#LearnedTensor.tensor">tensor</a>
                        </li>
                        <li>
                                <a class="function" href="#LearnedTensor.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DiscreteFieldEmbedder">DiscreteFieldEmbedder</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DiscreteFieldEmbedder.__init__">DiscreteFieldEmbedder</a>
                        </li>
                        <li>
                                <a class="variable" href="#DiscreteFieldEmbedder.field">field</a>
                        </li>
                        <li>
                                <a class="variable" href="#DiscreteFieldEmbedder.embeddings">embeddings</a>
                        </li>
                        <li>
                                <a class="function" href="#DiscreteFieldEmbedder.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#EntityFieldEmbedder">EntityFieldEmbedder</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EntityFieldEmbedder.__init__">EntityFieldEmbedder</a>
                        </li>
                        <li>
                                <a class="variable" href="#EntityFieldEmbedder.field">field</a>
                        </li>
                        <li>
                                <a class="variable" href="#EntityFieldEmbedder.embeddings">embeddings</a>
                        </li>
                        <li>
                                <a class="function" href="#EntityFieldEmbedder.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ContinuousFieldEmbedder">ContinuousFieldEmbedder</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ContinuousFieldEmbedder.__init__">ContinuousFieldEmbedder</a>
                        </li>
                        <li>
                                <a class="variable" href="#ContinuousFieldEmbedder.field">field</a>
                        </li>
                        <li>
                                <a class="variable" href="#ContinuousFieldEmbedder.linear">linear</a>
                        </li>
                        <li>
                                <a class="variable" href="#ContinuousFieldEmbedder.positional">positional</a>
                        </li>
                        <li>
                                <a class="function" href="#ContinuousFieldEmbedder.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#ModularAttributeEmbeddingSystem">ModularAttributeEmbeddingSystem</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#ModularAttributeEmbeddingSystem.__init__">ModularAttributeEmbeddingSystem</a>
                        </li>
                        <li>
                                <a class="variable" href="#ModularAttributeEmbeddingSystem.embedders">embedders</a>
                        </li>
                        <li>
                                <a class="function" href="#ModularAttributeEmbeddingSystem.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#FieldEncoder">FieldEncoder</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#FieldEncoder.__init__">FieldEncoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#FieldEncoder.H">H</a>
                        </li>
                        <li>
                                <a class="variable" href="#FieldEncoder.encoder">encoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#FieldEncoder.positional">positional</a>
                        </li>
                        <li>
                                <a class="function" href="#FieldEncoder.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#EventEncoder">EventEncoder</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EventEncoder.__init__">EventEncoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventEncoder.H">H</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventEncoder.encoder">encoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventEncoder.positional">positional</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventEncoder.class_token">class_token</a>
                        </li>
                        <li>
                                <a class="function" href="#EventEncoder.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#EventDecoder">EventDecoder</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#EventDecoder.__init__">EventDecoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#EventDecoder.projections">projections</a>
                        </li>
                        <li>
                                <a class="function" href="#EventDecoder.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="class" href="#DecisionHead">DecisionHead</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#DecisionHead.__init__">DecisionHead</a>
                        </li>
                        <li>
                                <a class="variable" href="#DecisionHead.mlp">mlp</a>
                        </li>
                        <li>
                                <a class="function" href="#DecisionHead.forward">forward</a>
                        </li>
                </ul>

            </li>
            <li>
                    <a class="function" href="#create_metrics">create_metrics</a>
            </li>
            <li>
                    <a class="function" href="#step">step</a>
            </li>
            <li>
                    <a class="function" href="#dataloader">dataloader</a>
            </li>
            <li>
                    <a class="class" href="#SequenceModule">SequenceModule</a>
                            <ul class="memberlist">
                        <li>
                                <a class="function" href="#SequenceModule.__init__">SequenceModule</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.datapath">datapath</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.params">params</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.modular_field_embedder">modular_field_embedder</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.field_encoder">field_encoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.event_encoder">event_encoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.event_decoder">event_decoder</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.decision_head">decision_head</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.metrics">metrics</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.digests">digests</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.loaders">loaders</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.pipes">pipes</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.example_input_array">example_input_array</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.forward">forward</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.configure_optimizers">configure_optimizers</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.complexity">complexity</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.training_step">training_step</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.validation_step">validation_step</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.testing_step">testing_step</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.predict_step">predict_step</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.setup">setup</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.teardown">teardown</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.train_dataloader">train_dataloader</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.val_dataloader">val_dataloader</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.test_dataloader">test_dataloader</a>
                        </li>
                        <li>
                                <a class="function" href="#SequenceModule.predict_dataloader">predict_dataloader</a>
                        </li>
                        <li>
                                <a class="variable" href="#SequenceModule.mode">mode</a>
                        </li>
                </ul>

            </li>
    </ul>



        <a class="attribution" title="pdoc: Python API documentation generator" href="https://pdoc.dev" target="_blank">
            built with <span class="visually-hidden">pdoc</span><img
                alt="pdoc logo"
                src="data:image/svg+xml,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20role%3D%22img%22%20aria-label%3D%22pdoc%20logo%22%20width%3D%22300%22%20height%3D%22150%22%20viewBox%3D%22-1%200%2060%2030%22%3E%3Ctitle%3Epdoc%3C/title%3E%3Cpath%20d%3D%22M29.621%2021.293c-.011-.273-.214-.475-.511-.481a.5.5%200%200%200-.489.503l-.044%201.393c-.097.551-.695%201.215-1.566%201.704-.577.428-1.306.486-2.193.182-1.426-.617-2.467-1.654-3.304-2.487l-.173-.172a3.43%203.43%200%200%200-.365-.306.49.49%200%200%200-.286-.196c-1.718-1.06-4.931-1.47-7.353.191l-.219.15c-1.707%201.187-3.413%202.131-4.328%201.03-.02-.027-.49-.685-.141-1.763.233-.721.546-2.408.772-4.076.042-.09.067-.187.046-.288.166-1.347.277-2.625.241-3.351%201.378-1.008%202.271-2.586%202.271-4.362%200-.976-.272-1.935-.788-2.774-.057-.094-.122-.18-.184-.268.033-.167.052-.339.052-.516%200-1.477-1.202-2.679-2.679-2.679-.791%200-1.496.352-1.987.9a6.3%206.3%200%200%200-1.001.029c-.492-.564-1.207-.929-2.012-.929-1.477%200-2.679%201.202-2.679%202.679A2.65%202.65%200%200%200%20.97%206.554c-.383.747-.595%201.572-.595%202.41%200%202.311%201.507%204.29%203.635%205.107-.037.699-.147%202.27-.423%203.294l-.137.461c-.622%202.042-2.515%208.257%201.727%2010.643%201.614.908%203.06%201.248%204.317%201.248%202.665%200%204.492-1.524%205.322-2.401%201.476-1.559%202.886-1.854%206.491.82%201.877%201.393%203.514%201.753%204.861%201.068%202.223-1.713%202.811-3.867%203.399-6.374.077-.846.056-1.469.054-1.537zm-4.835%204.313c-.054.305-.156.586-.242.629-.034-.007-.131-.022-.307-.157-.145-.111-.314-.478-.456-.908.221.121.432.25.675.355.115.039.219.051.33.081zm-2.251-1.238c-.05.33-.158.648-.252.694-.022.001-.125-.018-.307-.157-.217-.166-.488-.906-.639-1.573.358.344.754.693%201.198%201.036zm-3.887-2.337c-.006-.116-.018-.231-.041-.342.635.145%201.189.368%201.599.625.097.231.166.481.174.642-.03.049-.055.101-.067.158-.046.013-.128.026-.298.004-.278-.037-.901-.57-1.367-1.087zm-1.127-.497c.116.306.176.625.12.71-.019.014-.117.045-.345.016-.206-.027-.604-.332-.986-.695.41-.051.816-.056%201.211-.031zm-4.535%201.535c.209.22.379.47.358.598-.006.041-.088.138-.351.234-.144.055-.539-.063-.979-.259a11.66%2011.66%200%200%200%20.972-.573zm.983-.664c.359-.237.738-.418%201.126-.554.25.237.479.548.457.694-.006.042-.087.138-.351.235-.174.064-.694-.105-1.232-.375zm-3.381%201.794c-.022.145-.061.29-.149.401-.133.166-.358.248-.69.251h-.002c-.133%200-.306-.26-.45-.621.417.091.854.07%201.291-.031zm-2.066-8.077a4.78%204.78%200%200%201-.775-.584c.172-.115.505-.254.88-.378l-.105.962zm-.331%202.302a10.32%2010.32%200%200%201-.828-.502c.202-.143.576-.328.984-.49l-.156.992zm-.45%202.157l-.701-.403c.214-.115.536-.249.891-.376a11.57%2011.57%200%200%201-.19.779zm-.181%201.716c.064.398.194.702.298.893-.194-.051-.435-.162-.736-.398.061-.119.224-.3.438-.495zM8.87%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zm-.735-.389a1.15%201.15%200%200%200-.314.783%201.16%201.16%200%200%200%201.162%201.162c.457%200%20.842-.27%201.032-.653.026.117.042.238.042.362a1.68%201.68%200%200%201-1.679%201.679%201.68%201.68%200%200%201-1.679-1.679c0-.843.626-1.535%201.436-1.654zM5.059%205.406A1.68%201.68%200%200%201%203.38%207.085a1.68%201.68%200%200%201-1.679-1.679c0-.037.009-.072.011-.109.21.3.541.508.935.508a1.16%201.16%200%200%200%201.162-1.162%201.14%201.14%200%200%200-.474-.912c.015%200%20.03-.005.045-.005.926.001%201.679.754%201.679%201.68zM3.198%204.141c0%20.152-.123.276-.276.276s-.275-.124-.275-.276.123-.276.276-.276.275.124.275.276zM1.375%208.964c0-.52.103-1.035.288-1.52.466.394%201.06.64%201.717.64%201.144%200%202.116-.725%202.499-1.738.383%201.012%201.355%201.738%202.499%201.738.867%200%201.631-.421%202.121-1.062.307.605.478%201.267.478%201.942%200%202.486-2.153%204.51-4.801%204.51s-4.801-2.023-4.801-4.51zm24.342%2019.349c-.985.498-2.267.168-3.813-.979-3.073-2.281-5.453-3.199-7.813-.705-1.315%201.391-4.163%203.365-8.423.97-3.174-1.786-2.239-6.266-1.261-9.479l.146-.492c.276-1.02.395-2.457.444-3.268a6.11%206.11%200%200%200%201.18.115%206.01%206.01%200%200%200%202.536-.562l-.006.175c-.802.215-1.848.612-2.021%201.25-.079.295.021.601.274.837.219.203.415.364.598.501-.667.304-1.243.698-1.311%201.179-.02.144-.022.507.393.787.213.144.395.26.564.365-1.285.521-1.361.96-1.381%201.126-.018.142-.011.496.427.746l.854.489c-.473.389-.971.914-.999%201.429-.018.278.095.532.316.713.675.556%201.231.721%201.653.721.059%200%20.104-.014.158-.02.207.707.641%201.64%201.513%201.64h.013c.8-.008%201.236-.345%201.462-.626.173-.216.268-.457.325-.692.424.195.93.374%201.372.374.151%200%20.294-.021.423-.068.732-.27.944-.704.993-1.021.009-.061.003-.119.002-.179.266.086.538.147.789.147.15%200%20.294-.021.423-.069.542-.2.797-.489.914-.754.237.147.478.258.704.288.106.014.205.021.296.021.356%200%20.595-.101.767-.229.438.435%201.094.992%201.656%201.067.106.014.205.021.296.021a1.56%201.56%200%200%200%20.323-.035c.17.575.453%201.289.866%201.605.358.273.665.362.914.362a.99.99%200%200%200%20.421-.093%201.03%201.03%200%200%200%20.245-.164c.168.428.39.846.68%201.068.358.273.665.362.913.362a.99.99%200%200%200%20.421-.093c.317-.148.512-.448.639-.762.251.157.495.257.726.257.127%200%20.25-.024.37-.071.427-.17.706-.617.841-1.314.022-.015.047-.022.068-.038.067-.051.133-.104.196-.159-.443%201.486-1.107%202.761-2.086%203.257zM8.66%209.925a.5.5%200%201%200-1%200c0%20.653-.818%201.205-1.787%201.205s-1.787-.552-1.787-1.205a.5.5%200%201%200-1%200c0%201.216%201.25%202.205%202.787%202.205s2.787-.989%202.787-2.205zm4.4%2015.965l-.208.097c-2.661%201.258-4.708%201.436-6.086.527-1.542-1.017-1.88-3.19-1.844-4.198a.4.4%200%200%200-.385-.414c-.242-.029-.406.164-.414.385-.046%201.249.367%203.686%202.202%204.896.708.467%201.547.7%202.51.7%201.248%200%202.706-.392%204.362-1.174l.185-.086a.4.4%200%200%200%20.205-.527c-.089-.204-.326-.291-.527-.206zM9.547%202.292c.093.077.205.114.317.114a.5.5%200%200%200%20.318-.886L8.817.397a.5.5%200%200%200-.703.068.5.5%200%200%200%20.069.703l1.364%201.124zm-7.661-.065c.086%200%20.173-.022.253-.068l1.523-.893a.5.5%200%200%200-.506-.863l-1.523.892a.5.5%200%200%200-.179.685c.094.158.261.247.432.247z%22%20transform%3D%22matrix%28-1%200%200%201%2058%200%29%22%20fill%3D%22%233bb300%22/%3E%3Cpath%20d%3D%22M.3%2021.86V10.18q0-.46.02-.68.04-.22.18-.5.28-.54%201.34-.54%201.06%200%201.42.28.38.26.44.78.76-1.04%202.38-1.04%201.64%200%203.1%201.54%201.46%201.54%201.46%203.58%200%202.04-1.46%203.58-1.44%201.54-3.08%201.54-1.64%200-2.38-.92v4.04q0%20.46-.04.68-.02.22-.18.5-.14.3-.5.42-.36.12-.98.12-.62%200-1-.12-.36-.12-.52-.4-.14-.28-.18-.5-.02-.22-.02-.68zm3.96-9.42q-.46.54-.46%201.18%200%20.64.46%201.18.48.52%201.2.52.74%200%201.24-.52.52-.52.52-1.18%200-.66-.48-1.18-.48-.54-1.26-.54-.76%200-1.22.54zm14.741-8.36q.16-.3.54-.42.38-.12%201-.12.64%200%201.02.12.38.12.52.42.16.3.18.54.04.22.04.68v11.94q0%20.46-.04.7-.02.22-.18.5-.3.54-1.7.54-1.38%200-1.54-.98-.84.96-2.34.96-1.8%200-3.28-1.56-1.48-1.58-1.48-3.66%200-2.1%201.48-3.68%201.5-1.58%203.28-1.58%201.48%200%202.3%201v-4.2q0-.46.02-.68.04-.24.18-.52zm-3.24%2010.86q.52.54%201.26.54.74%200%201.22-.54.5-.54.5-1.18%200-.66-.48-1.22-.46-.56-1.26-.56-.8%200-1.28.56-.48.54-.48%201.2%200%20.66.52%201.2zm7.833-1.2q0-2.4%201.68-3.96%201.68-1.56%203.84-1.56%202.16%200%203.82%201.56%201.66%201.54%201.66%203.94%200%201.66-.86%202.96-.86%201.28-2.1%201.9-1.22.6-2.54.6-1.32%200-2.56-.64-1.24-.66-2.1-1.92-.84-1.28-.84-2.88zm4.18%201.44q.64.48%201.3.48.66%200%201.32-.5.66-.5.66-1.48%200-.98-.62-1.46-.62-.48-1.34-.48-.72%200-1.34.5-.62.5-.62%201.48%200%20.96.64%201.46zm11.412-1.44q0%20.84.56%201.32.56.46%201.18.46.64%200%201.18-.36.56-.38.9-.38.6%200%201.46%201.06.46.58.46%201.04%200%20.76-1.1%201.42-1.14.8-2.8.8-1.86%200-3.58-1.34-.82-.64-1.34-1.7-.52-1.08-.52-2.36%200-1.3.52-2.34.52-1.06%201.34-1.7%201.66-1.32%203.54-1.32.76%200%201.48.22.72.2%201.06.4l.32.2q.36.24.56.38.52.4.52.92%200%20.5-.42%201.14-.72%201.1-1.38%201.1-.38%200-1.08-.44-.36-.34-1.04-.34-.66%200-1.24.48-.58.48-.58%201.34z%22%20fill%3D%22green%22/%3E%3C/svg%3E"/>
        </a>
</div>
    </nav>
    <main class="pdoc">
            <section class="module-info">
                    <h1 class="modulename">
source<wbr>.core<wbr>.architecture    </h1>

                
                        <input id="mod-architecture-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">

                        <label class="view-source-button" for="mod-architecture-view-source"><span>View Source</span></label>

                        <div class="pdoc-code codehilite"><pre><span></span><span id="L-1"><a href="#L-1"><span class="linenos">  1</span></a><span class="kn">import</span> <span class="nn">os</span>
</span><span id="L-2"><a href="#L-2"><span class="linenos">  2</span></a><span class="kn">import</span> <span class="nn">math</span>
</span><span id="L-3"><a href="#L-3"><span class="linenos">  3</span></a><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
</span><span id="L-4"><a href="#L-4"><span class="linenos">  4</span></a><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partialmethod</span><span class="p">,</span> <span class="n">partial</span>
</span><span id="L-5"><a href="#L-5"><span class="linenos">  5</span></a>
</span><span id="L-6"><a href="#L-6"><span class="linenos">  6</span></a><span class="kn">import</span> <span class="nn">torch</span>
</span><span id="L-7"><a href="#L-7"><span class="linenos">  7</span></a><span class="kn">import</span> <span class="nn">torchmetrics</span>
</span><span id="L-8"><a href="#L-8"><span class="linenos">  8</span></a><span class="kn">from</span> <span class="nn">torch.nn.functional</span> <span class="kn">import</span> <span class="n">cross_entropy</span>
</span><span id="L-9"><a href="#L-9"><span class="linenos">  9</span></a><span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">Tensor</span>
</span><span id="L-10"><a href="#L-10"><span class="linenos"> 10</span></a><span class="kn">import</span> <span class="nn">lightning.pytorch</span> <span class="k">as</span> <span class="nn">lit</span>
</span><span id="L-11"><a href="#L-11"><span class="linenos"> 11</span></a><span class="kn">from</span> <span class="nn">tensordict</span> <span class="kn">import</span> <span class="n">TensorDict</span>
</span><span id="L-12"><a href="#L-12"><span class="linenos"> 12</span></a><span class="kn">from</span> <span class="nn">jaxtyping</span> <span class="kn">import</span> <span class="n">Bool</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Int</span><span class="p">,</span> <span class="n">jaxtyped</span>
</span><span id="L-13"><a href="#L-13"><span class="linenos"> 13</span></a><span class="kn">from</span> <span class="nn">beartype</span> <span class="kn">import</span> <span class="n">beartype</span>
</span><span id="L-14"><a href="#L-14"><span class="linenos"> 14</span></a><span class="kn">from</span> <span class="nn">humanize</span> <span class="kn">import</span> <span class="n">naturalsize</span> <span class="k">as</span> <span class="n">bytesize</span>
</span><span id="L-15"><a href="#L-15"><span class="linenos"> 15</span></a><span class="kn">from</span> <span class="nn">torchdata</span> <span class="kn">import</span> <span class="n">datapipes</span>
</span><span id="L-16"><a href="#L-16"><span class="linenos"> 16</span></a><span class="kn">from</span> <span class="nn">torchdata.dataloader2</span> <span class="kn">import</span> <span class="n">DataLoader2</span><span class="p">,</span> <span class="n">MultiProcessingReadingService</span>
</span><span id="L-17"><a href="#L-17"><span class="linenos"> 17</span></a><span class="kn">from</span> <span class="nn">tdigest</span> <span class="kn">import</span> <span class="n">TDigest</span>
</span><span id="L-18"><a href="#L-18"><span class="linenos"> 18</span></a>
</span><span id="L-19"><a href="#L-19"><span class="linenos"> 19</span></a><span class="kn">from</span> <span class="nn">source.core.schema</span> <span class="kn">import</span> <span class="n">Field</span><span class="p">,</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">SPECIAL_TOKENS</span>
</span><span id="L-20"><a href="#L-20"><span class="linenos"> 20</span></a><span class="kn">from</span> <span class="nn">source.core.iterops</span> <span class="kn">import</span> <span class="n">stream</span><span class="p">,</span> <span class="n">mock</span>
</span><span id="L-21"><a href="#L-21"><span class="linenos"> 21</span></a>
</span><span id="L-22"><a href="#L-22"><span class="linenos"> 22</span></a>
</span><span id="L-23"><a href="#L-23"><span class="linenos"> 23</span></a><span class="k">def</span> <span class="nf">complexity</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-24"><a href="#L-24"><span class="linenos"> 24</span></a>
</span><span id="L-25"><a href="#L-25"><span class="linenos"> 25</span></a>    <span class="c1"># as per https://pytorch.org/docs/stable/generated/torch.nn.TransformerEncoderLayer.html</span>
</span><span id="L-26"><a href="#L-26"><span class="linenos"> 26</span></a>    <span class="n">D_FFN</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span id="L-27"><a href="#L-27"><span class="linenos"> 27</span></a>    
</span><span id="L-28"><a href="#L-28"><span class="linenos"> 28</span></a>    <span class="c1"># pretty good assumption you are using FP16 or BF16</span>
</span><span id="L-29"><a href="#L-29"><span class="linenos"> 29</span></a>    <span class="n">FP_PRECISION</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="L-30"><a href="#L-30"><span class="linenos"> 30</span></a>
</span><span id="L-31"><a href="#L-31"><span class="linenos"> 31</span></a>    <span class="k">def</span> <span class="nf">_calculate_bert_memory_complexity</span><span class="p">(</span>
</span><span id="L-32"><a href="#L-32"><span class="linenos"> 32</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-33"><a href="#L-33"><span class="linenos"> 33</span></a>        <span class="n">max_seq_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-34"><a href="#L-34"><span class="linenos"> 34</span></a>        <span class="n">d_hidden</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-35"><a href="#L-35"><span class="linenos"> 35</span></a>        <span class="n">n_heads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-36"><a href="#L-36"><span class="linenos"> 36</span></a>        <span class="n">n_blocks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-37"><a href="#L-37"><span class="linenos"> 37</span></a>        <span class="n">precision</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-38"><a href="#L-38"><span class="linenos"> 38</span></a>        <span class="n">d_ffn</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="L-39"><a href="#L-39"><span class="linenos"> 39</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-40"><a href="#L-40"><span class="linenos"> 40</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;batch_size must be an integer&quot;</span>
</span><span id="L-41"><a href="#L-41"><span class="linenos"> 41</span></a>        <span class="k">assert</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;batch_size must be greater than 0&quot;</span>
</span><span id="L-42"><a href="#L-42"><span class="linenos"> 42</span></a>
</span><span id="L-43"><a href="#L-43"><span class="linenos"> 43</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;max_seq_len must be an integer&quot;</span>
</span><span id="L-44"><a href="#L-44"><span class="linenos"> 44</span></a>        <span class="k">assert</span> <span class="n">max_seq_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max_seq_len must be greater than 0&quot;</span>
</span><span id="L-45"><a href="#L-45"><span class="linenos"> 45</span></a>
</span><span id="L-46"><a href="#L-46"><span class="linenos"> 46</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d_hidden</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;d_hidden must be an integer&quot;</span>
</span><span id="L-47"><a href="#L-47"><span class="linenos"> 47</span></a>        <span class="k">assert</span> <span class="n">d_hidden</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;d_hidden must be greater than 0&quot;</span>
</span><span id="L-48"><a href="#L-48"><span class="linenos"> 48</span></a>
</span><span id="L-49"><a href="#L-49"><span class="linenos"> 49</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_heads</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;n_heads must be an integer&quot;</span>
</span><span id="L-50"><a href="#L-50"><span class="linenos"> 50</span></a>        <span class="k">assert</span> <span class="n">n_heads</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;n_heads must be greater than 0&quot;</span>
</span><span id="L-51"><a href="#L-51"><span class="linenos"> 51</span></a>
</span><span id="L-52"><a href="#L-52"><span class="linenos"> 52</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_blocks</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;n_blocks must be an integer&quot;</span>
</span><span id="L-53"><a href="#L-53"><span class="linenos"> 53</span></a>        <span class="k">assert</span> <span class="n">n_blocks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;n_blocks must be greater than 0&quot;</span>
</span><span id="L-54"><a href="#L-54"><span class="linenos"> 54</span></a>
</span><span id="L-55"><a href="#L-55"><span class="linenos"> 55</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">precision</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;precision must be an integer&quot;</span>
</span><span id="L-56"><a href="#L-56"><span class="linenos"> 56</span></a>        <span class="k">assert</span> <span class="n">precision</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;precision must be greater than 0&quot;</span>
</span><span id="L-57"><a href="#L-57"><span class="linenos"> 57</span></a>
</span><span id="L-58"><a href="#L-58"><span class="linenos"> 58</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d_ffn</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;FFN dim must be an integer&quot;</span>
</span><span id="L-59"><a href="#L-59"><span class="linenos"> 59</span></a>        <span class="k">assert</span> <span class="n">d_ffn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;FFN dim must be greater than 0&quot;</span>
</span><span id="L-60"><a href="#L-60"><span class="linenos"> 60</span></a>
</span><span id="L-61"><a href="#L-61"><span class="linenos"> 61</span></a>        <span class="n">memory</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">max_seq_len</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">d_hidden</span> <span class="o">+</span> <span class="n">d_ffn</span><span class="p">)</span>
</span><span id="L-62"><a href="#L-62"><span class="linenos"> 62</span></a>        <span class="n">memory</span> <span class="o">+=</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">n_heads</span> <span class="o">*</span> <span class="n">max_seq_len</span> <span class="o">*</span> <span class="n">max_seq_len</span>
</span><span id="L-63"><a href="#L-63"><span class="linenos"> 63</span></a>        
</span><span id="L-64"><a href="#L-64"><span class="linenos"> 64</span></a>        <span class="c1"># the &quot;3&quot; comes from forward prop, backward prop, and general model overhead</span>
</span><span id="L-65"><a href="#L-65"><span class="linenos"> 65</span></a>        <span class="n">memory</span> <span class="o">*=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_blocks</span> <span class="o">*</span> <span class="n">precision</span>
</span><span id="L-66"><a href="#L-66"><span class="linenos"> 66</span></a>
</span><span id="L-67"><a href="#L-67"><span class="linenos"> 67</span></a>        <span class="k">return</span> <span class="n">memory</span>
</span><span id="L-68"><a href="#L-68"><span class="linenos"> 68</span></a>
</span><span id="L-69"><a href="#L-69"><span class="linenos"> 69</span></a>    <span class="n">encoder</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
</span><span id="L-70"><a href="#L-70"><span class="linenos"> 70</span></a>        <span class="n">_calculate_bert_memory_complexity</span><span class="p">,</span>
</span><span id="L-71"><a href="#L-71"><span class="linenos"> 71</span></a>        <span class="n">precision</span><span class="o">=</span><span class="n">FP_PRECISION</span><span class="p">,</span>
</span><span id="L-72"><a href="#L-72"><span class="linenos"> 72</span></a>        <span class="n">d_ffn</span><span class="o">=</span><span class="n">D_FFN</span><span class="p">,</span>
</span><span id="L-73"><a href="#L-73"><span class="linenos"> 73</span></a>    <span class="p">)</span>
</span><span id="L-74"><a href="#L-74"><span class="linenos"> 74</span></a>
</span><span id="L-75"><a href="#L-75"><span class="linenos"> 75</span></a>    <span class="n">field</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span>
</span><span id="L-76"><a href="#L-76"><span class="linenos"> 76</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">n_context</span><span class="p">,</span>
</span><span id="L-77"><a href="#L-77"><span class="linenos"> 77</span></a>        <span class="n">max_seq_len</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span><span class="p">,</span>
</span><span id="L-78"><a href="#L-78"><span class="linenos"> 78</span></a>        <span class="n">d_hidden</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="L-79"><a href="#L-79"><span class="linenos"> 79</span></a>        <span class="n">n_blocks</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_field_encoder</span><span class="p">,</span>
</span><span id="L-80"><a href="#L-80"><span class="linenos"> 80</span></a>        <span class="n">n_heads</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_field_encoder</span><span class="p">,</span>
</span><span id="L-81"><a href="#L-81"><span class="linenos"> 81</span></a>    <span class="p">)</span>
</span><span id="L-82"><a href="#L-82"><span class="linenos"> 82</span></a>
</span><span id="L-83"><a href="#L-83"><span class="linenos"> 83</span></a>    <span class="n">event</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span>
</span><span id="L-84"><a href="#L-84"><span class="linenos"> 84</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-85"><a href="#L-85"><span class="linenos"> 85</span></a>        <span class="n">max_seq_len</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_context</span><span class="p">,</span>
</span><span id="L-86"><a href="#L-86"><span class="linenos"> 86</span></a>        <span class="n">d_hidden</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="L-87"><a href="#L-87"><span class="linenos"> 87</span></a>        <span class="n">n_blocks</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_event_encoder</span><span class="p">,</span>
</span><span id="L-88"><a href="#L-88"><span class="linenos"> 88</span></a>        <span class="n">n_heads</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_event_encoder</span><span class="p">,</span>
</span><span id="L-89"><a href="#L-89"><span class="linenos"> 89</span></a>    <span class="p">)</span>
</span><span id="L-90"><a href="#L-90"><span class="linenos"> 90</span></a>
</span><span id="L-91"><a href="#L-91"><span class="linenos"> 91</span></a>    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">field</span> <span class="o">+</span> <span class="n">event</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
</span><span id="L-92"><a href="#L-92"><span class="linenos"> 92</span></a>
</span><span id="L-93"><a href="#L-93"><span class="linenos"> 93</span></a>
</span><span id="L-94"><a href="#L-94"><span class="linenos"> 94</span></a><span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="L-95"><a href="#L-95"><span class="linenos"> 95</span></a><span class="k">def</span> <span class="nf">_squarify</span><span class="p">(</span><span class="n">tensor</span><span class="p">:</span> <span class="n">Tensor</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-96"><a href="#L-96"><span class="linenos"> 96</span></a>    <span class="k">return</span> <span class="o">~</span><span class="p">(</span><span class="n">tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">tensor</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span>
</span><span id="L-97"><a href="#L-97"><span class="linenos"> 97</span></a>
</span><span id="L-98"><a href="#L-98"><span class="linenos"> 98</span></a>
</span><span id="L-99"><a href="#L-99"><span class="linenos"> 99</span></a><span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="L-100"><a href="#L-100"><span class="linenos">100</span></a><span class="k">def</span> <span class="nf">create_attention_masks</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Field</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="L-101"><a href="#L-101"><span class="linenos">101</span></a>    <span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-102"><a href="#L-102"><span class="linenos">102</span></a>
</span><span id="L-103"><a href="#L-103"><span class="linenos">103</span></a>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
</span><span id="L-104"><a href="#L-104"><span class="linenos">104</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;lookup&quot;</span><span class="p">)]</span>
</span><span id="L-105"><a href="#L-105"><span class="linenos">105</span></a>
</span><span id="L-106"><a href="#L-106"><span class="linenos">106</span></a>        <span class="n">is_padded</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">,</span> <span class="s2">&quot;PAD_&quot;</span><span class="p">))</span>
</span><span id="L-107"><a href="#L-107"><span class="linenos">107</span></a>        <span class="n">is_null</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">,</span> <span class="s2">&quot;NAN_&quot;</span><span class="p">))</span>
</span><span id="L-108"><a href="#L-108"><span class="linenos">108</span></a>
</span><span id="L-109"><a href="#L-109"><span class="linenos">109</span></a>        <span class="c1"># FIXME hold up... this won&#39;t work for the discrete tokens (&quot;NULL_&quot;)</span>
</span><span id="L-110"><a href="#L-110"><span class="linenos">110</span></a>
</span><span id="L-111"><a href="#L-111"><span class="linenos">111</span></a>        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_padded</span> <span class="o">|</span> <span class="n">is_null</span><span class="p">)</span>
</span><span id="L-112"><a href="#L-112"><span class="linenos">112</span></a>
</span><span id="L-113"><a href="#L-113"><span class="linenos">113</span></a>    <span class="n">flags</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-114"><a href="#L-114"><span class="linenos">114</span></a>
</span><span id="L-115"><a href="#L-115"><span class="linenos">115</span></a>    <span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-116"><a href="#L-116"><span class="linenos">116</span></a>
</span><span id="L-117"><a href="#L-117"><span class="linenos">117</span></a>    <span class="n">field_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">flags</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="L-118"><a href="#L-118"><span class="linenos">118</span></a>    <span class="n">event_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">flags</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-119"><a href="#L-119"><span class="linenos">119</span></a>
</span><span id="L-120"><a href="#L-120"><span class="linenos">120</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">_squarify</span><span class="p">(</span><span class="n">field_mask</span><span class="p">),</span> <span class="n">_squarify</span><span class="p">(</span><span class="n">event_mask</span><span class="p">))</span>
</span><span id="L-121"><a href="#L-121"><span class="linenos">121</span></a>
</span><span id="L-122"><a href="#L-122"><span class="linenos">122</span></a>
</span><span id="L-123"><a href="#L-123"><span class="linenos">123</span></a><span class="k">class</span> <span class="nc">LearnedTensor</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-124"><a href="#L-124"><span class="linenos">124</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-125"><a href="#L-125"><span class="linenos">125</span></a><span class="sd">    LearnedTensor is a PyTorch module that initializes a tensor with normal distribution and learns its values during training.</span>
</span><span id="L-126"><a href="#L-126"><span class="linenos">126</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-127"><a href="#L-127"><span class="linenos">127</span></a>
</span><span id="L-128"><a href="#L-128"><span class="linenos">128</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="L-129"><a href="#L-129"><span class="linenos">129</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-130"><a href="#L-130"><span class="linenos">130</span></a><span class="sd">        Initializes the LearnedTensor.</span>
</span><span id="L-131"><a href="#L-131"><span class="linenos">131</span></a>
</span><span id="L-132"><a href="#L-132"><span class="linenos">132</span></a><span class="sd">        Args:</span>
</span><span id="L-133"><a href="#L-133"><span class="linenos">133</span></a><span class="sd">            sizes (int): The sizes of the dimensions of the tensor.</span>
</span><span id="L-134"><a href="#L-134"><span class="linenos">134</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-135"><a href="#L-135"><span class="linenos">135</span></a>
</span><span id="L-136"><a href="#L-136"><span class="linenos">136</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-137"><a href="#L-137"><span class="linenos">137</span></a>
</span><span id="L-138"><a href="#L-138"><span class="linenos">138</span></a>        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
</span><span id="L-139"><a href="#L-139"><span class="linenos">139</span></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;each dim must be of type int&quot;</span>
</span><span id="L-140"><a href="#L-140"><span class="linenos">140</span></a>            <span class="k">assert</span> <span class="n">dim</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;each dim must be greater than 0&quot;</span>
</span><span id="L-141"><a href="#L-141"><span class="linenos">141</span></a>
</span><span id="L-142"><a href="#L-142"><span class="linenos">142</span></a>        <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
</span><span id="L-143"><a href="#L-143"><span class="linenos">143</span></a>
</span><span id="L-144"><a href="#L-144"><span class="linenos">144</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
</span><span id="L-145"><a href="#L-145"><span class="linenos">145</span></a>
</span><span id="L-146"><a href="#L-146"><span class="linenos">146</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="L-147"><a href="#L-147"><span class="linenos">147</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]:</span>
</span><span id="L-148"><a href="#L-148"><span class="linenos">148</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-149"><a href="#L-149"><span class="linenos">149</span></a><span class="sd">        Returns the learned tensor.</span>
</span><span id="L-150"><a href="#L-150"><span class="linenos">150</span></a>
</span><span id="L-151"><a href="#L-151"><span class="linenos">151</span></a><span class="sd">        Returns:</span>
</span><span id="L-152"><a href="#L-152"><span class="linenos">152</span></a><span class="sd">            Float[Tensor, &#39;...&#39;]: The learned tensor.</span>
</span><span id="L-153"><a href="#L-153"><span class="linenos">153</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-154"><a href="#L-154"><span class="linenos">154</span></a>
</span><span id="L-155"><a href="#L-155"><span class="linenos">155</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span>
</span><span id="L-156"><a href="#L-156"><span class="linenos">156</span></a>
</span><span id="L-157"><a href="#L-157"><span class="linenos">157</span></a>
</span><span id="L-158"><a href="#L-158"><span class="linenos">158</span></a><span class="k">class</span> <span class="nc">DiscreteFieldEmbedder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-159"><a href="#L-159"><span class="linenos">159</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
</span><span id="L-160"><a href="#L-160"><span class="linenos">160</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-161"><a href="#L-161"><span class="linenos">161</span></a><span class="sd">        Initialize discrete field embedder.</span>
</span><span id="L-162"><a href="#L-162"><span class="linenos">162</span></a>
</span><span id="L-163"><a href="#L-163"><span class="linenos">163</span></a><span class="sd">        Args:</span>
</span><span id="L-164"><a href="#L-164"><span class="linenos">164</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="L-165"><a href="#L-165"><span class="linenos">165</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-166"><a href="#L-166"><span class="linenos">166</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-167"><a href="#L-167"><span class="linenos">167</span></a>
</span><span id="L-168"><a href="#L-168"><span class="linenos">168</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">field</span>
</span><span id="L-169"><a href="#L-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">n_levels</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="L-170"><a href="#L-170"><span class="linenos">170</span></a>
</span><span id="L-171"><a href="#L-171"><span class="linenos">171</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-172"><a href="#L-172"><span class="linenos">172</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;lookup&quot;</span><span class="p">])</span>
</span><span id="L-173"><a href="#L-173"><span class="linenos">173</span></a>
</span><span id="L-174"><a href="#L-174"><span class="linenos">174</span></a>
</span><span id="L-175"><a href="#L-175"><span class="linenos">175</span></a><span class="k">class</span> <span class="nc">EntityFieldEmbedder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-176"><a href="#L-176"><span class="linenos">176</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
</span><span id="L-177"><a href="#L-177"><span class="linenos">177</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-178"><a href="#L-178"><span class="linenos">178</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-179"><a href="#L-179"><span class="linenos">179</span></a><span class="sd">        Initialize entity field embedder.</span>
</span><span id="L-180"><a href="#L-180"><span class="linenos">180</span></a>
</span><span id="L-181"><a href="#L-181"><span class="linenos">181</span></a><span class="sd">        Args:</span>
</span><span id="L-182"><a href="#L-182"><span class="linenos">182</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="L-183"><a href="#L-183"><span class="linenos">183</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-184"><a href="#L-184"><span class="linenos">184</span></a>
</span><span id="L-185"><a href="#L-185"><span class="linenos">185</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">field</span>
</span><span id="L-186"><a href="#L-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_context</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="L-187"><a href="#L-187"><span class="linenos">187</span></a>
</span><span id="L-188"><a href="#L-188"><span class="linenos">188</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="L-189"><a href="#L-189"><span class="linenos">189</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;lookup&quot;</span><span class="p">])</span>
</span><span id="L-190"><a href="#L-190"><span class="linenos">190</span></a>
</span><span id="L-191"><a href="#L-191"><span class="linenos">191</span></a>
</span><span id="L-192"><a href="#L-192"><span class="linenos">192</span></a><span class="k">class</span> <span class="nc">ContinuousFieldEmbedder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-193"><a href="#L-193"><span class="linenos">193</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-194"><a href="#L-194"><span class="linenos">194</span></a><span class="sd">    ContinuousFieldEmbedder is a PyTorch module that encodes features using Fourier features.</span>
</span><span id="L-195"><a href="#L-195"><span class="linenos">195</span></a>
</span><span id="L-196"><a href="#L-196"><span class="linenos">196</span></a><span class="sd">    Attributes:</span>
</span><span id="L-197"><a href="#L-197"><span class="linenos">197</span></a><span class="sd">        linear (torch.nn.Linear): A linear layer for transforming the input.</span>
</span><span id="L-198"><a href="#L-198"><span class="linenos">198</span></a><span class="sd">        positional (torch.nn.Embedding): An embedding layer for positional encoding.</span>
</span><span id="L-199"><a href="#L-199"><span class="linenos">199</span></a><span class="sd">        weights (Tensor): The weights for the Fourier features.</span>
</span><span id="L-200"><a href="#L-200"><span class="linenos">200</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-201"><a href="#L-201"><span class="linenos">201</span></a>
</span><span id="L-202"><a href="#L-202"><span class="linenos">202</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
</span><span id="L-203"><a href="#L-203"><span class="linenos">203</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-204"><a href="#L-204"><span class="linenos">204</span></a><span class="sd">        Initialize continuous field embedder.</span>
</span><span id="L-205"><a href="#L-205"><span class="linenos">205</span></a>
</span><span id="L-206"><a href="#L-206"><span class="linenos">206</span></a><span class="sd">        Args:</span>
</span><span id="L-207"><a href="#L-207"><span class="linenos">207</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="L-208"><a href="#L-208"><span class="linenos">208</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-209"><a href="#L-209"><span class="linenos">209</span></a>
</span><span id="L-210"><a href="#L-210"><span class="linenos">210</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-211"><a href="#L-211"><span class="linenos">211</span></a>
</span><span id="L-212"><a href="#L-212"><span class="linenos">212</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">field</span>
</span><span id="L-213"><a href="#L-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="L-214"><a href="#L-214"><span class="linenos">214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="L-215"><a href="#L-215"><span class="linenos">215</span></a>
</span><span id="L-216"><a href="#L-216"><span class="linenos">216</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="n">params</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-217"><a href="#L-217"><span class="linenos">217</span></a>
</span><span id="L-218"><a href="#L-218"><span class="linenos">218</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;weights&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="L-219"><a href="#L-219"><span class="linenos">219</span></a>
</span><span id="L-220"><a href="#L-220"><span class="linenos">220</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="L-221"><a href="#L-221"><span class="linenos">221</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="L-222"><a href="#L-222"><span class="linenos">222</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-223"><a href="#L-223"><span class="linenos">223</span></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Int</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L&quot;</span><span class="p">]],</span>
</span><span id="L-224"><a href="#L-224"><span class="linenos">224</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L F&quot;</span><span class="p">]:</span>
</span><span id="L-225"><a href="#L-225"><span class="linenos">225</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-226"><a href="#L-226"><span class="linenos">226</span></a><span class="sd">        Performs the forward pass of the FourierFeatureEncoder.</span>
</span><span id="L-227"><a href="#L-227"><span class="linenos">227</span></a>
</span><span id="L-228"><a href="#L-228"><span class="linenos">228</span></a><span class="sd">        Args:</span>
</span><span id="L-229"><a href="#L-229"><span class="linenos">229</span></a><span class="sd">            inputs (Float[Tensor, &quot;N L&quot;]): The input tensor.</span>
</span><span id="L-230"><a href="#L-230"><span class="linenos">230</span></a>
</span><span id="L-231"><a href="#L-231"><span class="linenos">231</span></a><span class="sd">        Returns:</span>
</span><span id="L-232"><a href="#L-232"><span class="linenos">232</span></a><span class="sd">            Float[Tensor, &quot;N L F&quot;]: The Fourier features of the input.</span>
</span><span id="L-233"><a href="#L-233"><span class="linenos">233</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-234"><a href="#L-234"><span class="linenos">234</span></a>
</span><span id="L-235"><a href="#L-235"><span class="linenos">235</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
</span><span id="L-236"><a href="#L-236"><span class="linenos">236</span></a>        <span class="n">indicators</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;lookup&quot;</span><span class="p">]</span>
</span><span id="L-237"><a href="#L-237"><span class="linenos">237</span></a>
</span><span id="L-238"><a href="#L-238"><span class="linenos">238</span></a>        <span class="k">assert</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">indicators</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;values and indicators must always have the same shape&quot;</span>
</span><span id="L-239"><a href="#L-239"><span class="linenos">239</span></a>
</span><span id="L-240"><a href="#L-240"><span class="linenos">240</span></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">indicators</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span> <span class="s2">&quot;values should be imputed if not null, padded, or masked&quot;</span>
</span><span id="L-241"><a href="#L-241"><span class="linenos">241</span></a>
</span><span id="L-242"><a href="#L-242"><span class="linenos">242</span></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)),</span> <span class="s2">&quot;values should be less than or equal to 1.0&quot;</span>
</span><span id="L-243"><a href="#L-243"><span class="linenos">243</span></a>
</span><span id="L-244"><a href="#L-244"><span class="linenos">244</span></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span> <span class="s2">&quot;values should be greater than or equal to 0.0&quot;</span>
</span><span id="L-245"><a href="#L-245"><span class="linenos">245</span></a>
</span><span id="L-246"><a href="#L-246"><span class="linenos">246</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-247"><a href="#L-247"><span class="linenos">247</span></a>
</span><span id="L-248"><a href="#L-248"><span class="linenos">248</span></a>        <span class="c1"># weight inputs with buffers of precision bands</span>
</span><span id="L-249"><a href="#L-249"><span class="linenos">249</span></a>        <span class="n">weighted</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="L-250"><a href="#L-250"><span class="linenos">250</span></a>
</span><span id="L-251"><a href="#L-251"><span class="linenos">251</span></a>        <span class="c1"># apply sine and cosine functions to weighted inputs</span>
</span><span id="L-252"><a href="#L-252"><span class="linenos">252</span></a>        <span class="n">fourier</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">weighted</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">weighted</span><span class="p">)</span>
</span><span id="L-253"><a href="#L-253"><span class="linenos">253</span></a>
</span><span id="L-254"><a href="#L-254"><span class="linenos">254</span></a>        <span class="c1"># project sinusoidal representations with MLP</span>
</span><span id="L-255"><a href="#L-255"><span class="linenos">255</span></a>        <span class="n">projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">fourier</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-256"><a href="#L-256"><span class="linenos">256</span></a>
</span><span id="L-257"><a href="#L-257"><span class="linenos">257</span></a>        <span class="c1"># embed null indicators</span>
</span><span id="L-258"><a href="#L-258"><span class="linenos">258</span></a>        <span class="n">positional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">(</span><span class="n">indicators</span><span class="p">)</span>
</span><span id="L-259"><a href="#L-259"><span class="linenos">259</span></a>
</span><span id="L-260"><a href="#L-260"><span class="linenos">260</span></a>        <span class="k">return</span> <span class="n">projections</span> <span class="o">+</span> <span class="n">positional</span>
</span><span id="L-261"><a href="#L-261"><span class="linenos">261</span></a>
</span><span id="L-262"><a href="#L-262"><span class="linenos">262</span></a>
</span><span id="L-263"><a href="#L-263"><span class="linenos">263</span></a><span class="k">class</span> <span class="nc">ModularAttributeEmbeddingSystem</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-264"><a href="#L-264"><span class="linenos">264</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-265"><a href="#L-265"><span class="linenos">265</span></a><span class="sd">    ModularAttributeEmbeddingSystem is a PyTorch module for embedding fields.</span>
</span><span id="L-266"><a href="#L-266"><span class="linenos">266</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-267"><a href="#L-267"><span class="linenos">267</span></a>
</span><span id="L-268"><a href="#L-268"><span class="linenos">268</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="L-269"><a href="#L-269"><span class="linenos">269</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-270"><a href="#L-270"><span class="linenos">270</span></a><span class="sd">        Initialize moduler field embedder.</span>
</span><span id="L-271"><a href="#L-271"><span class="linenos">271</span></a>
</span><span id="L-272"><a href="#L-272"><span class="linenos">272</span></a><span class="sd">        Args:</span>
</span><span id="L-273"><a href="#L-273"><span class="linenos">273</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="L-274"><a href="#L-274"><span class="linenos">274</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-275"><a href="#L-275"><span class="linenos">275</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-276"><a href="#L-276"><span class="linenos">276</span></a>
</span><span id="L-277"><a href="#L-277"><span class="linenos">277</span></a>        <span class="n">embedders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-278"><a href="#L-278"><span class="linenos">278</span></a>
</span><span id="L-279"><a href="#L-279"><span class="linenos">279</span></a>        <span class="n">encoders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-280"><a href="#L-280"><span class="linenos">280</span></a>            <span class="n">discrete</span><span class="o">=</span><span class="n">DiscreteFieldEmbedder</span><span class="p">,</span>
</span><span id="L-281"><a href="#L-281"><span class="linenos">281</span></a>            <span class="n">continuous</span><span class="o">=</span><span class="n">ContinuousFieldEmbedder</span><span class="p">,</span>
</span><span id="L-282"><a href="#L-282"><span class="linenos">282</span></a>            <span class="n">entity</span><span class="o">=</span><span class="n">EntityFieldEmbedder</span><span class="p">,</span>
</span><span id="L-283"><a href="#L-283"><span class="linenos">283</span></a>        <span class="p">)</span>
</span><span id="L-284"><a href="#L-284"><span class="linenos">284</span></a>
</span><span id="L-285"><a href="#L-285"><span class="linenos">285</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
</span><span id="L-286"><a href="#L-286"><span class="linenos">286</span></a>            <span class="n">embedders</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoders</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">](</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
</span><span id="L-287"><a href="#L-287"><span class="linenos">287</span></a>
</span><span id="L-288"><a href="#L-288"><span class="linenos">288</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">embedders</span><span class="p">)</span>
</span><span id="L-289"><a href="#L-289"><span class="linenos">289</span></a>
</span><span id="L-290"><a href="#L-290"><span class="linenos">290</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="L-291"><a href="#L-291"><span class="linenos">291</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L F C&quot;</span><span class="p">]:</span>
</span><span id="L-292"><a href="#L-292"><span class="linenos">292</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-293"><a href="#L-293"><span class="linenos">293</span></a><span class="sd">        Performs the forward pass of the ModularAttributeEmbeddingSystem.</span>
</span><span id="L-294"><a href="#L-294"><span class="linenos">294</span></a>
</span><span id="L-295"><a href="#L-295"><span class="linenos">295</span></a><span class="sd">        Args:</span>
</span><span id="L-296"><a href="#L-296"><span class="linenos">296</span></a><span class="sd">            inputs (TensorDict[Float[Tensor, &quot;N L&quot;] | Int[Tensor, &quot;N L&quot;]]): The input tensor.</span>
</span><span id="L-297"><a href="#L-297"><span class="linenos">297</span></a>
</span><span id="L-298"><a href="#L-298"><span class="linenos">298</span></a><span class="sd">        Returns:</span>
</span><span id="L-299"><a href="#L-299"><span class="linenos">299</span></a><span class="sd">            Float[Tensor, &quot;N L F&quot;]: The embedded fields.</span>
</span><span id="L-300"><a href="#L-300"><span class="linenos">300</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-301"><a href="#L-301"><span class="linenos">301</span></a>
</span><span id="L-302"><a href="#L-302"><span class="linenos">302</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-303"><a href="#L-303"><span class="linenos">303</span></a>
</span><span id="L-304"><a href="#L-304"><span class="linenos">304</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-305"><a href="#L-305"><span class="linenos">305</span></a>            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-306"><a href="#L-306"><span class="linenos">306</span></a>                <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span><span class="p">[</span><span class="n">field</span><span class="p">](</span><span class="n">inputs</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
</span><span id="L-307"><a href="#L-307"><span class="linenos">307</span></a>                <span class="n">embeddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
</span><span id="L-308"><a href="#L-308"><span class="linenos">308</span></a>
</span><span id="L-309"><a href="#L-309"><span class="linenos">309</span></a>        <span class="c1"># N L C F</span>
</span><span id="L-310"><a href="#L-310"><span class="linenos">310</span></a>        <span class="n">stacked</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-311"><a href="#L-311"><span class="linenos">311</span></a>
</span><span id="L-312"><a href="#L-312"><span class="linenos">312</span></a>        <span class="c1"># N L F C</span>
</span><span id="L-313"><a href="#L-313"><span class="linenos">313</span></a>        <span class="k">return</span> <span class="n">stacked</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span><span id="L-314"><a href="#L-314"><span class="linenos">314</span></a>
</span><span id="L-315"><a href="#L-315"><span class="linenos">315</span></a>
</span><span id="L-316"><a href="#L-316"><span class="linenos">316</span></a><span class="k">class</span> <span class="nc">FieldEncoder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-317"><a href="#L-317"><span class="linenos">317</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-318"><a href="#L-318"><span class="linenos">318</span></a><span class="sd">    FieldEncoder is a PyTorch module for encoding fields.</span>
</span><span id="L-319"><a href="#L-319"><span class="linenos">319</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-320"><a href="#L-320"><span class="linenos">320</span></a>
</span><span id="L-321"><a href="#L-321"><span class="linenos">321</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="L-322"><a href="#L-322"><span class="linenos">322</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-323"><a href="#L-323"><span class="linenos">323</span></a><span class="sd">        Initialize field transformer encoder.</span>
</span><span id="L-324"><a href="#L-324"><span class="linenos">324</span></a>
</span><span id="L-325"><a href="#L-325"><span class="linenos">325</span></a><span class="sd">        Args:</span>
</span><span id="L-326"><a href="#L-326"><span class="linenos">326</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="L-327"><a href="#L-327"><span class="linenos">327</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-328"><a href="#L-328"><span class="linenos">328</span></a>
</span><span id="L-329"><a href="#L-329"><span class="linenos">329</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-330"><a href="#L-330"><span class="linenos">330</span></a>
</span><span id="L-331"><a href="#L-331"><span class="linenos">331</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_heads_field_encoder</span>
</span><span id="L-332"><a href="#L-332"><span class="linenos">332</span></a>
</span><span id="L-333"><a href="#L-333"><span class="linenos">333</span></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="L-334"><a href="#L-334"><span class="linenos">334</span></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="L-335"><a href="#L-335"><span class="linenos">335</span></a>            <span class="n">nhead</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_field_encoder</span><span class="p">,</span>
</span><span id="L-336"><a href="#L-336"><span class="linenos">336</span></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-337"><a href="#L-337"><span class="linenos">337</span></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
</span><span id="L-338"><a href="#L-338"><span class="linenos">338</span></a>        <span class="p">)</span>
</span><span id="L-339"><a href="#L-339"><span class="linenos">339</span></a>
</span><span id="L-340"><a href="#L-340"><span class="linenos">340</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_field_encoder</span><span class="p">)</span>
</span><span id="L-341"><a href="#L-341"><span class="linenos">341</span></a>
</span><span id="L-342"><a href="#L-342"><span class="linenos">342</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">LearnedTensor</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="L-343"><a href="#L-343"><span class="linenos">343</span></a>
</span><span id="L-344"><a href="#L-344"><span class="linenos">344</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="L-345"><a href="#L-345"><span class="linenos">345</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="L-346"><a href="#L-346"><span class="linenos">346</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-347"><a href="#L-347"><span class="linenos">347</span></a>        <span class="n">fields</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L F C&quot;</span><span class="p">],</span>
</span><span id="L-348"><a href="#L-348"><span class="linenos">348</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Bool</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;NL F F&quot;</span><span class="p">],</span>
</span><span id="L-349"><a href="#L-349"><span class="linenos">349</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">]:</span>
</span><span id="L-350"><a href="#L-350"><span class="linenos">350</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-351"><a href="#L-351"><span class="linenos">351</span></a><span class="sd">        Performs the forward pass of the FieldEncoder.</span>
</span><span id="L-352"><a href="#L-352"><span class="linenos">352</span></a>
</span><span id="L-353"><a href="#L-353"><span class="linenos">353</span></a><span class="sd">        Args:</span>
</span><span id="L-354"><a href="#L-354"><span class="linenos">354</span></a><span class="sd">            inputs (Float[Tensor, &quot;N L F C&quot;]): The input tensor.</span>
</span><span id="L-355"><a href="#L-355"><span class="linenos">355</span></a>
</span><span id="L-356"><a href="#L-356"><span class="linenos">356</span></a><span class="sd">        Returns:</span>
</span><span id="L-357"><a href="#L-357"><span class="linenos">357</span></a><span class="sd">            Float[Tensor, &quot;N L F C&quot;]: The encoded fields.</span>
</span><span id="L-358"><a href="#L-358"><span class="linenos">358</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-359"><a href="#L-359"><span class="linenos">359</span></a>
</span><span id="L-360"><a href="#L-360"><span class="linenos">360</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-361"><a href="#L-361"><span class="linenos">361</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
</span><span id="L-362"><a href="#L-362"><span class="linenos">362</span></a>
</span><span id="L-363"><a href="#L-363"><span class="linenos">363</span></a>        <span class="c1"># NL F C</span>
</span><span id="L-364"><a href="#L-364"><span class="linenos">364</span></a>        <span class="n">batched</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span id="L-365"><a href="#L-365"><span class="linenos">365</span></a>
</span><span id="L-366"><a href="#L-366"><span class="linenos">366</span></a>        <span class="c1"># NL F C</span>
</span><span id="L-367"><a href="#L-367"><span class="linenos">367</span></a>        <span class="n">batched</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span id="L-368"><a href="#L-368"><span class="linenos">368</span></a>
</span><span id="L-369"><a href="#L-369"><span class="linenos">369</span></a>        <span class="c1"># NLH F F</span>
</span><span id="L-370"><a href="#L-370"><span class="linenos">370</span></a>        <span class="n">identity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">((</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span> <span class="o">*</span> <span class="n">H</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>
</span><span id="L-371"><a href="#L-371"><span class="linenos">371</span></a>
</span><span id="L-372"><a href="#L-372"><span class="linenos">372</span></a>        <span class="c1"># NLH F F</span>
</span><span id="L-373"><a href="#L-373"><span class="linenos">373</span></a>        <span class="n">masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">identity</span>
</span><span id="L-374"><a href="#L-374"><span class="linenos">374</span></a>
</span><span id="L-375"><a href="#L-375"><span class="linenos">375</span></a>        <span class="c1"># NL F C</span>
</span><span id="L-376"><a href="#L-376"><span class="linenos">376</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">batched</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">masks</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span> <span class="o">*</span> <span class="n">C</span><span class="p">)</span>
</span><span id="L-377"><a href="#L-377"><span class="linenos">377</span></a>
</span><span id="L-378"><a href="#L-378"><span class="linenos">378</span></a>        <span class="c1"># N L FC</span>
</span><span id="L-379"><a href="#L-379"><span class="linenos">379</span></a>        <span class="k">return</span> <span class="n">events</span>
</span><span id="L-380"><a href="#L-380"><span class="linenos">380</span></a>
</span><span id="L-381"><a href="#L-381"><span class="linenos">381</span></a>
</span><span id="L-382"><a href="#L-382"><span class="linenos">382</span></a><span class="k">class</span> <span class="nc">EventEncoder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-383"><a href="#L-383"><span class="linenos">383</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-384"><a href="#L-384"><span class="linenos">384</span></a><span class="sd">    EventEncoder is a PyTorch module for encoding events.</span>
</span><span id="L-385"><a href="#L-385"><span class="linenos">385</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-386"><a href="#L-386"><span class="linenos">386</span></a>
</span><span id="L-387"><a href="#L-387"><span class="linenos">387</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="L-388"><a href="#L-388"><span class="linenos">388</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-389"><a href="#L-389"><span class="linenos">389</span></a><span class="sd">        Initialize the event transformer encoder.</span>
</span><span id="L-390"><a href="#L-390"><span class="linenos">390</span></a>
</span><span id="L-391"><a href="#L-391"><span class="linenos">391</span></a><span class="sd">        Args:</span>
</span><span id="L-392"><a href="#L-392"><span class="linenos">392</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="L-393"><a href="#L-393"><span class="linenos">393</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-394"><a href="#L-394"><span class="linenos">394</span></a>
</span><span id="L-395"><a href="#L-395"><span class="linenos">395</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-396"><a href="#L-396"><span class="linenos">396</span></a>
</span><span id="L-397"><a href="#L-397"><span class="linenos">397</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_heads_event_encoder</span>
</span><span id="L-398"><a href="#L-398"><span class="linenos">398</span></a>
</span><span id="L-399"><a href="#L-399"><span class="linenos">399</span></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="L-400"><a href="#L-400"><span class="linenos">400</span></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="L-401"><a href="#L-401"><span class="linenos">401</span></a>            <span class="n">nhead</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_event_encoder</span><span class="p">,</span>
</span><span id="L-402"><a href="#L-402"><span class="linenos">402</span></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-403"><a href="#L-403"><span class="linenos">403</span></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
</span><span id="L-404"><a href="#L-404"><span class="linenos">404</span></a>        <span class="p">)</span>
</span><span id="L-405"><a href="#L-405"><span class="linenos">405</span></a>
</span><span id="L-406"><a href="#L-406"><span class="linenos">406</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_event_encoder</span><span class="p">)</span>
</span><span id="L-407"><a href="#L-407"><span class="linenos">407</span></a>
</span><span id="L-408"><a href="#L-408"><span class="linenos">408</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">LearnedTensor</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_context</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="L-409"><a href="#L-409"><span class="linenos">409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">class_token</span> <span class="o">=</span> <span class="n">LearnedTensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="L-410"><a href="#L-410"><span class="linenos">410</span></a>
</span><span id="L-411"><a href="#L-411"><span class="linenos">411</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="L-412"><a href="#L-412"><span class="linenos">412</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="L-413"><a href="#L-413"><span class="linenos">413</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-414"><a href="#L-414"><span class="linenos">414</span></a>        <span class="n">events</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">],</span>
</span><span id="L-415"><a href="#L-415"><span class="linenos">415</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Bool</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L L&quot;</span><span class="p">],</span>
</span><span id="L-416"><a href="#L-416"><span class="linenos">416</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
</span><span id="L-417"><a href="#L-417"><span class="linenos">417</span></a>        <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N FC&quot;</span><span class="p">],</span>
</span><span id="L-418"><a href="#L-418"><span class="linenos">418</span></a>        <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">],</span>
</span><span id="L-419"><a href="#L-419"><span class="linenos">419</span></a>    <span class="p">]:</span>
</span><span id="L-420"><a href="#L-420"><span class="linenos">420</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">FC</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">shape</span>
</span><span id="L-421"><a href="#L-421"><span class="linenos">421</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
</span><span id="L-422"><a href="#L-422"><span class="linenos">422</span></a>
</span><span id="L-423"><a href="#L-423"><span class="linenos">423</span></a>        <span class="c1"># N L FC</span>
</span><span id="L-424"><a href="#L-424"><span class="linenos">424</span></a>        <span class="n">events</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">FC</span><span class="p">)</span>
</span><span id="L-425"><a href="#L-425"><span class="linenos">425</span></a>
</span><span id="L-426"><a href="#L-426"><span class="linenos">426</span></a>        <span class="c1"># N 1 FC</span>
</span><span id="L-427"><a href="#L-427"><span class="linenos">427</span></a>        <span class="n">class_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_token</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FC</span><span class="p">)</span>
</span><span id="L-428"><a href="#L-428"><span class="linenos">428</span></a>
</span><span id="L-429"><a href="#L-429"><span class="linenos">429</span></a>        <span class="c1"># N L+1 FC</span>
</span><span id="L-430"><a href="#L-430"><span class="linenos">430</span></a>        <span class="n">concatenated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">class_token</span><span class="p">,</span> <span class="n">events</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-431"><a href="#L-431"><span class="linenos">431</span></a>
</span><span id="L-432"><a href="#L-432"><span class="linenos">432</span></a>        <span class="c1"># NH L+1 L+1</span>
</span><span id="L-433"><a href="#L-433"><span class="linenos">433</span></a>        <span class="n">masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="L-434"><a href="#L-434"><span class="linenos">434</span></a>
</span><span id="L-435"><a href="#L-435"><span class="linenos">435</span></a>        <span class="c1"># N L+1 FC</span>
</span><span id="L-436"><a href="#L-436"><span class="linenos">436</span></a>        <span class="n">encoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">concatenated</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">masks</span><span class="p">)</span>
</span><span id="L-437"><a href="#L-437"><span class="linenos">437</span></a>
</span><span id="L-438"><a href="#L-438"><span class="linenos">438</span></a>        <span class="c1"># (N 1 FC), (N L FC)</span>
</span><span id="L-439"><a href="#L-439"><span class="linenos">439</span></a>        <span class="n">sequence</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="n">encoded</span><span class="o">.</span><span class="n">split</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-440"><a href="#L-440"><span class="linenos">440</span></a>
</span><span id="L-441"><a href="#L-441"><span class="linenos">441</span></a>        <span class="k">return</span> <span class="n">sequence</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">events</span>
</span><span id="L-442"><a href="#L-442"><span class="linenos">442</span></a>
</span><span id="L-443"><a href="#L-443"><span class="linenos">443</span></a>
</span><span id="L-444"><a href="#L-444"><span class="linenos">444</span></a><span class="k">class</span> <span class="nc">EventDecoder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-445"><a href="#L-445"><span class="linenos">445</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-446"><a href="#L-446"><span class="linenos">446</span></a><span class="sd">    EventDecoder is a PyTorch module for decoding masked events from their contextualized representations.</span>
</span><span id="L-447"><a href="#L-447"><span class="linenos">447</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-448"><a href="#L-448"><span class="linenos">448</span></a>
</span><span id="L-449"><a href="#L-449"><span class="linenos">449</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="L-450"><a href="#L-450"><span class="linenos">450</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-451"><a href="#L-451"><span class="linenos">451</span></a><span class="sd">        Initialize the event decoder.</span>
</span><span id="L-452"><a href="#L-452"><span class="linenos">452</span></a>
</span><span id="L-453"><a href="#L-453"><span class="linenos">453</span></a><span class="sd">        Args:</span>
</span><span id="L-454"><a href="#L-454"><span class="linenos">454</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="L-455"><a href="#L-455"><span class="linenos">455</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-456"><a href="#L-456"><span class="linenos">456</span></a>
</span><span id="L-457"><a href="#L-457"><span class="linenos">457</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-458"><a href="#L-458"><span class="linenos">458</span></a>
</span><span id="L-459"><a href="#L-459"><span class="linenos">459</span></a>        <span class="n">projections</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-460"><a href="#L-460"><span class="linenos">460</span></a>
</span><span id="L-461"><a href="#L-461"><span class="linenos">461</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
</span><span id="L-462"><a href="#L-462"><span class="linenos">462</span></a>            <span class="k">match</span> <span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
</span><span id="L-463"><a href="#L-463"><span class="linenos">463</span></a>                <span class="k">case</span> <span class="s2">&quot;discrete&quot;</span><span class="p">:</span>
</span><span id="L-464"><a href="#L-464"><span class="linenos">464</span></a>                    <span class="n">d_target</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">n_levels</span>
</span><span id="L-465"><a href="#L-465"><span class="linenos">465</span></a>
</span><span id="L-466"><a href="#L-466"><span class="linenos">466</span></a>                <span class="k">case</span> <span class="s2">&quot;entity&quot;</span><span class="p">:</span>
</span><span id="L-467"><a href="#L-467"><span class="linenos">467</span></a>                    <span class="n">d_target</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_context</span>
</span><span id="L-468"><a href="#L-468"><span class="linenos">468</span></a>
</span><span id="L-469"><a href="#L-469"><span class="linenos">469</span></a>                <span class="k">case</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="L-470"><a href="#L-470"><span class="linenos">470</span></a>                    <span class="n">d_target</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_quantiles</span>
</span><span id="L-471"><a href="#L-471"><span class="linenos">471</span></a>
</span><span id="L-472"><a href="#L-472"><span class="linenos">472</span></a>            <span class="n">projections</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span>
</span><span id="L-473"><a href="#L-473"><span class="linenos">473</span></a>                <span class="n">in_channels</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="L-474"><a href="#L-474"><span class="linenos">474</span></a>                <span class="n">out_channels</span><span class="o">=</span><span class="n">d_target</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span>
</span><span id="L-475"><a href="#L-475"><span class="linenos">475</span></a>                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="L-476"><a href="#L-476"><span class="linenos">476</span></a>            <span class="p">)</span>
</span><span id="L-477"><a href="#L-477"><span class="linenos">477</span></a>
</span><span id="L-478"><a href="#L-478"><span class="linenos">478</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">projections</span><span class="p">)</span>
</span><span id="L-479"><a href="#L-479"><span class="linenos">479</span></a>
</span><span id="L-480"><a href="#L-480"><span class="linenos">480</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="L-481"><a href="#L-481"><span class="linenos">481</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="L-482"><a href="#L-482"><span class="linenos">482</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-483"><a href="#L-483"><span class="linenos">483</span></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">],</span>
</span><span id="L-484"><a href="#L-484"><span class="linenos">484</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDict</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L ?&quot;</span><span class="p">]]:</span>
</span><span id="L-485"><a href="#L-485"><span class="linenos">485</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-486"><a href="#L-486"><span class="linenos">486</span></a><span class="sd">        Performs the forward pass of the EventDecoder.</span>
</span><span id="L-487"><a href="#L-487"><span class="linenos">487</span></a>
</span><span id="L-488"><a href="#L-488"><span class="linenos">488</span></a><span class="sd">        Args:</span>
</span><span id="L-489"><a href="#L-489"><span class="linenos">489</span></a><span class="sd">            inputs (Float[Tensor, &quot;N L FC&quot;]): The input tensor.</span>
</span><span id="L-490"><a href="#L-490"><span class="linenos">490</span></a>
</span><span id="L-491"><a href="#L-491"><span class="linenos">491</span></a><span class="sd">        Returns:</span>
</span><span id="L-492"><a href="#L-492"><span class="linenos">492</span></a><span class="sd">            TensorDict[Float[Tensor, &quot;N L ?&quot;]]: A dictionary of output tensors for each field.</span>
</span><span id="L-493"><a href="#L-493"><span class="linenos">493</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-494"><a href="#L-494"><span class="linenos">494</span></a>
</span><span id="L-495"><a href="#L-495"><span class="linenos">495</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="L-496"><a href="#L-496"><span class="linenos">496</span></a>
</span><span id="L-497"><a href="#L-497"><span class="linenos">497</span></a>        <span class="c1"># N, FC, L</span>
</span><span id="L-498"><a href="#L-498"><span class="linenos">498</span></a>        <span class="n">permuted</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="L-499"><a href="#L-499"><span class="linenos">499</span></a>
</span><span id="L-500"><a href="#L-500"><span class="linenos">500</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-501"><a href="#L-501"><span class="linenos">501</span></a>
</span><span id="L-502"><a href="#L-502"><span class="linenos">502</span></a>        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">projection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-503"><a href="#L-503"><span class="linenos">503</span></a>            <span class="n">projected</span> <span class="o">=</span> <span class="n">projection</span><span class="p">(</span><span class="n">permuted</span><span class="p">)</span>
</span><span id="L-504"><a href="#L-504"><span class="linenos">504</span></a>            <span class="n">events</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">projected</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="L-505"><a href="#L-505"><span class="linenos">505</span></a>
</span><span id="L-506"><a href="#L-506"><span class="linenos">506</span></a>        <span class="c1"># N L ?</span>
</span><span id="L-507"><a href="#L-507"><span class="linenos">507</span></a>        <span class="k">return</span> <span class="n">TensorDict</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</span><span id="L-508"><a href="#L-508"><span class="linenos">508</span></a>
</span><span id="L-509"><a href="#L-509"><span class="linenos">509</span></a>
</span><span id="L-510"><a href="#L-510"><span class="linenos">510</span></a><span class="k">class</span> <span class="nc">DecisionHead</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="L-511"><a href="#L-511"><span class="linenos">511</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-512"><a href="#L-512"><span class="linenos">512</span></a><span class="sd">    A PyTorch module representing a classification head. This module is used to map the encoded fields to the target classes.</span>
</span><span id="L-513"><a href="#L-513"><span class="linenos">513</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="L-514"><a href="#L-514"><span class="linenos">514</span></a>
</span><span id="L-515"><a href="#L-515"><span class="linenos">515</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="L-516"><a href="#L-516"><span class="linenos">516</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-517"><a href="#L-517"><span class="linenos">517</span></a><span class="sd">        Initialize classification decision head.</span>
</span><span id="L-518"><a href="#L-518"><span class="linenos">518</span></a>
</span><span id="L-519"><a href="#L-519"><span class="linenos">519</span></a><span class="sd">        Args:</span>
</span><span id="L-520"><a href="#L-520"><span class="linenos">520</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="L-521"><a href="#L-521"><span class="linenos">521</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-522"><a href="#L-522"><span class="linenos">522</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-523"><a href="#L-523"><span class="linenos">523</span></a>
</span><span id="L-524"><a href="#L-524"><span class="linenos">524</span></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="L-525"><a href="#L-525"><span class="linenos">525</span></a>            <span class="nb">map</span><span class="p">(</span>
</span><span id="L-526"><a href="#L-526"><span class="linenos">526</span></a>                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">head_shape_log_base</span><span class="o">**</span><span class="n">x</span><span class="p">,</span>
</span><span id="L-527"><a href="#L-527"><span class="linenos">527</span></a>                <span class="nb">range</span><span class="p">(</span>
</span><span id="L-528"><a href="#L-528"><span class="linenos">528</span></a>                    <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_targets</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">head_shape_log_base</span><span class="p">)),</span>
</span><span id="L-529"><a href="#L-529"><span class="linenos">529</span></a>                    <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">head_shape_log_base</span><span class="p">)),</span>
</span><span id="L-530"><a href="#L-530"><span class="linenos">530</span></a>                <span class="p">),</span>
</span><span id="L-531"><a href="#L-531"><span class="linenos">531</span></a>            <span class="p">)</span>
</span><span id="L-532"><a href="#L-532"><span class="linenos">532</span></a>        <span class="p">)</span>
</span><span id="L-533"><a href="#L-533"><span class="linenos">533</span></a>
</span><span id="L-534"><a href="#L-534"><span class="linenos">534</span></a>        <span class="n">hidden</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="L-535"><a href="#L-535"><span class="linenos">535</span></a>
</span><span id="L-536"><a href="#L-536"><span class="linenos">536</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span> <span class="o">*</span><span class="n">hidden</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">n_targets</span><span class="p">]</span>
</span><span id="L-537"><a href="#L-537"><span class="linenos">537</span></a>
</span><span id="L-538"><a href="#L-538"><span class="linenos">538</span></a>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-539"><a href="#L-539"><span class="linenos">539</span></a>
</span><span id="L-540"><a href="#L-540"><span class="linenos">540</span></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">sizes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
</span><span id="L-541"><a href="#L-541"><span class="linenos">541</span></a>            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="L-542"><a href="#L-542"><span class="linenos">542</span></a>                <span class="n">activation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="L-543"><a href="#L-543"><span class="linenos">543</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="L-544"><a href="#L-544"><span class="linenos">544</span></a>                <span class="n">activation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
</span><span id="L-545"><a href="#L-545"><span class="linenos">545</span></a>
</span><span id="L-546"><a href="#L-546"><span class="linenos">546</span></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="L-547"><a href="#L-547"><span class="linenos">547</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="L-548"><a href="#L-548"><span class="linenos">548</span></a>                    <span class="n">OrderedDict</span><span class="p">(</span>
</span><span id="L-549"><a href="#L-549"><span class="linenos">549</span></a>                        <span class="p">[</span>
</span><span id="L-550"><a href="#L-550"><span class="linenos">550</span></a>                            <span class="p">(</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="o">*</span><span class="n">sizes</span><span class="p">)),</span>
</span><span id="L-551"><a href="#L-551"><span class="linenos">551</span></a>                            <span class="p">(</span><span class="s2">&quot;act&quot;</span><span class="p">,</span> <span class="n">activation</span><span class="p">),</span>
</span><span id="L-552"><a href="#L-552"><span class="linenos">552</span></a>                        <span class="p">]</span>
</span><span id="L-553"><a href="#L-553"><span class="linenos">553</span></a>                    <span class="p">)</span>
</span><span id="L-554"><a href="#L-554"><span class="linenos">554</span></a>                <span class="p">)</span>
</span><span id="L-555"><a href="#L-555"><span class="linenos">555</span></a>            <span class="p">)</span>
</span><span id="L-556"><a href="#L-556"><span class="linenos">556</span></a>
</span><span id="L-557"><a href="#L-557"><span class="linenos">557</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
</span><span id="L-558"><a href="#L-558"><span class="linenos">558</span></a>
</span><span id="L-559"><a href="#L-559"><span class="linenos">559</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N FC&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N T&quot;</span><span class="p">]:</span>
</span><span id="L-560"><a href="#L-560"><span class="linenos">560</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-561"><a href="#L-561"><span class="linenos">561</span></a><span class="sd">        Defines the forward pass of the ClassificationHead.</span>
</span><span id="L-562"><a href="#L-562"><span class="linenos">562</span></a>
</span><span id="L-563"><a href="#L-563"><span class="linenos">563</span></a><span class="sd">        Args:</span>
</span><span id="L-564"><a href="#L-564"><span class="linenos">564</span></a><span class="sd">            inputs (torch.Tensor): The input tensor.</span>
</span><span id="L-565"><a href="#L-565"><span class="linenos">565</span></a>
</span><span id="L-566"><a href="#L-566"><span class="linenos">566</span></a><span class="sd">        Returns:</span>
</span><span id="L-567"><a href="#L-567"><span class="linenos">567</span></a><span class="sd">            torch.Tensor: The output of the MLP.</span>
</span><span id="L-568"><a href="#L-568"><span class="linenos">568</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-569"><a href="#L-569"><span class="linenos">569</span></a>
</span><span id="L-570"><a href="#L-570"><span class="linenos">570</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="L-571"><a href="#L-571"><span class="linenos">571</span></a>
</span><span id="L-572"><a href="#L-572"><span class="linenos">572</span></a>
</span><span id="L-573"><a href="#L-573"><span class="linenos">573</span></a><span class="k">def</span> <span class="nf">create_metrics</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">:</span>
</span><span id="L-574"><a href="#L-574"><span class="linenos">574</span></a>    <span class="n">metrics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-575"><a href="#L-575"><span class="linenos">575</span></a>        <span class="n">ap</span><span class="o">=</span><span class="n">torchmetrics</span><span class="o">.</span><span class="n">AveragePrecision</span><span class="p">,</span>
</span><span id="L-576"><a href="#L-576"><span class="linenos">576</span></a>        <span class="n">f1</span><span class="o">=</span><span class="n">torchmetrics</span><span class="o">.</span><span class="n">F1Score</span><span class="p">,</span>
</span><span id="L-577"><a href="#L-577"><span class="linenos">577</span></a>        <span class="n">auc</span><span class="o">=</span><span class="n">torchmetrics</span><span class="o">.</span><span class="n">AUROC</span><span class="p">,</span>
</span><span id="L-578"><a href="#L-578"><span class="linenos">578</span></a>        <span class="n">acc</span><span class="o">=</span><span class="n">torchmetrics</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">,</span>
</span><span id="L-579"><a href="#L-579"><span class="linenos">579</span></a>    <span class="p">)</span>
</span><span id="L-580"><a href="#L-580"><span class="linenos">580</span></a>
</span><span id="L-581"><a href="#L-581"><span class="linenos">581</span></a>    <span class="n">stratas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span>
</span><span id="L-582"><a href="#L-582"><span class="linenos">582</span></a>        <span class="p">{</span>
</span><span id="L-583"><a href="#L-583"><span class="linenos">583</span></a>            <span class="s2">&quot;train_metrics&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(),</span>
</span><span id="L-584"><a href="#L-584"><span class="linenos">584</span></a>            <span class="s2">&quot;valid_metrics&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(),</span>
</span><span id="L-585"><a href="#L-585"><span class="linenos">585</span></a>            <span class="s2">&quot;test_metrics&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(),</span>
</span><span id="L-586"><a href="#L-586"><span class="linenos">586</span></a>        <span class="p">}</span>
</span><span id="L-587"><a href="#L-587"><span class="linenos">587</span></a>    <span class="p">)</span>
</span><span id="L-588"><a href="#L-588"><span class="linenos">588</span></a>
</span><span id="L-589"><a href="#L-589"><span class="linenos">589</span></a>    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s2">&quot;multiclass&quot;</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_targets</span><span class="p">)</span>
</span><span id="L-590"><a href="#L-590"><span class="linenos">590</span></a>
</span><span id="L-591"><a href="#L-591"><span class="linenos">591</span></a>    <span class="k">for</span> <span class="n">strata</span> <span class="ow">in</span> <span class="n">stratas</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="L-592"><a href="#L-592"><span class="linenos">592</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">Metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-593"><a href="#L-593"><span class="linenos">593</span></a>            <span class="n">stratas</span><span class="p">[</span><span class="n">strata</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metric</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
</span><span id="L-594"><a href="#L-594"><span class="linenos">594</span></a>
</span><span id="L-595"><a href="#L-595"><span class="linenos">595</span></a>    <span class="k">return</span> <span class="n">stratas</span>
</span><span id="L-596"><a href="#L-596"><span class="linenos">596</span></a>
</span><span id="L-597"><a href="#L-597"><span class="linenos">597</span></a>
</span><span id="L-598"><a href="#L-598"><span class="linenos">598</span></a><span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
</span><span id="L-599"><a href="#L-599"><span class="linenos">599</span></a>    <span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;SequenceModule&quot;</span><span class="p">,</span>
</span><span id="L-600"><a href="#L-600"><span class="linenos">600</span></a>    <span class="n">batch</span><span class="p">:</span> <span class="n">TensorDict</span><span class="o">|</span><span class="nb">tuple</span><span class="p">[</span><span class="n">TensorDict</span><span class="p">,</span> <span class="n">TensorDict</span><span class="p">],</span>
</span><span id="L-601"><a href="#L-601"><span class="linenos">601</span></a>    <span class="n">strata</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="L-602"><a href="#L-602"><span class="linenos">602</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="n">TensorDict</span><span class="p">:</span>
</span><span id="L-603"><a href="#L-603"><span class="linenos">603</span></a>    <span class="k">assert</span> <span class="n">strata</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="L-604"><a href="#L-604"><span class="linenos">604</span></a>    
</span><span id="L-605"><a href="#L-605"><span class="linenos">605</span></a>    <span class="n">log</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
</span><span id="L-606"><a href="#L-606"><span class="linenos">606</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
</span><span id="L-607"><a href="#L-607"><span class="linenos">607</span></a>        <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="L-608"><a href="#L-608"><span class="linenos">608</span></a>        <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="L-609"><a href="#L-609"><span class="linenos">609</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="L-610"><a href="#L-610"><span class="linenos">610</span></a>    <span class="p">)</span>
</span><span id="L-611"><a href="#L-611"><span class="linenos">611</span></a>
</span><span id="L-612"><a href="#L-612"><span class="linenos">612</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;pretrain&quot;</span><span class="p">:</span>
</span><span id="L-613"><a href="#L-613"><span class="linenos">613</span></a>        <span class="n">masked</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="L-614"><a href="#L-614"><span class="linenos">614</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">reconstruction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">masked</span><span class="p">)</span>
</span><span id="L-615"><a href="#L-615"><span class="linenos">615</span></a>
</span><span id="L-616"><a href="#L-616"><span class="linenos">616</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">strata</span> <span class="o">==</span> <span class="s1">&#39;predict&#39;</span><span class="p">):</span>
</span><span id="L-617"><a href="#L-617"><span class="linenos">617</span></a>            <span class="k">return</span> <span class="n">reconstruction</span>
</span><span id="L-618"><a href="#L-618"><span class="linenos">618</span></a>
</span><span id="L-619"><a href="#L-619"><span class="linenos">619</span></a>        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-620"><a href="#L-620"><span class="linenos">620</span></a>
</span><span id="L-621"><a href="#L-621"><span class="linenos">621</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
</span><span id="L-622"><a href="#L-622"><span class="linenos">622</span></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">targets</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</span><span id="L-623"><a href="#L-623"><span class="linenos">623</span></a>            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="L-624"><a href="#L-624"><span class="linenos">624</span></a>            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
</span><span id="L-625"><a href="#L-625"><span class="linenos">625</span></a>
</span><span id="L-626"><a href="#L-626"><span class="linenos">626</span></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="L-627"><a href="#L-627"><span class="linenos">627</span></a>        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">/loss&#39;</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">)</span>
</span><span id="L-628"><a href="#L-628"><span class="linenos">628</span></a>        <span class="k">return</span> <span class="n">total_loss</span>
</span><span id="L-629"><a href="#L-629"><span class="linenos">629</span></a>
</span><span id="L-630"><a href="#L-630"><span class="linenos">630</span></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;finetune&quot;</span><span class="p">:</span>
</span><span id="L-631"><a href="#L-631"><span class="linenos">631</span></a>        <span class="n">representations</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="L-632"><a href="#L-632"><span class="linenos">632</span></a>
</span><span id="L-633"><a href="#L-633"><span class="linenos">633</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">strata</span> <span class="o">==</span> <span class="s1">&#39;predict&#39;</span><span class="p">):</span>
</span><span id="L-634"><a href="#L-634"><span class="linenos">634</span></a>            <span class="k">return</span> <span class="n">representations</span>
</span><span id="L-635"><a href="#L-635"><span class="linenos">635</span></a>        
</span><span id="L-636"><a href="#L-636"><span class="linenos">636</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
</span><span id="L-637"><a href="#L-637"><span class="linenos">637</span></a>
</span><span id="L-638"><a href="#L-638"><span class="linenos">638</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">representations</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</span><span id="L-639"><a href="#L-639"><span class="linenos">639</span></a>        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">/loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
</span><span id="L-640"><a href="#L-640"><span class="linenos">640</span></a>        
</span><span id="L-641"><a href="#L-641"><span class="linenos">641</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">representations</span><span class="p">)</span>
</span><span id="L-642"><a href="#L-642"><span class="linenos">642</span></a>        
</span><span id="L-643"><a href="#L-643"><span class="linenos">643</span></a>        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">_metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="L-644"><a href="#L-644"><span class="linenos">644</span></a>            <span class="n">metric</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</span><span id="L-645"><a href="#L-645"><span class="linenos">645</span></a>            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
</span><span id="L-646"><a href="#L-646"><span class="linenos">646</span></a>        
</span><span id="L-647"><a href="#L-647"><span class="linenos">647</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span><span id="L-648"><a href="#L-648"><span class="linenos">648</span></a>        
</span><span id="L-649"><a href="#L-649"><span class="linenos">649</span></a>
</span><span id="L-650"><a href="#L-650"><span class="linenos">650</span></a>
</span><span id="L-651"><a href="#L-651"><span class="linenos">651</span></a><span class="k">def</span> <span class="nf">dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;SequenceModule&quot;</span><span class="p">,</span> <span class="n">strata</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader2</span><span class="p">:</span>
</span><span id="L-652"><a href="#L-652"><span class="linenos">652</span></a>    <span class="k">assert</span> <span class="n">strata</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="L-653"><a href="#L-653"><span class="linenos">653</span></a>
</span><span id="L-654"><a href="#L-654"><span class="linenos">654</span></a>    <span class="n">pipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">[</span><span class="n">strata</span><span class="p">]</span>
</span><span id="L-655"><a href="#L-655"><span class="linenos">655</span></a>    <span class="c1"># rs = MultiProcessingReadingService(num_workers=2)</span>
</span><span id="L-656"><a href="#L-656"><span class="linenos">656</span></a>    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader2</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="c1">#, reading_service=rs)</span>
</span><span id="L-657"><a href="#L-657"><span class="linenos">657</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
</span><span id="L-658"><a href="#L-658"><span class="linenos">658</span></a>
</span><span id="L-659"><a href="#L-659"><span class="linenos">659</span></a>    <span class="k">return</span> <span class="n">loader</span>
</span><span id="L-660"><a href="#L-660"><span class="linenos">660</span></a>
</span><span id="L-661"><a href="#L-661"><span class="linenos">661</span></a>
</span><span id="L-662"><a href="#L-662"><span class="linenos">662</span></a><span class="k">class</span> <span class="nc">SequenceModule</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
</span><span id="L-663"><a href="#L-663"><span class="linenos">663</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="L-664"><a href="#L-664"><span class="linenos">664</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="L-665"><a href="#L-665"><span class="linenos">665</span></a>        <span class="n">datapath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span>
</span><span id="L-666"><a href="#L-666"><span class="linenos">666</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span>
</span><span id="L-667"><a href="#L-667"><span class="linenos">667</span></a>        <span class="n">digests</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TDigest</span><span class="p">],</span>
</span><span id="L-668"><a href="#L-668"><span class="linenos">668</span></a>    <span class="p">):</span>
</span><span id="L-669"><a href="#L-669"><span class="linenos">669</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="L-670"><a href="#L-670"><span class="linenos">670</span></a>
</span><span id="L-671"><a href="#L-671"><span class="linenos">671</span></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
</span><span id="L-672"><a href="#L-672"><span class="linenos">672</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">Hyperparameters</span><span class="p">)</span>
</span><span id="L-673"><a href="#L-673"><span class="linenos">673</span></a>
</span><span id="L-674"><a href="#L-674"><span class="linenos">674</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="n">datapath</span>
</span><span id="L-675"><a href="#L-675"><span class="linenos">675</span></a>
</span><span id="L-676"><a href="#L-676"><span class="linenos">676</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span> <span class="o">=</span> <span class="n">params</span>
</span><span id="L-677"><a href="#L-677"><span class="linenos">677</span></a>
</span><span id="L-678"><a href="#L-678"><span class="linenos">678</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modular_field_embedder</span> <span class="o">=</span> <span class="n">ModularAttributeEmbeddingSystem</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-679"><a href="#L-679"><span class="linenos">679</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field_encoder</span> <span class="o">=</span> <span class="n">FieldEncoder</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-680"><a href="#L-680"><span class="linenos">680</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_encoder</span> <span class="o">=</span> <span class="n">EventEncoder</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-681"><a href="#L-681"><span class="linenos">681</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_decoder</span> <span class="o">=</span> <span class="n">EventDecoder</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-682"><a href="#L-682"><span class="linenos">682</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decision_head</span> <span class="o">=</span> <span class="n">DecisionHead</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-683"><a href="#L-683"><span class="linenos">683</span></a>
</span><span id="L-684"><a href="#L-684"><span class="linenos">684</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">create_metrics</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-685"><a href="#L-685"><span class="linenos">685</span></a>
</span><span id="L-686"><a href="#L-686"><span class="linenos">686</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pretrain&quot;</span>
</span><span id="L-687"><a href="#L-687"><span class="linenos">687</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">digests</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TDigest</span><span class="p">]</span> <span class="o">=</span> <span class="n">digests</span>
</span><span id="L-688"><a href="#L-688"><span class="linenos">688</span></a>
</span><span id="L-689"><a href="#L-689"><span class="linenos">689</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataLoader2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="L-690"><a href="#L-690"><span class="linenos">690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datapipes</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">IterDataPipe</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="L-691"><a href="#L-691"><span class="linenos">691</span></a>        
</span><span id="L-692"><a href="#L-692"><span class="linenos">692</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">example_input_array</span> <span class="o">=</span> <span class="n">mock</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-693"><a href="#L-693"><span class="linenos">693</span></a>
</span><span id="L-694"><a href="#L-694"><span class="linenos">694</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="L-695"><a href="#L-695"><span class="linenos">695</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N T&quot;</span><span class="p">],</span> <span class="n">TensorDict</span><span class="p">]:</span>
</span><span id="L-696"><a href="#L-696"><span class="linenos">696</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="L-697"><a href="#L-697"><span class="linenos">697</span></a><span class="sd">        Performs the forward pass of the encoder.</span>
</span><span id="L-698"><a href="#L-698"><span class="linenos">698</span></a>
</span><span id="L-699"><a href="#L-699"><span class="linenos">699</span></a><span class="sd">        Args:</span>
</span><span id="L-700"><a href="#L-700"><span class="linenos">700</span></a><span class="sd">            events (Float[Tensor, &quot;N L FC&quot;]): The input tensor.</span>
</span><span id="L-701"><a href="#L-701"><span class="linenos">701</span></a>
</span><span id="L-702"><a href="#L-702"><span class="linenos">702</span></a><span class="sd">        Returns:</span>
</span><span id="L-703"><a href="#L-703"><span class="linenos">703</span></a><span class="sd">            tuple[Tensor, TensorDict]:</span>
</span><span id="L-704"><a href="#L-704"><span class="linenos">704</span></a><span class="sd">            A tuple containing two tensors. The first tensor represents the supervised classification predictions and the second tensor represents the decoded, reconstructed events.</span>
</span><span id="L-705"><a href="#L-705"><span class="linenos">705</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="L-706"><a href="#L-706"><span class="linenos">706</span></a>
</span><span id="L-707"><a href="#L-707"><span class="linenos">707</span></a>        <span class="n">field_mask</span><span class="p">,</span> <span class="n">event_mask</span> <span class="o">=</span> <span class="n">create_attention_masks</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
</span><span id="L-708"><a href="#L-708"><span class="linenos">708</span></a>
</span><span id="L-709"><a href="#L-709"><span class="linenos">709</span></a>        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modular_field_embedder</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="L-710"><a href="#L-710"><span class="linenos">710</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_encoder</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">field_mask</span><span class="p">)</span>
</span><span id="L-711"><a href="#L-711"><span class="linenos">711</span></a>        <span class="n">sequence</span><span class="p">,</span> <span class="n">representations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_encoder</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">event_mask</span><span class="p">)</span>
</span><span id="L-712"><a href="#L-712"><span class="linenos">712</span></a>
</span><span id="L-713"><a href="#L-713"><span class="linenos">713</span></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_head</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
</span><span id="L-714"><a href="#L-714"><span class="linenos">714</span></a>        <span class="n">reconstructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_decoder</span><span class="p">(</span><span class="n">representations</span><span class="p">)</span>
</span><span id="L-715"><a href="#L-715"><span class="linenos">715</span></a>
</span><span id="L-716"><a href="#L-716"><span class="linenos">716</span></a>        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">reconstructions</span>
</span><span id="L-717"><a href="#L-717"><span class="linenos">717</span></a>
</span><span id="L-718"><a href="#L-718"><span class="linenos">718</span></a>    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">:</span>
</span><span id="L-719"><a href="#L-719"><span class="linenos">719</span></a>        
</span><span id="L-720"><a href="#L-720"><span class="linenos">720</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;pretrain&quot;</span><span class="p">:</span>
</span><span id="L-721"><a href="#L-721"><span class="linenos">721</span></a>            <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pretrain_lr</span>
</span><span id="L-722"><a href="#L-722"><span class="linenos">722</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;finetune&quot;</span><span class="p">:</span>
</span><span id="L-723"><a href="#L-723"><span class="linenos">723</span></a>            <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">finetune_lr</span>
</span><span id="L-724"><a href="#L-724"><span class="linenos">724</span></a>        
</span><span id="L-725"><a href="#L-725"><span class="linenos">725</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
</span><span id="L-726"><a href="#L-726"><span class="linenos">726</span></a>
</span><span id="L-727"><a href="#L-727"><span class="linenos">727</span></a>    <span class="k">def</span> <span class="nf">complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="L-728"><a href="#L-728"><span class="linenos">728</span></a>        <span class="n">n_bytes</span> <span class="o">=</span> <span class="n">complexity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-729"><a href="#L-729"><span class="linenos">729</span></a>
</span><span id="L-730"><a href="#L-730"><span class="linenos">730</span></a>        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
</span><span id="L-731"><a href="#L-731"><span class="linenos">731</span></a>            <span class="k">return</span> <span class="n">bytesize</span><span class="p">(</span><span class="n">n_bytes</span><span class="p">)</span>
</span><span id="L-732"><a href="#L-732"><span class="linenos">732</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="L-733"><a href="#L-733"><span class="linenos">733</span></a>            <span class="k">return</span> <span class="n">n_bytes</span>
</span><span id="L-734"><a href="#L-734"><span class="linenos">734</span></a>
</span><span id="L-735"><a href="#L-735"><span class="linenos">735</span></a>    <span class="n">training_step</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="L-736"><a href="#L-736"><span class="linenos">736</span></a>    <span class="n">validation_step</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;validate&quot;</span><span class="p">)</span>
</span><span id="L-737"><a href="#L-737"><span class="linenos">737</span></a>    <span class="n">testing_step</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</span><span id="L-738"><a href="#L-738"><span class="linenos">738</span></a>    <span class="n">predict_step</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
</span><span id="L-739"><a href="#L-739"><span class="linenos">739</span></a>
</span><span id="L-740"><a href="#L-740"><span class="linenos">740</span></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-741"><a href="#L-741"><span class="linenos">741</span></a>        <span class="n">pipe</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">datapath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">digests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">digests</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</span><span id="L-742"><a href="#L-742"><span class="linenos">742</span></a>
</span><span id="L-743"><a href="#L-743"><span class="linenos">743</span></a>        <span class="k">assert</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="L-744"><a href="#L-744"><span class="linenos">744</span></a>        
</span><span id="L-745"><a href="#L-745"><span class="linenos">745</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setting up for stage </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="L-746"><a href="#L-746"><span class="linenos">746</span></a>
</span><span id="L-747"><a href="#L-747"><span class="linenos">747</span></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-748"><a href="#L-748"><span class="linenos">748</span></a>            <span class="n">fit</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="L-749"><a href="#L-749"><span class="linenos">749</span></a>            <span class="n">validate</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="L-750"><a href="#L-750"><span class="linenos">750</span></a>            <span class="n">test</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
</span><span id="L-751"><a href="#L-751"><span class="linenos">751</span></a>            <span class="n">predict</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">],</span>   
</span><span id="L-752"><a href="#L-752"><span class="linenos">752</span></a>        <span class="p">)</span>
</span><span id="L-753"><a href="#L-753"><span class="linenos">753</span></a>
</span><span id="L-754"><a href="#L-754"><span class="linenos">754</span></a>        <span class="k">for</span> <span class="n">strata</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">stage</span><span class="p">]:</span>
</span><span id="L-755"><a href="#L-755"><span class="linenos">755</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">[</span><span class="n">strata</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">masks</span><span class="o">=</span><span class="s2">&quot;*.avro&quot;</span><span class="p">)</span>
</span><span id="L-756"><a href="#L-756"><span class="linenos">756</span></a>
</span><span id="L-757"><a href="#L-757"><span class="linenos">757</span></a>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-758"><a href="#L-758"><span class="linenos">758</span></a>        <span class="k">assert</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="L-759"><a href="#L-759"><span class="linenos">759</span></a>        
</span><span id="L-760"><a href="#L-760"><span class="linenos">760</span></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="L-761"><a href="#L-761"><span class="linenos">761</span></a>            <span class="n">fit</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="L-762"><a href="#L-762"><span class="linenos">762</span></a>            <span class="n">validate</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="L-763"><a href="#L-763"><span class="linenos">763</span></a>            <span class="n">test</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
</span><span id="L-764"><a href="#L-764"><span class="linenos">764</span></a>            <span class="n">predict</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">],</span>   
</span><span id="L-765"><a href="#L-765"><span class="linenos">765</span></a>        <span class="p">)</span>
</span><span id="L-766"><a href="#L-766"><span class="linenos">766</span></a>
</span><span id="L-767"><a href="#L-767"><span class="linenos">767</span></a>        <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">:</span>
</span><span id="L-768"><a href="#L-768"><span class="linenos">768</span></a>            <span class="n">loader</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</span><span id="L-769"><a href="#L-769"><span class="linenos">769</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="L-770"><a href="#L-770"><span class="linenos">770</span></a>        
</span><span id="L-771"><a href="#L-771"><span class="linenos">771</span></a>        <span class="k">for</span> <span class="n">strata</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">stage</span><span class="p">]:</span>
</span><span id="L-772"><a href="#L-772"><span class="linenos">772</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">[</span><span class="n">strata</span><span class="p">]</span>
</span><span id="L-773"><a href="#L-773"><span class="linenos">773</span></a>
</span><span id="L-774"><a href="#L-774"><span class="linenos">774</span></a>    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="L-775"><a href="#L-775"><span class="linenos">775</span></a>    <span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;validate&quot;</span><span class="p">)</span>
</span><span id="L-776"><a href="#L-776"><span class="linenos">776</span></a>    <span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</span><span id="L-777"><a href="#L-777"><span class="linenos">777</span></a>    <span class="n">predict_dataloader</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
</span><span id="L-778"><a href="#L-778"><span class="linenos">778</span></a>
</span><span id="L-779"><a href="#L-779"><span class="linenos">779</span></a>    <span class="nd">@property</span>
</span><span id="L-780"><a href="#L-780"><span class="linenos">780</span></a>    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="L-781"><a href="#L-781"><span class="linenos">781</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>
</span><span id="L-782"><a href="#L-782"><span class="linenos">782</span></a>
</span><span id="L-783"><a href="#L-783"><span class="linenos">783</span></a>    <span class="nd">@mode</span><span class="o">.</span><span class="n">setter</span>
</span><span id="L-784"><a href="#L-784"><span class="linenos">784</span></a>    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="L-785"><a href="#L-785"><span class="linenos">785</span></a>        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pretrain&quot;</span><span class="p">,</span> <span class="s2">&quot;finetune&quot;</span><span class="p">]</span>
</span><span id="L-786"><a href="#L-786"><span class="linenos">786</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
</span></pre></div>


            </section>
                <section id="complexity">
                            <input id="complexity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">complexity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span></span><span class="return-annotation">) -> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="complexity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#complexity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="complexity-24"><a href="#complexity-24"><span class="linenos">24</span></a><span class="k">def</span> <span class="nf">complexity</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="complexity-25"><a href="#complexity-25"><span class="linenos">25</span></a>
</span><span id="complexity-26"><a href="#complexity-26"><span class="linenos">26</span></a>    <span class="c1"># as per https://pytorch.org/docs/stable/generated/torch.nn.TransformerEncoderLayer.html</span>
</span><span id="complexity-27"><a href="#complexity-27"><span class="linenos">27</span></a>    <span class="n">D_FFN</span> <span class="o">=</span> <span class="mi">2048</span>
</span><span id="complexity-28"><a href="#complexity-28"><span class="linenos">28</span></a>    
</span><span id="complexity-29"><a href="#complexity-29"><span class="linenos">29</span></a>    <span class="c1"># pretty good assumption you are using FP16 or BF16</span>
</span><span id="complexity-30"><a href="#complexity-30"><span class="linenos">30</span></a>    <span class="n">FP_PRECISION</span> <span class="o">=</span> <span class="mi">16</span>
</span><span id="complexity-31"><a href="#complexity-31"><span class="linenos">31</span></a>
</span><span id="complexity-32"><a href="#complexity-32"><span class="linenos">32</span></a>    <span class="k">def</span> <span class="nf">_calculate_bert_memory_complexity</span><span class="p">(</span>
</span><span id="complexity-33"><a href="#complexity-33"><span class="linenos">33</span></a>        <span class="n">batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="complexity-34"><a href="#complexity-34"><span class="linenos">34</span></a>        <span class="n">max_seq_len</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="complexity-35"><a href="#complexity-35"><span class="linenos">35</span></a>        <span class="n">d_hidden</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="complexity-36"><a href="#complexity-36"><span class="linenos">36</span></a>        <span class="n">n_heads</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="complexity-37"><a href="#complexity-37"><span class="linenos">37</span></a>        <span class="n">n_blocks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="complexity-38"><a href="#complexity-38"><span class="linenos">38</span></a>        <span class="n">precision</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="complexity-39"><a href="#complexity-39"><span class="linenos">39</span></a>        <span class="n">d_ffn</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
</span><span id="complexity-40"><a href="#complexity-40"><span class="linenos">40</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="complexity-41"><a href="#complexity-41"><span class="linenos">41</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;batch_size must be an integer&quot;</span>
</span><span id="complexity-42"><a href="#complexity-42"><span class="linenos">42</span></a>        <span class="k">assert</span> <span class="n">batch_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;batch_size must be greater than 0&quot;</span>
</span><span id="complexity-43"><a href="#complexity-43"><span class="linenos">43</span></a>
</span><span id="complexity-44"><a href="#complexity-44"><span class="linenos">44</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_seq_len</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;max_seq_len must be an integer&quot;</span>
</span><span id="complexity-45"><a href="#complexity-45"><span class="linenos">45</span></a>        <span class="k">assert</span> <span class="n">max_seq_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;max_seq_len must be greater than 0&quot;</span>
</span><span id="complexity-46"><a href="#complexity-46"><span class="linenos">46</span></a>
</span><span id="complexity-47"><a href="#complexity-47"><span class="linenos">47</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d_hidden</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;d_hidden must be an integer&quot;</span>
</span><span id="complexity-48"><a href="#complexity-48"><span class="linenos">48</span></a>        <span class="k">assert</span> <span class="n">d_hidden</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;d_hidden must be greater than 0&quot;</span>
</span><span id="complexity-49"><a href="#complexity-49"><span class="linenos">49</span></a>
</span><span id="complexity-50"><a href="#complexity-50"><span class="linenos">50</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_heads</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;n_heads must be an integer&quot;</span>
</span><span id="complexity-51"><a href="#complexity-51"><span class="linenos">51</span></a>        <span class="k">assert</span> <span class="n">n_heads</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;n_heads must be greater than 0&quot;</span>
</span><span id="complexity-52"><a href="#complexity-52"><span class="linenos">52</span></a>
</span><span id="complexity-53"><a href="#complexity-53"><span class="linenos">53</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">n_blocks</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;n_blocks must be an integer&quot;</span>
</span><span id="complexity-54"><a href="#complexity-54"><span class="linenos">54</span></a>        <span class="k">assert</span> <span class="n">n_blocks</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;n_blocks must be greater than 0&quot;</span>
</span><span id="complexity-55"><a href="#complexity-55"><span class="linenos">55</span></a>
</span><span id="complexity-56"><a href="#complexity-56"><span class="linenos">56</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">precision</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;precision must be an integer&quot;</span>
</span><span id="complexity-57"><a href="#complexity-57"><span class="linenos">57</span></a>        <span class="k">assert</span> <span class="n">precision</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;precision must be greater than 0&quot;</span>
</span><span id="complexity-58"><a href="#complexity-58"><span class="linenos">58</span></a>
</span><span id="complexity-59"><a href="#complexity-59"><span class="linenos">59</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d_ffn</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;FFN dim must be an integer&quot;</span>
</span><span id="complexity-60"><a href="#complexity-60"><span class="linenos">60</span></a>        <span class="k">assert</span> <span class="n">d_ffn</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;FFN dim must be greater than 0&quot;</span>
</span><span id="complexity-61"><a href="#complexity-61"><span class="linenos">61</span></a>
</span><span id="complexity-62"><a href="#complexity-62"><span class="linenos">62</span></a>        <span class="n">memory</span> <span class="o">=</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">max_seq_len</span> <span class="o">*</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">d_hidden</span> <span class="o">+</span> <span class="n">d_ffn</span><span class="p">)</span>
</span><span id="complexity-63"><a href="#complexity-63"><span class="linenos">63</span></a>        <span class="n">memory</span> <span class="o">+=</span> <span class="n">batch_size</span> <span class="o">*</span> <span class="n">n_heads</span> <span class="o">*</span> <span class="n">max_seq_len</span> <span class="o">*</span> <span class="n">max_seq_len</span>
</span><span id="complexity-64"><a href="#complexity-64"><span class="linenos">64</span></a>        
</span><span id="complexity-65"><a href="#complexity-65"><span class="linenos">65</span></a>        <span class="c1"># the &quot;3&quot; comes from forward prop, backward prop, and general model overhead</span>
</span><span id="complexity-66"><a href="#complexity-66"><span class="linenos">66</span></a>        <span class="n">memory</span> <span class="o">*=</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">n_blocks</span> <span class="o">*</span> <span class="n">precision</span>
</span><span id="complexity-67"><a href="#complexity-67"><span class="linenos">67</span></a>
</span><span id="complexity-68"><a href="#complexity-68"><span class="linenos">68</span></a>        <span class="k">return</span> <span class="n">memory</span>
</span><span id="complexity-69"><a href="#complexity-69"><span class="linenos">69</span></a>
</span><span id="complexity-70"><a href="#complexity-70"><span class="linenos">70</span></a>    <span class="n">encoder</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
</span><span id="complexity-71"><a href="#complexity-71"><span class="linenos">71</span></a>        <span class="n">_calculate_bert_memory_complexity</span><span class="p">,</span>
</span><span id="complexity-72"><a href="#complexity-72"><span class="linenos">72</span></a>        <span class="n">precision</span><span class="o">=</span><span class="n">FP_PRECISION</span><span class="p">,</span>
</span><span id="complexity-73"><a href="#complexity-73"><span class="linenos">73</span></a>        <span class="n">d_ffn</span><span class="o">=</span><span class="n">D_FFN</span><span class="p">,</span>
</span><span id="complexity-74"><a href="#complexity-74"><span class="linenos">74</span></a>    <span class="p">)</span>
</span><span id="complexity-75"><a href="#complexity-75"><span class="linenos">75</span></a>
</span><span id="complexity-76"><a href="#complexity-76"><span class="linenos">76</span></a>    <span class="n">field</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span>
</span><span id="complexity-77"><a href="#complexity-77"><span class="linenos">77</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">n_context</span><span class="p">,</span>
</span><span id="complexity-78"><a href="#complexity-78"><span class="linenos">78</span></a>        <span class="n">max_seq_len</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span><span class="p">,</span>
</span><span id="complexity-79"><a href="#complexity-79"><span class="linenos">79</span></a>        <span class="n">d_hidden</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="complexity-80"><a href="#complexity-80"><span class="linenos">80</span></a>        <span class="n">n_blocks</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_field_encoder</span><span class="p">,</span>
</span><span id="complexity-81"><a href="#complexity-81"><span class="linenos">81</span></a>        <span class="n">n_heads</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_field_encoder</span><span class="p">,</span>
</span><span id="complexity-82"><a href="#complexity-82"><span class="linenos">82</span></a>    <span class="p">)</span>
</span><span id="complexity-83"><a href="#complexity-83"><span class="linenos">83</span></a>
</span><span id="complexity-84"><a href="#complexity-84"><span class="linenos">84</span></a>    <span class="n">event</span> <span class="o">=</span> <span class="n">encoder</span><span class="p">(</span>
</span><span id="complexity-85"><a href="#complexity-85"><span class="linenos">85</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="complexity-86"><a href="#complexity-86"><span class="linenos">86</span></a>        <span class="n">max_seq_len</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_context</span><span class="p">,</span>
</span><span id="complexity-87"><a href="#complexity-87"><span class="linenos">87</span></a>        <span class="n">d_hidden</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="complexity-88"><a href="#complexity-88"><span class="linenos">88</span></a>        <span class="n">n_blocks</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_event_encoder</span><span class="p">,</span>
</span><span id="complexity-89"><a href="#complexity-89"><span class="linenos">89</span></a>        <span class="n">n_heads</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_event_encoder</span><span class="p">,</span>
</span><span id="complexity-90"><a href="#complexity-90"><span class="linenos">90</span></a>    <span class="p">)</span>
</span><span id="complexity-91"><a href="#complexity-91"><span class="linenos">91</span></a>
</span><span id="complexity-92"><a href="#complexity-92"><span class="linenos">92</span></a>    <span class="k">return</span> <span class="nb">int</span><span class="p">((</span><span class="n">field</span> <span class="o">+</span> <span class="n">event</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span>
</span></pre></div>


    

                </section>
                <section id="create_attention_masks">
                            <input id="create_attention_masks-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jaxtyped(typechecker=beartype)</div>

        <span class="def">def</span>
        <span class="name">create_attention_masks</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">inputs</span><span class="p">:</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span>,</span><span class="param">	<span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Field</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="create_attention_masks-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_attention_masks"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_attention_masks-100"><a href="#create_attention_masks-100"><span class="linenos">100</span></a><span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="create_attention_masks-101"><a href="#create_attention_masks-101"><span class="linenos">101</span></a><span class="k">def</span> <span class="nf">create_attention_masks</span><span class="p">(</span><span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Field</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tensor</span><span class="p">]:</span>
</span><span id="create_attention_masks-102"><a href="#create_attention_masks-102"><span class="linenos">102</span></a>    <span class="n">flags</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="create_attention_masks-103"><a href="#create_attention_masks-103"><span class="linenos">103</span></a>
</span><span id="create_attention_masks-104"><a href="#create_attention_masks-104"><span class="linenos">104</span></a>    <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">:</span>
</span><span id="create_attention_masks-105"><a href="#create_attention_masks-105"><span class="linenos">105</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;lookup&quot;</span><span class="p">)]</span>
</span><span id="create_attention_masks-106"><a href="#create_attention_masks-106"><span class="linenos">106</span></a>
</span><span id="create_attention_masks-107"><a href="#create_attention_masks-107"><span class="linenos">107</span></a>        <span class="n">is_padded</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">,</span> <span class="s2">&quot;PAD_&quot;</span><span class="p">))</span>
</span><span id="create_attention_masks-108"><a href="#create_attention_masks-108"><span class="linenos">108</span></a>        <span class="n">is_null</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">,</span> <span class="s2">&quot;NAN_&quot;</span><span class="p">))</span>
</span><span id="create_attention_masks-109"><a href="#create_attention_masks-109"><span class="linenos">109</span></a>
</span><span id="create_attention_masks-110"><a href="#create_attention_masks-110"><span class="linenos">110</span></a>        <span class="c1"># FIXME hold up... this won&#39;t work for the discrete tokens (&quot;NULL_&quot;)</span>
</span><span id="create_attention_masks-111"><a href="#create_attention_masks-111"><span class="linenos">111</span></a>
</span><span id="create_attention_masks-112"><a href="#create_attention_masks-112"><span class="linenos">112</span></a>        <span class="n">flags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">is_padded</span> <span class="o">|</span> <span class="n">is_null</span><span class="p">)</span>
</span><span id="create_attention_masks-113"><a href="#create_attention_masks-113"><span class="linenos">113</span></a>
</span><span id="create_attention_masks-114"><a href="#create_attention_masks-114"><span class="linenos">114</span></a>    <span class="n">flags</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="create_attention_masks-115"><a href="#create_attention_masks-115"><span class="linenos">115</span></a>
</span><span id="create_attention_masks-116"><a href="#create_attention_masks-116"><span class="linenos">116</span></a>    <span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span> <span class="o">=</span> <span class="n">flags</span><span class="o">.</span><span class="n">shape</span>
</span><span id="create_attention_masks-117"><a href="#create_attention_masks-117"><span class="linenos">117</span></a>
</span><span id="create_attention_masks-118"><a href="#create_attention_masks-118"><span class="linenos">118</span></a>    <span class="n">field_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">flags</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
</span><span id="create_attention_masks-119"><a href="#create_attention_masks-119"><span class="linenos">119</span></a>    <span class="n">event_mask</span> <span class="o">=</span> <span class="o">~</span><span class="n">flags</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="create_attention_masks-120"><a href="#create_attention_masks-120"><span class="linenos">120</span></a>
</span><span id="create_attention_masks-121"><a href="#create_attention_masks-121"><span class="linenos">121</span></a>    <span class="k">return</span> <span class="p">(</span><span class="n">_squarify</span><span class="p">(</span><span class="n">field_mask</span><span class="p">),</span> <span class="n">_squarify</span><span class="p">(</span><span class="n">event_mask</span><span class="p">))</span>
</span></pre></div>


    

                </section>
                <section id="LearnedTensor">
                            <input id="LearnedTensor-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">LearnedTensor</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="LearnedTensor-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LearnedTensor"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LearnedTensor-124"><a href="#LearnedTensor-124"><span class="linenos">124</span></a><span class="k">class</span> <span class="nc">LearnedTensor</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="LearnedTensor-125"><a href="#LearnedTensor-125"><span class="linenos">125</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LearnedTensor-126"><a href="#LearnedTensor-126"><span class="linenos">126</span></a><span class="sd">    LearnedTensor is a PyTorch module that initializes a tensor with normal distribution and learns its values during training.</span>
</span><span id="LearnedTensor-127"><a href="#LearnedTensor-127"><span class="linenos">127</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="LearnedTensor-128"><a href="#LearnedTensor-128"><span class="linenos">128</span></a>
</span><span id="LearnedTensor-129"><a href="#LearnedTensor-129"><span class="linenos">129</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="LearnedTensor-130"><a href="#LearnedTensor-130"><span class="linenos">130</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LearnedTensor-131"><a href="#LearnedTensor-131"><span class="linenos">131</span></a><span class="sd">        Initializes the LearnedTensor.</span>
</span><span id="LearnedTensor-132"><a href="#LearnedTensor-132"><span class="linenos">132</span></a>
</span><span id="LearnedTensor-133"><a href="#LearnedTensor-133"><span class="linenos">133</span></a><span class="sd">        Args:</span>
</span><span id="LearnedTensor-134"><a href="#LearnedTensor-134"><span class="linenos">134</span></a><span class="sd">            sizes (int): The sizes of the dimensions of the tensor.</span>
</span><span id="LearnedTensor-135"><a href="#LearnedTensor-135"><span class="linenos">135</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LearnedTensor-136"><a href="#LearnedTensor-136"><span class="linenos">136</span></a>
</span><span id="LearnedTensor-137"><a href="#LearnedTensor-137"><span class="linenos">137</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="LearnedTensor-138"><a href="#LearnedTensor-138"><span class="linenos">138</span></a>
</span><span id="LearnedTensor-139"><a href="#LearnedTensor-139"><span class="linenos">139</span></a>        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
</span><span id="LearnedTensor-140"><a href="#LearnedTensor-140"><span class="linenos">140</span></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;each dim must be of type int&quot;</span>
</span><span id="LearnedTensor-141"><a href="#LearnedTensor-141"><span class="linenos">141</span></a>            <span class="k">assert</span> <span class="n">dim</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;each dim must be greater than 0&quot;</span>
</span><span id="LearnedTensor-142"><a href="#LearnedTensor-142"><span class="linenos">142</span></a>
</span><span id="LearnedTensor-143"><a href="#LearnedTensor-143"><span class="linenos">143</span></a>        <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
</span><span id="LearnedTensor-144"><a href="#LearnedTensor-144"><span class="linenos">144</span></a>
</span><span id="LearnedTensor-145"><a href="#LearnedTensor-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
</span><span id="LearnedTensor-146"><a href="#LearnedTensor-146"><span class="linenos">146</span></a>
</span><span id="LearnedTensor-147"><a href="#LearnedTensor-147"><span class="linenos">147</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="LearnedTensor-148"><a href="#LearnedTensor-148"><span class="linenos">148</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]:</span>
</span><span id="LearnedTensor-149"><a href="#LearnedTensor-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LearnedTensor-150"><a href="#LearnedTensor-150"><span class="linenos">150</span></a><span class="sd">        Returns the learned tensor.</span>
</span><span id="LearnedTensor-151"><a href="#LearnedTensor-151"><span class="linenos">151</span></a>
</span><span id="LearnedTensor-152"><a href="#LearnedTensor-152"><span class="linenos">152</span></a><span class="sd">        Returns:</span>
</span><span id="LearnedTensor-153"><a href="#LearnedTensor-153"><span class="linenos">153</span></a><span class="sd">            Float[Tensor, &#39;...&#39;]: The learned tensor.</span>
</span><span id="LearnedTensor-154"><a href="#LearnedTensor-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LearnedTensor-155"><a href="#LearnedTensor-155"><span class="linenos">155</span></a>
</span><span id="LearnedTensor-156"><a href="#LearnedTensor-156"><span class="linenos">156</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span>
</span></pre></div>


            <div class="docstring"><p>LearnedTensor is a PyTorch module that initializes a tensor with normal distribution and learns its values during training.</p>
</div>


                            <div id="LearnedTensor.__init__" class="classattr">
                                        <input id="LearnedTensor.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">LearnedTensor</span><span class="signature pdoc-code condensed">(<span class="param"><span class="o">*</span><span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span></span>)</span>

                <label class="view-source-button" for="LearnedTensor.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LearnedTensor.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LearnedTensor.__init__-129"><a href="#LearnedTensor.__init__-129"><span class="linenos">129</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">sizes</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
</span><span id="LearnedTensor.__init__-130"><a href="#LearnedTensor.__init__-130"><span class="linenos">130</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LearnedTensor.__init__-131"><a href="#LearnedTensor.__init__-131"><span class="linenos">131</span></a><span class="sd">        Initializes the LearnedTensor.</span>
</span><span id="LearnedTensor.__init__-132"><a href="#LearnedTensor.__init__-132"><span class="linenos">132</span></a>
</span><span id="LearnedTensor.__init__-133"><a href="#LearnedTensor.__init__-133"><span class="linenos">133</span></a><span class="sd">        Args:</span>
</span><span id="LearnedTensor.__init__-134"><a href="#LearnedTensor.__init__-134"><span class="linenos">134</span></a><span class="sd">            sizes (int): The sizes of the dimensions of the tensor.</span>
</span><span id="LearnedTensor.__init__-135"><a href="#LearnedTensor.__init__-135"><span class="linenos">135</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LearnedTensor.__init__-136"><a href="#LearnedTensor.__init__-136"><span class="linenos">136</span></a>
</span><span id="LearnedTensor.__init__-137"><a href="#LearnedTensor.__init__-137"><span class="linenos">137</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="LearnedTensor.__init__-138"><a href="#LearnedTensor.__init__-138"><span class="linenos">138</span></a>
</span><span id="LearnedTensor.__init__-139"><a href="#LearnedTensor.__init__-139"><span class="linenos">139</span></a>        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">sizes</span><span class="p">:</span>
</span><span id="LearnedTensor.__init__-140"><a href="#LearnedTensor.__init__-140"><span class="linenos">140</span></a>            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="s2">&quot;each dim must be of type int&quot;</span>
</span><span id="LearnedTensor.__init__-141"><a href="#LearnedTensor.__init__-141"><span class="linenos">141</span></a>            <span class="k">assert</span> <span class="n">dim</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;each dim must be greater than 0&quot;</span>
</span><span id="LearnedTensor.__init__-142"><a href="#LearnedTensor.__init__-142"><span class="linenos">142</span></a>
</span><span id="LearnedTensor.__init__-143"><a href="#LearnedTensor.__init__-143"><span class="linenos">143</span></a>        <span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="nb">tuple</span><span class="p">(</span><span class="n">sizes</span><span class="p">))</span>
</span><span id="LearnedTensor.__init__-144"><a href="#LearnedTensor.__init__-144"><span class="linenos">144</span></a>
</span><span id="LearnedTensor.__init__-145"><a href="#LearnedTensor.__init__-145"><span class="linenos">145</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">tensor</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initializes the LearnedTensor.</p>

<p>Args:
    sizes (int): The sizes of the dimensions of the tensor.</p>
</div>


                            </div>
                            <div id="LearnedTensor.tensor" class="classattr">
                                <div class="attr variable">
            <span class="name">tensor</span>

        
    </div>
    <a class="headerlink" href="#LearnedTensor.tensor"></a>
    
    

                            </div>
                            <div id="LearnedTensor.forward" class="classattr">
                                        <input id="LearnedTensor.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jaxtyped(typechecker=beartype)</div>

        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;...&#39;</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="LearnedTensor.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#LearnedTensor.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="LearnedTensor.forward-147"><a href="#LearnedTensor.forward-147"><span class="linenos">147</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="LearnedTensor.forward-148"><a href="#LearnedTensor.forward-148"><span class="linenos">148</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;...&quot;</span><span class="p">]:</span>
</span><span id="LearnedTensor.forward-149"><a href="#LearnedTensor.forward-149"><span class="linenos">149</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="LearnedTensor.forward-150"><a href="#LearnedTensor.forward-150"><span class="linenos">150</span></a><span class="sd">        Returns the learned tensor.</span>
</span><span id="LearnedTensor.forward-151"><a href="#LearnedTensor.forward-151"><span class="linenos">151</span></a>
</span><span id="LearnedTensor.forward-152"><a href="#LearnedTensor.forward-152"><span class="linenos">152</span></a><span class="sd">        Returns:</span>
</span><span id="LearnedTensor.forward-153"><a href="#LearnedTensor.forward-153"><span class="linenos">153</span></a><span class="sd">            Float[Tensor, &#39;...&#39;]: The learned tensor.</span>
</span><span id="LearnedTensor.forward-154"><a href="#LearnedTensor.forward-154"><span class="linenos">154</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="LearnedTensor.forward-155"><a href="#LearnedTensor.forward-155"><span class="linenos">155</span></a>
</span><span id="LearnedTensor.forward-156"><a href="#LearnedTensor.forward-156"><span class="linenos">156</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tensor</span>
</span></pre></div>


            <div class="docstring"><p>Returns the learned tensor.</p>

<p>Returns:
    Float[Tensor, '...']: The learned tensor.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="LearnedTensor.dump_patches" class="variable">dump_patches</dd>
                <dd id="LearnedTensor.training" class="variable">training</dd>
                <dd id="LearnedTensor.call_super_init" class="variable">call_super_init</dd>
                <dd id="LearnedTensor.register_buffer" class="function">register_buffer</dd>
                <dd id="LearnedTensor.register_parameter" class="function">register_parameter</dd>
                <dd id="LearnedTensor.add_module" class="function">add_module</dd>
                <dd id="LearnedTensor.register_module" class="function">register_module</dd>
                <dd id="LearnedTensor.get_submodule" class="function">get_submodule</dd>
                <dd id="LearnedTensor.get_parameter" class="function">get_parameter</dd>
                <dd id="LearnedTensor.get_buffer" class="function">get_buffer</dd>
                <dd id="LearnedTensor.get_extra_state" class="function">get_extra_state</dd>
                <dd id="LearnedTensor.set_extra_state" class="function">set_extra_state</dd>
                <dd id="LearnedTensor.apply" class="function">apply</dd>
                <dd id="LearnedTensor.cuda" class="function">cuda</dd>
                <dd id="LearnedTensor.ipu" class="function">ipu</dd>
                <dd id="LearnedTensor.xpu" class="function">xpu</dd>
                <dd id="LearnedTensor.cpu" class="function">cpu</dd>
                <dd id="LearnedTensor.type" class="function">type</dd>
                <dd id="LearnedTensor.float" class="function">float</dd>
                <dd id="LearnedTensor.double" class="function">double</dd>
                <dd id="LearnedTensor.half" class="function">half</dd>
                <dd id="LearnedTensor.bfloat16" class="function">bfloat16</dd>
                <dd id="LearnedTensor.to_empty" class="function">to_empty</dd>
                <dd id="LearnedTensor.to" class="function">to</dd>
                <dd id="LearnedTensor.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="LearnedTensor.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="LearnedTensor.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="LearnedTensor.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="LearnedTensor.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="LearnedTensor.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="LearnedTensor.state_dict" class="function">state_dict</dd>
                <dd id="LearnedTensor.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="LearnedTensor.load_state_dict" class="function">load_state_dict</dd>
                <dd id="LearnedTensor.parameters" class="function">parameters</dd>
                <dd id="LearnedTensor.named_parameters" class="function">named_parameters</dd>
                <dd id="LearnedTensor.buffers" class="function">buffers</dd>
                <dd id="LearnedTensor.named_buffers" class="function">named_buffers</dd>
                <dd id="LearnedTensor.children" class="function">children</dd>
                <dd id="LearnedTensor.named_children" class="function">named_children</dd>
                <dd id="LearnedTensor.modules" class="function">modules</dd>
                <dd id="LearnedTensor.named_modules" class="function">named_modules</dd>
                <dd id="LearnedTensor.train" class="function">train</dd>
                <dd id="LearnedTensor.eval" class="function">eval</dd>
                <dd id="LearnedTensor.requires_grad_" class="function">requires_grad_</dd>
                <dd id="LearnedTensor.zero_grad" class="function">zero_grad</dd>
                <dd id="LearnedTensor.share_memory" class="function">share_memory</dd>
                <dd id="LearnedTensor.extra_repr" class="function">extra_repr</dd>
                <dd id="LearnedTensor.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="DiscreteFieldEmbedder">
                            <input id="DiscreteFieldEmbedder-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DiscreteFieldEmbedder</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="DiscreteFieldEmbedder-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DiscreteFieldEmbedder"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DiscreteFieldEmbedder-159"><a href="#DiscreteFieldEmbedder-159"><span class="linenos">159</span></a><span class="k">class</span> <span class="nc">DiscreteFieldEmbedder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="DiscreteFieldEmbedder-160"><a href="#DiscreteFieldEmbedder-160"><span class="linenos">160</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
</span><span id="DiscreteFieldEmbedder-161"><a href="#DiscreteFieldEmbedder-161"><span class="linenos">161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DiscreteFieldEmbedder-162"><a href="#DiscreteFieldEmbedder-162"><span class="linenos">162</span></a><span class="sd">        Initialize discrete field embedder.</span>
</span><span id="DiscreteFieldEmbedder-163"><a href="#DiscreteFieldEmbedder-163"><span class="linenos">163</span></a>
</span><span id="DiscreteFieldEmbedder-164"><a href="#DiscreteFieldEmbedder-164"><span class="linenos">164</span></a><span class="sd">        Args:</span>
</span><span id="DiscreteFieldEmbedder-165"><a href="#DiscreteFieldEmbedder-165"><span class="linenos">165</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="DiscreteFieldEmbedder-166"><a href="#DiscreteFieldEmbedder-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DiscreteFieldEmbedder-167"><a href="#DiscreteFieldEmbedder-167"><span class="linenos">167</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="DiscreteFieldEmbedder-168"><a href="#DiscreteFieldEmbedder-168"><span class="linenos">168</span></a>
</span><span id="DiscreteFieldEmbedder-169"><a href="#DiscreteFieldEmbedder-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">field</span>
</span><span id="DiscreteFieldEmbedder-170"><a href="#DiscreteFieldEmbedder-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">n_levels</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="DiscreteFieldEmbedder-171"><a href="#DiscreteFieldEmbedder-171"><span class="linenos">171</span></a>
</span><span id="DiscreteFieldEmbedder-172"><a href="#DiscreteFieldEmbedder-172"><span class="linenos">172</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="DiscreteFieldEmbedder-173"><a href="#DiscreteFieldEmbedder-173"><span class="linenos">173</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;lookup&quot;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Base class for all neural network modules.</p>

<p>Your models should also subclass this class.</p>

<p>Modules can also contain other Modules, allowing to nest them in
a tree structure. You can assign the submodules as regular attributes::</p>

<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))
</code></pre>

<p>Submodules assigned in this way will be registered, and will have their
parameters converted too when you call <code><a href="#DiscreteFieldEmbedder.to">to()</a></code>, etc.</p>

<div class="pdoc-alert pdoc-alert-note">

<p>As per the example above, an <code><a href="#DiscreteFieldEmbedder.__init__">__init__()</a></code> call to the parent class
must be made before assignment on the child.</p>

</div>

<p>:ivar training: Boolean represents whether this module is in training or
                evaluation mode.
:vartype training: bool</p>
</div>


                            <div id="DiscreteFieldEmbedder.__init__" class="classattr">
                                        <input id="DiscreteFieldEmbedder.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DiscreteFieldEmbedder</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span>,</span><span class="param">	<span class="n">field</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Field</span></span>)</span>

                <label class="view-source-button" for="DiscreteFieldEmbedder.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DiscreteFieldEmbedder.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DiscreteFieldEmbedder.__init__-160"><a href="#DiscreteFieldEmbedder.__init__-160"><span class="linenos">160</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
</span><span id="DiscreteFieldEmbedder.__init__-161"><a href="#DiscreteFieldEmbedder.__init__-161"><span class="linenos">161</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DiscreteFieldEmbedder.__init__-162"><a href="#DiscreteFieldEmbedder.__init__-162"><span class="linenos">162</span></a><span class="sd">        Initialize discrete field embedder.</span>
</span><span id="DiscreteFieldEmbedder.__init__-163"><a href="#DiscreteFieldEmbedder.__init__-163"><span class="linenos">163</span></a>
</span><span id="DiscreteFieldEmbedder.__init__-164"><a href="#DiscreteFieldEmbedder.__init__-164"><span class="linenos">164</span></a><span class="sd">        Args:</span>
</span><span id="DiscreteFieldEmbedder.__init__-165"><a href="#DiscreteFieldEmbedder.__init__-165"><span class="linenos">165</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="DiscreteFieldEmbedder.__init__-166"><a href="#DiscreteFieldEmbedder.__init__-166"><span class="linenos">166</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DiscreteFieldEmbedder.__init__-167"><a href="#DiscreteFieldEmbedder.__init__-167"><span class="linenos">167</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="DiscreteFieldEmbedder.__init__-168"><a href="#DiscreteFieldEmbedder.__init__-168"><span class="linenos">168</span></a>
</span><span id="DiscreteFieldEmbedder.__init__-169"><a href="#DiscreteFieldEmbedder.__init__-169"><span class="linenos">169</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">field</span>
</span><span id="DiscreteFieldEmbedder.__init__-170"><a href="#DiscreteFieldEmbedder.__init__-170"><span class="linenos">170</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">n_levels</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize discrete field embedder.</p>

<p>Args:
    params (Hyperparameters): The hyperparameters for the architecture.</p>
</div>


                            </div>
                            <div id="DiscreteFieldEmbedder.field" class="classattr">
                                <div class="attr variable">
            <span class="name">field</span><span class="annotation">: source.core.schema.Field</span>

        
    </div>
    <a class="headerlink" href="#DiscreteFieldEmbedder.field"></a>
    
    

                            </div>
                            <div id="DiscreteFieldEmbedder.embeddings" class="classattr">
                                <div class="attr variable">
            <span class="name">embeddings</span>

        
    </div>
    <a class="headerlink" href="#DiscreteFieldEmbedder.embeddings"></a>
    
    

                            </div>
                            <div id="DiscreteFieldEmbedder.forward" class="classattr">
                                        <input id="DiscreteFieldEmbedder.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inputs</span><span class="p">:</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="DiscreteFieldEmbedder.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DiscreteFieldEmbedder.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DiscreteFieldEmbedder.forward-172"><a href="#DiscreteFieldEmbedder.forward-172"><span class="linenos">172</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="DiscreteFieldEmbedder.forward-173"><a href="#DiscreteFieldEmbedder.forward-173"><span class="linenos">173</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;lookup&quot;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Define the computation performed at every call.</p>

<p>Should be overridden by all subclasses.</p>

<div class="pdoc-alert pdoc-alert-note">

<p>Although the recipe for forward pass needs to be defined within
this function, one should call the <code>Module</code> instance afterwards
instead of this since the former takes care of running the
registered hooks while the latter silently ignores them.</p>

</div>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="DiscreteFieldEmbedder.dump_patches" class="variable">dump_patches</dd>
                <dd id="DiscreteFieldEmbedder.training" class="variable">training</dd>
                <dd id="DiscreteFieldEmbedder.call_super_init" class="variable">call_super_init</dd>
                <dd id="DiscreteFieldEmbedder.register_buffer" class="function">register_buffer</dd>
                <dd id="DiscreteFieldEmbedder.register_parameter" class="function">register_parameter</dd>
                <dd id="DiscreteFieldEmbedder.add_module" class="function">add_module</dd>
                <dd id="DiscreteFieldEmbedder.register_module" class="function">register_module</dd>
                <dd id="DiscreteFieldEmbedder.get_submodule" class="function">get_submodule</dd>
                <dd id="DiscreteFieldEmbedder.get_parameter" class="function">get_parameter</dd>
                <dd id="DiscreteFieldEmbedder.get_buffer" class="function">get_buffer</dd>
                <dd id="DiscreteFieldEmbedder.get_extra_state" class="function">get_extra_state</dd>
                <dd id="DiscreteFieldEmbedder.set_extra_state" class="function">set_extra_state</dd>
                <dd id="DiscreteFieldEmbedder.apply" class="function">apply</dd>
                <dd id="DiscreteFieldEmbedder.cuda" class="function">cuda</dd>
                <dd id="DiscreteFieldEmbedder.ipu" class="function">ipu</dd>
                <dd id="DiscreteFieldEmbedder.xpu" class="function">xpu</dd>
                <dd id="DiscreteFieldEmbedder.cpu" class="function">cpu</dd>
                <dd id="DiscreteFieldEmbedder.type" class="function">type</dd>
                <dd id="DiscreteFieldEmbedder.float" class="function">float</dd>
                <dd id="DiscreteFieldEmbedder.double" class="function">double</dd>
                <dd id="DiscreteFieldEmbedder.half" class="function">half</dd>
                <dd id="DiscreteFieldEmbedder.bfloat16" class="function">bfloat16</dd>
                <dd id="DiscreteFieldEmbedder.to_empty" class="function">to_empty</dd>
                <dd id="DiscreteFieldEmbedder.to" class="function">to</dd>
                <dd id="DiscreteFieldEmbedder.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="DiscreteFieldEmbedder.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="DiscreteFieldEmbedder.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="DiscreteFieldEmbedder.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="DiscreteFieldEmbedder.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="DiscreteFieldEmbedder.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="DiscreteFieldEmbedder.state_dict" class="function">state_dict</dd>
                <dd id="DiscreteFieldEmbedder.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="DiscreteFieldEmbedder.load_state_dict" class="function">load_state_dict</dd>
                <dd id="DiscreteFieldEmbedder.parameters" class="function">parameters</dd>
                <dd id="DiscreteFieldEmbedder.named_parameters" class="function">named_parameters</dd>
                <dd id="DiscreteFieldEmbedder.buffers" class="function">buffers</dd>
                <dd id="DiscreteFieldEmbedder.named_buffers" class="function">named_buffers</dd>
                <dd id="DiscreteFieldEmbedder.children" class="function">children</dd>
                <dd id="DiscreteFieldEmbedder.named_children" class="function">named_children</dd>
                <dd id="DiscreteFieldEmbedder.modules" class="function">modules</dd>
                <dd id="DiscreteFieldEmbedder.named_modules" class="function">named_modules</dd>
                <dd id="DiscreteFieldEmbedder.train" class="function">train</dd>
                <dd id="DiscreteFieldEmbedder.eval" class="function">eval</dd>
                <dd id="DiscreteFieldEmbedder.requires_grad_" class="function">requires_grad_</dd>
                <dd id="DiscreteFieldEmbedder.zero_grad" class="function">zero_grad</dd>
                <dd id="DiscreteFieldEmbedder.share_memory" class="function">share_memory</dd>
                <dd id="DiscreteFieldEmbedder.extra_repr" class="function">extra_repr</dd>
                <dd id="DiscreteFieldEmbedder.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="EntityFieldEmbedder">
                            <input id="EntityFieldEmbedder-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EntityFieldEmbedder</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="EntityFieldEmbedder-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EntityFieldEmbedder"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EntityFieldEmbedder-176"><a href="#EntityFieldEmbedder-176"><span class="linenos">176</span></a><span class="k">class</span> <span class="nc">EntityFieldEmbedder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="EntityFieldEmbedder-177"><a href="#EntityFieldEmbedder-177"><span class="linenos">177</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
</span><span id="EntityFieldEmbedder-178"><a href="#EntityFieldEmbedder-178"><span class="linenos">178</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="EntityFieldEmbedder-179"><a href="#EntityFieldEmbedder-179"><span class="linenos">179</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EntityFieldEmbedder-180"><a href="#EntityFieldEmbedder-180"><span class="linenos">180</span></a><span class="sd">        Initialize entity field embedder.</span>
</span><span id="EntityFieldEmbedder-181"><a href="#EntityFieldEmbedder-181"><span class="linenos">181</span></a>
</span><span id="EntityFieldEmbedder-182"><a href="#EntityFieldEmbedder-182"><span class="linenos">182</span></a><span class="sd">        Args:</span>
</span><span id="EntityFieldEmbedder-183"><a href="#EntityFieldEmbedder-183"><span class="linenos">183</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="EntityFieldEmbedder-184"><a href="#EntityFieldEmbedder-184"><span class="linenos">184</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EntityFieldEmbedder-185"><a href="#EntityFieldEmbedder-185"><span class="linenos">185</span></a>
</span><span id="EntityFieldEmbedder-186"><a href="#EntityFieldEmbedder-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">field</span>
</span><span id="EntityFieldEmbedder-187"><a href="#EntityFieldEmbedder-187"><span class="linenos">187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_context</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="EntityFieldEmbedder-188"><a href="#EntityFieldEmbedder-188"><span class="linenos">188</span></a>
</span><span id="EntityFieldEmbedder-189"><a href="#EntityFieldEmbedder-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="EntityFieldEmbedder-190"><a href="#EntityFieldEmbedder-190"><span class="linenos">190</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;lookup&quot;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Base class for all neural network modules.</p>

<p>Your models should also subclass this class.</p>

<p>Modules can also contain other Modules, allowing to nest them in
a tree structure. You can assign the submodules as regular attributes::</p>

<pre><code>import torch.nn as nn
import torch.nn.functional as F

class Model(nn.Module):
    def __init__(self):
        super().__init__()
        self.conv1 = nn.Conv2d(1, 20, 5)
        self.conv2 = nn.Conv2d(20, 20, 5)

    def forward(self, x):
        x = F.relu(self.conv1(x))
        return F.relu(self.conv2(x))
</code></pre>

<p>Submodules assigned in this way will be registered, and will have their
parameters converted too when you call <code><a href="#EntityFieldEmbedder.to">to()</a></code>, etc.</p>

<div class="pdoc-alert pdoc-alert-note">

<p>As per the example above, an <code><a href="#EntityFieldEmbedder.__init__">__init__()</a></code> call to the parent class
must be made before assignment on the child.</p>

</div>

<p>:ivar training: Boolean represents whether this module is in training or
                evaluation mode.
:vartype training: bool</p>
</div>


                            <div id="EntityFieldEmbedder.__init__" class="classattr">
                                        <input id="EntityFieldEmbedder.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">EntityFieldEmbedder</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span>,</span><span class="param">	<span class="n">field</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Field</span></span>)</span>

                <label class="view-source-button" for="EntityFieldEmbedder.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EntityFieldEmbedder.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EntityFieldEmbedder.__init__-177"><a href="#EntityFieldEmbedder.__init__-177"><span class="linenos">177</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
</span><span id="EntityFieldEmbedder.__init__-178"><a href="#EntityFieldEmbedder.__init__-178"><span class="linenos">178</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="EntityFieldEmbedder.__init__-179"><a href="#EntityFieldEmbedder.__init__-179"><span class="linenos">179</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EntityFieldEmbedder.__init__-180"><a href="#EntityFieldEmbedder.__init__-180"><span class="linenos">180</span></a><span class="sd">        Initialize entity field embedder.</span>
</span><span id="EntityFieldEmbedder.__init__-181"><a href="#EntityFieldEmbedder.__init__-181"><span class="linenos">181</span></a>
</span><span id="EntityFieldEmbedder.__init__-182"><a href="#EntityFieldEmbedder.__init__-182"><span class="linenos">182</span></a><span class="sd">        Args:</span>
</span><span id="EntityFieldEmbedder.__init__-183"><a href="#EntityFieldEmbedder.__init__-183"><span class="linenos">183</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="EntityFieldEmbedder.__init__-184"><a href="#EntityFieldEmbedder.__init__-184"><span class="linenos">184</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EntityFieldEmbedder.__init__-185"><a href="#EntityFieldEmbedder.__init__-185"><span class="linenos">185</span></a>
</span><span id="EntityFieldEmbedder.__init__-186"><a href="#EntityFieldEmbedder.__init__-186"><span class="linenos">186</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">field</span>
</span><span id="EntityFieldEmbedder.__init__-187"><a href="#EntityFieldEmbedder.__init__-187"><span class="linenos">187</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_context</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize internal Module state, shared by both nn.Module and ScriptModule.</p>
</div>


                            </div>
                            <div id="EntityFieldEmbedder.field" class="classattr">
                                <div class="attr variable">
            <span class="name">field</span><span class="annotation">: source.core.schema.Field</span>

        
    </div>
    <a class="headerlink" href="#EntityFieldEmbedder.field"></a>
    
    

                            </div>
                            <div id="EntityFieldEmbedder.embeddings" class="classattr">
                                <div class="attr variable">
            <span class="name">embeddings</span>

        
    </div>
    <a class="headerlink" href="#EntityFieldEmbedder.embeddings"></a>
    
    

                            </div>
                            <div id="EntityFieldEmbedder.forward" class="classattr">
                                        <input id="EntityFieldEmbedder.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">inputs</span><span class="p">:</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span>:</span></span>

                <label class="view-source-button" for="EntityFieldEmbedder.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EntityFieldEmbedder.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EntityFieldEmbedder.forward-189"><a href="#EntityFieldEmbedder.forward-189"><span class="linenos">189</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span><span class="p">:</span>
</span><span id="EntityFieldEmbedder.forward-190"><a href="#EntityFieldEmbedder.forward-190"><span class="linenos">190</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">embeddings</span><span class="p">(</span><span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;lookup&quot;</span><span class="p">])</span>
</span></pre></div>


            <div class="docstring"><p>Define the computation performed at every call.</p>

<p>Should be overridden by all subclasses.</p>

<div class="pdoc-alert pdoc-alert-note">

<p>Although the recipe for forward pass needs to be defined within
this function, one should call the <code>Module</code> instance afterwards
instead of this since the former takes care of running the
registered hooks while the latter silently ignores them.</p>

</div>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="EntityFieldEmbedder.dump_patches" class="variable">dump_patches</dd>
                <dd id="EntityFieldEmbedder.training" class="variable">training</dd>
                <dd id="EntityFieldEmbedder.call_super_init" class="variable">call_super_init</dd>
                <dd id="EntityFieldEmbedder.register_buffer" class="function">register_buffer</dd>
                <dd id="EntityFieldEmbedder.register_parameter" class="function">register_parameter</dd>
                <dd id="EntityFieldEmbedder.add_module" class="function">add_module</dd>
                <dd id="EntityFieldEmbedder.register_module" class="function">register_module</dd>
                <dd id="EntityFieldEmbedder.get_submodule" class="function">get_submodule</dd>
                <dd id="EntityFieldEmbedder.get_parameter" class="function">get_parameter</dd>
                <dd id="EntityFieldEmbedder.get_buffer" class="function">get_buffer</dd>
                <dd id="EntityFieldEmbedder.get_extra_state" class="function">get_extra_state</dd>
                <dd id="EntityFieldEmbedder.set_extra_state" class="function">set_extra_state</dd>
                <dd id="EntityFieldEmbedder.apply" class="function">apply</dd>
                <dd id="EntityFieldEmbedder.cuda" class="function">cuda</dd>
                <dd id="EntityFieldEmbedder.ipu" class="function">ipu</dd>
                <dd id="EntityFieldEmbedder.xpu" class="function">xpu</dd>
                <dd id="EntityFieldEmbedder.cpu" class="function">cpu</dd>
                <dd id="EntityFieldEmbedder.type" class="function">type</dd>
                <dd id="EntityFieldEmbedder.float" class="function">float</dd>
                <dd id="EntityFieldEmbedder.double" class="function">double</dd>
                <dd id="EntityFieldEmbedder.half" class="function">half</dd>
                <dd id="EntityFieldEmbedder.bfloat16" class="function">bfloat16</dd>
                <dd id="EntityFieldEmbedder.to_empty" class="function">to_empty</dd>
                <dd id="EntityFieldEmbedder.to" class="function">to</dd>
                <dd id="EntityFieldEmbedder.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="EntityFieldEmbedder.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="EntityFieldEmbedder.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="EntityFieldEmbedder.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="EntityFieldEmbedder.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="EntityFieldEmbedder.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="EntityFieldEmbedder.state_dict" class="function">state_dict</dd>
                <dd id="EntityFieldEmbedder.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="EntityFieldEmbedder.load_state_dict" class="function">load_state_dict</dd>
                <dd id="EntityFieldEmbedder.parameters" class="function">parameters</dd>
                <dd id="EntityFieldEmbedder.named_parameters" class="function">named_parameters</dd>
                <dd id="EntityFieldEmbedder.buffers" class="function">buffers</dd>
                <dd id="EntityFieldEmbedder.named_buffers" class="function">named_buffers</dd>
                <dd id="EntityFieldEmbedder.children" class="function">children</dd>
                <dd id="EntityFieldEmbedder.named_children" class="function">named_children</dd>
                <dd id="EntityFieldEmbedder.modules" class="function">modules</dd>
                <dd id="EntityFieldEmbedder.named_modules" class="function">named_modules</dd>
                <dd id="EntityFieldEmbedder.train" class="function">train</dd>
                <dd id="EntityFieldEmbedder.eval" class="function">eval</dd>
                <dd id="EntityFieldEmbedder.requires_grad_" class="function">requires_grad_</dd>
                <dd id="EntityFieldEmbedder.zero_grad" class="function">zero_grad</dd>
                <dd id="EntityFieldEmbedder.share_memory" class="function">share_memory</dd>
                <dd id="EntityFieldEmbedder.extra_repr" class="function">extra_repr</dd>
                <dd id="EntityFieldEmbedder.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ContinuousFieldEmbedder">
                            <input id="ContinuousFieldEmbedder-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ContinuousFieldEmbedder</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="ContinuousFieldEmbedder-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContinuousFieldEmbedder"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContinuousFieldEmbedder-193"><a href="#ContinuousFieldEmbedder-193"><span class="linenos">193</span></a><span class="k">class</span> <span class="nc">ContinuousFieldEmbedder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="ContinuousFieldEmbedder-194"><a href="#ContinuousFieldEmbedder-194"><span class="linenos">194</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder-195"><a href="#ContinuousFieldEmbedder-195"><span class="linenos">195</span></a><span class="sd">    ContinuousFieldEmbedder is a PyTorch module that encodes features using Fourier features.</span>
</span><span id="ContinuousFieldEmbedder-196"><a href="#ContinuousFieldEmbedder-196"><span class="linenos">196</span></a>
</span><span id="ContinuousFieldEmbedder-197"><a href="#ContinuousFieldEmbedder-197"><span class="linenos">197</span></a><span class="sd">    Attributes:</span>
</span><span id="ContinuousFieldEmbedder-198"><a href="#ContinuousFieldEmbedder-198"><span class="linenos">198</span></a><span class="sd">        linear (torch.nn.Linear): A linear layer for transforming the input.</span>
</span><span id="ContinuousFieldEmbedder-199"><a href="#ContinuousFieldEmbedder-199"><span class="linenos">199</span></a><span class="sd">        positional (torch.nn.Embedding): An embedding layer for positional encoding.</span>
</span><span id="ContinuousFieldEmbedder-200"><a href="#ContinuousFieldEmbedder-200"><span class="linenos">200</span></a><span class="sd">        weights (Tensor): The weights for the Fourier features.</span>
</span><span id="ContinuousFieldEmbedder-201"><a href="#ContinuousFieldEmbedder-201"><span class="linenos">201</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder-202"><a href="#ContinuousFieldEmbedder-202"><span class="linenos">202</span></a>
</span><span id="ContinuousFieldEmbedder-203"><a href="#ContinuousFieldEmbedder-203"><span class="linenos">203</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
</span><span id="ContinuousFieldEmbedder-204"><a href="#ContinuousFieldEmbedder-204"><span class="linenos">204</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder-205"><a href="#ContinuousFieldEmbedder-205"><span class="linenos">205</span></a><span class="sd">        Initialize continuous field embedder.</span>
</span><span id="ContinuousFieldEmbedder-206"><a href="#ContinuousFieldEmbedder-206"><span class="linenos">206</span></a>
</span><span id="ContinuousFieldEmbedder-207"><a href="#ContinuousFieldEmbedder-207"><span class="linenos">207</span></a><span class="sd">        Args:</span>
</span><span id="ContinuousFieldEmbedder-208"><a href="#ContinuousFieldEmbedder-208"><span class="linenos">208</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="ContinuousFieldEmbedder-209"><a href="#ContinuousFieldEmbedder-209"><span class="linenos">209</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder-210"><a href="#ContinuousFieldEmbedder-210"><span class="linenos">210</span></a>
</span><span id="ContinuousFieldEmbedder-211"><a href="#ContinuousFieldEmbedder-211"><span class="linenos">211</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="ContinuousFieldEmbedder-212"><a href="#ContinuousFieldEmbedder-212"><span class="linenos">212</span></a>
</span><span id="ContinuousFieldEmbedder-213"><a href="#ContinuousFieldEmbedder-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">field</span>
</span><span id="ContinuousFieldEmbedder-214"><a href="#ContinuousFieldEmbedder-214"><span class="linenos">214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder-215"><a href="#ContinuousFieldEmbedder-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder-216"><a href="#ContinuousFieldEmbedder-216"><span class="linenos">216</span></a>
</span><span id="ContinuousFieldEmbedder-217"><a href="#ContinuousFieldEmbedder-217"><span class="linenos">217</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="n">params</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder-218"><a href="#ContinuousFieldEmbedder-218"><span class="linenos">218</span></a>
</span><span id="ContinuousFieldEmbedder-219"><a href="#ContinuousFieldEmbedder-219"><span class="linenos">219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;weights&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder-220"><a href="#ContinuousFieldEmbedder-220"><span class="linenos">220</span></a>
</span><span id="ContinuousFieldEmbedder-221"><a href="#ContinuousFieldEmbedder-221"><span class="linenos">221</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder-222"><a href="#ContinuousFieldEmbedder-222"><span class="linenos">222</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="ContinuousFieldEmbedder-223"><a href="#ContinuousFieldEmbedder-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ContinuousFieldEmbedder-224"><a href="#ContinuousFieldEmbedder-224"><span class="linenos">224</span></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Int</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L&quot;</span><span class="p">]],</span>
</span><span id="ContinuousFieldEmbedder-225"><a href="#ContinuousFieldEmbedder-225"><span class="linenos">225</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L F&quot;</span><span class="p">]:</span>
</span><span id="ContinuousFieldEmbedder-226"><a href="#ContinuousFieldEmbedder-226"><span class="linenos">226</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder-227"><a href="#ContinuousFieldEmbedder-227"><span class="linenos">227</span></a><span class="sd">        Performs the forward pass of the FourierFeatureEncoder.</span>
</span><span id="ContinuousFieldEmbedder-228"><a href="#ContinuousFieldEmbedder-228"><span class="linenos">228</span></a>
</span><span id="ContinuousFieldEmbedder-229"><a href="#ContinuousFieldEmbedder-229"><span class="linenos">229</span></a><span class="sd">        Args:</span>
</span><span id="ContinuousFieldEmbedder-230"><a href="#ContinuousFieldEmbedder-230"><span class="linenos">230</span></a><span class="sd">            inputs (Float[Tensor, &quot;N L&quot;]): The input tensor.</span>
</span><span id="ContinuousFieldEmbedder-231"><a href="#ContinuousFieldEmbedder-231"><span class="linenos">231</span></a>
</span><span id="ContinuousFieldEmbedder-232"><a href="#ContinuousFieldEmbedder-232"><span class="linenos">232</span></a><span class="sd">        Returns:</span>
</span><span id="ContinuousFieldEmbedder-233"><a href="#ContinuousFieldEmbedder-233"><span class="linenos">233</span></a><span class="sd">            Float[Tensor, &quot;N L F&quot;]: The Fourier features of the input.</span>
</span><span id="ContinuousFieldEmbedder-234"><a href="#ContinuousFieldEmbedder-234"><span class="linenos">234</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder-235"><a href="#ContinuousFieldEmbedder-235"><span class="linenos">235</span></a>
</span><span id="ContinuousFieldEmbedder-236"><a href="#ContinuousFieldEmbedder-236"><span class="linenos">236</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
</span><span id="ContinuousFieldEmbedder-237"><a href="#ContinuousFieldEmbedder-237"><span class="linenos">237</span></a>        <span class="n">indicators</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;lookup&quot;</span><span class="p">]</span>
</span><span id="ContinuousFieldEmbedder-238"><a href="#ContinuousFieldEmbedder-238"><span class="linenos">238</span></a>
</span><span id="ContinuousFieldEmbedder-239"><a href="#ContinuousFieldEmbedder-239"><span class="linenos">239</span></a>        <span class="k">assert</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">indicators</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;values and indicators must always have the same shape&quot;</span>
</span><span id="ContinuousFieldEmbedder-240"><a href="#ContinuousFieldEmbedder-240"><span class="linenos">240</span></a>
</span><span id="ContinuousFieldEmbedder-241"><a href="#ContinuousFieldEmbedder-241"><span class="linenos">241</span></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">indicators</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span> <span class="s2">&quot;values should be imputed if not null, padded, or masked&quot;</span>
</span><span id="ContinuousFieldEmbedder-242"><a href="#ContinuousFieldEmbedder-242"><span class="linenos">242</span></a>
</span><span id="ContinuousFieldEmbedder-243"><a href="#ContinuousFieldEmbedder-243"><span class="linenos">243</span></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)),</span> <span class="s2">&quot;values should be less than or equal to 1.0&quot;</span>
</span><span id="ContinuousFieldEmbedder-244"><a href="#ContinuousFieldEmbedder-244"><span class="linenos">244</span></a>
</span><span id="ContinuousFieldEmbedder-245"><a href="#ContinuousFieldEmbedder-245"><span class="linenos">245</span></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span> <span class="s2">&quot;values should be greater than or equal to 0.0&quot;</span>
</span><span id="ContinuousFieldEmbedder-246"><a href="#ContinuousFieldEmbedder-246"><span class="linenos">246</span></a>
</span><span id="ContinuousFieldEmbedder-247"><a href="#ContinuousFieldEmbedder-247"><span class="linenos">247</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span>
</span><span id="ContinuousFieldEmbedder-248"><a href="#ContinuousFieldEmbedder-248"><span class="linenos">248</span></a>
</span><span id="ContinuousFieldEmbedder-249"><a href="#ContinuousFieldEmbedder-249"><span class="linenos">249</span></a>        <span class="c1"># weight inputs with buffers of precision bands</span>
</span><span id="ContinuousFieldEmbedder-250"><a href="#ContinuousFieldEmbedder-250"><span class="linenos">250</span></a>        <span class="n">weighted</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder-251"><a href="#ContinuousFieldEmbedder-251"><span class="linenos">251</span></a>
</span><span id="ContinuousFieldEmbedder-252"><a href="#ContinuousFieldEmbedder-252"><span class="linenos">252</span></a>        <span class="c1"># apply sine and cosine functions to weighted inputs</span>
</span><span id="ContinuousFieldEmbedder-253"><a href="#ContinuousFieldEmbedder-253"><span class="linenos">253</span></a>        <span class="n">fourier</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">weighted</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">weighted</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder-254"><a href="#ContinuousFieldEmbedder-254"><span class="linenos">254</span></a>
</span><span id="ContinuousFieldEmbedder-255"><a href="#ContinuousFieldEmbedder-255"><span class="linenos">255</span></a>        <span class="c1"># project sinusoidal representations with MLP</span>
</span><span id="ContinuousFieldEmbedder-256"><a href="#ContinuousFieldEmbedder-256"><span class="linenos">256</span></a>        <span class="n">projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">fourier</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder-257"><a href="#ContinuousFieldEmbedder-257"><span class="linenos">257</span></a>
</span><span id="ContinuousFieldEmbedder-258"><a href="#ContinuousFieldEmbedder-258"><span class="linenos">258</span></a>        <span class="c1"># embed null indicators</span>
</span><span id="ContinuousFieldEmbedder-259"><a href="#ContinuousFieldEmbedder-259"><span class="linenos">259</span></a>        <span class="n">positional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">(</span><span class="n">indicators</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder-260"><a href="#ContinuousFieldEmbedder-260"><span class="linenos">260</span></a>
</span><span id="ContinuousFieldEmbedder-261"><a href="#ContinuousFieldEmbedder-261"><span class="linenos">261</span></a>        <span class="k">return</span> <span class="n">projections</span> <span class="o">+</span> <span class="n">positional</span>
</span></pre></div>


            <div class="docstring"><p>ContinuousFieldEmbedder is a PyTorch module that encodes features using Fourier features.</p>

<p>Attributes:
    linear (torch.nn.Linear): A linear layer for transforming the input.
    positional (torch.nn.Embedding): An embedding layer for positional encoding.
    weights (Tensor): The weights for the Fourier features.</p>
</div>


                            <div id="ContinuousFieldEmbedder.__init__" class="classattr">
                                        <input id="ContinuousFieldEmbedder.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ContinuousFieldEmbedder</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span>,</span><span class="param">	<span class="n">field</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Field</span></span>)</span>

                <label class="view-source-button" for="ContinuousFieldEmbedder.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContinuousFieldEmbedder.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContinuousFieldEmbedder.__init__-203"><a href="#ContinuousFieldEmbedder.__init__-203"><span class="linenos">203</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span> <span class="n">field</span><span class="p">:</span> <span class="n">Field</span><span class="p">):</span>
</span><span id="ContinuousFieldEmbedder.__init__-204"><a href="#ContinuousFieldEmbedder.__init__-204"><span class="linenos">204</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder.__init__-205"><a href="#ContinuousFieldEmbedder.__init__-205"><span class="linenos">205</span></a><span class="sd">        Initialize continuous field embedder.</span>
</span><span id="ContinuousFieldEmbedder.__init__-206"><a href="#ContinuousFieldEmbedder.__init__-206"><span class="linenos">206</span></a>
</span><span id="ContinuousFieldEmbedder.__init__-207"><a href="#ContinuousFieldEmbedder.__init__-207"><span class="linenos">207</span></a><span class="sd">        Args:</span>
</span><span id="ContinuousFieldEmbedder.__init__-208"><a href="#ContinuousFieldEmbedder.__init__-208"><span class="linenos">208</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="ContinuousFieldEmbedder.__init__-209"><a href="#ContinuousFieldEmbedder.__init__-209"><span class="linenos">209</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder.__init__-210"><a href="#ContinuousFieldEmbedder.__init__-210"><span class="linenos">210</span></a>
</span><span id="ContinuousFieldEmbedder.__init__-211"><a href="#ContinuousFieldEmbedder.__init__-211"><span class="linenos">211</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="ContinuousFieldEmbedder.__init__-212"><a href="#ContinuousFieldEmbedder.__init__-212"><span class="linenos">212</span></a>
</span><span id="ContinuousFieldEmbedder.__init__-213"><a href="#ContinuousFieldEmbedder.__init__-213"><span class="linenos">213</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field</span><span class="p">:</span> <span class="n">Field</span> <span class="o">=</span> <span class="n">field</span>
</span><span id="ContinuousFieldEmbedder.__init__-214"><a href="#ContinuousFieldEmbedder.__init__-214"><span class="linenos">214</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder.__init__-215"><a href="#ContinuousFieldEmbedder.__init__-215"><span class="linenos">215</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Embedding</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder.__init__-216"><a href="#ContinuousFieldEmbedder.__init__-216"><span class="linenos">216</span></a>
</span><span id="ContinuousFieldEmbedder.__init__-217"><a href="#ContinuousFieldEmbedder.__init__-217"><span class="linenos">217</span></a>        <span class="n">weights</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="o">-</span><span class="n">params</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">precision</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder.__init__-218"><a href="#ContinuousFieldEmbedder.__init__-218"><span class="linenos">218</span></a>
</span><span id="ContinuousFieldEmbedder.__init__-219"><a href="#ContinuousFieldEmbedder.__init__-219"><span class="linenos">219</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">register_buffer</span><span class="p">(</span><span class="s2">&quot;weights&quot;</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize continuous field embedder.</p>

<p>Args:
    params (Hyperparameters): The hyperparameters for the architecture.</p>
</div>


                            </div>
                            <div id="ContinuousFieldEmbedder.field" class="classattr">
                                <div class="attr variable">
            <span class="name">field</span><span class="annotation">: source.core.schema.Field</span>

        
    </div>
    <a class="headerlink" href="#ContinuousFieldEmbedder.field"></a>
    
    

                            </div>
                            <div id="ContinuousFieldEmbedder.linear" class="classattr">
                                <div class="attr variable">
            <span class="name">linear</span>

        
    </div>
    <a class="headerlink" href="#ContinuousFieldEmbedder.linear"></a>
    
    

                            </div>
                            <div id="ContinuousFieldEmbedder.positional" class="classattr">
                                <div class="attr variable">
            <span class="name">positional</span>

        
    </div>
    <a class="headerlink" href="#ContinuousFieldEmbedder.positional"></a>
    
    

                            </div>
                            <div id="ContinuousFieldEmbedder.forward" class="classattr">
                                        <input id="ContinuousFieldEmbedder.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jaxtyped(typechecker=beartype)</div>

        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">inputs</span><span class="p">:</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span><span class="p">[</span><span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L&#39;</span><span class="p">]</span> <span class="o">|</span> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Int</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L&#39;</span><span class="p">]]</span></span><span class="return-annotation">) -> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L F&#39;</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ContinuousFieldEmbedder.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ContinuousFieldEmbedder.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ContinuousFieldEmbedder.forward-221"><a href="#ContinuousFieldEmbedder.forward-221"><span class="linenos">221</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder.forward-222"><a href="#ContinuousFieldEmbedder.forward-222"><span class="linenos">222</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="ContinuousFieldEmbedder.forward-223"><a href="#ContinuousFieldEmbedder.forward-223"><span class="linenos">223</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="ContinuousFieldEmbedder.forward-224"><a href="#ContinuousFieldEmbedder.forward-224"><span class="linenos">224</span></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="n">Int</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L&quot;</span><span class="p">]],</span>
</span><span id="ContinuousFieldEmbedder.forward-225"><a href="#ContinuousFieldEmbedder.forward-225"><span class="linenos">225</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L F&quot;</span><span class="p">]:</span>
</span><span id="ContinuousFieldEmbedder.forward-226"><a href="#ContinuousFieldEmbedder.forward-226"><span class="linenos">226</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder.forward-227"><a href="#ContinuousFieldEmbedder.forward-227"><span class="linenos">227</span></a><span class="sd">        Performs the forward pass of the FourierFeatureEncoder.</span>
</span><span id="ContinuousFieldEmbedder.forward-228"><a href="#ContinuousFieldEmbedder.forward-228"><span class="linenos">228</span></a>
</span><span id="ContinuousFieldEmbedder.forward-229"><a href="#ContinuousFieldEmbedder.forward-229"><span class="linenos">229</span></a><span class="sd">        Args:</span>
</span><span id="ContinuousFieldEmbedder.forward-230"><a href="#ContinuousFieldEmbedder.forward-230"><span class="linenos">230</span></a><span class="sd">            inputs (Float[Tensor, &quot;N L&quot;]): The input tensor.</span>
</span><span id="ContinuousFieldEmbedder.forward-231"><a href="#ContinuousFieldEmbedder.forward-231"><span class="linenos">231</span></a>
</span><span id="ContinuousFieldEmbedder.forward-232"><a href="#ContinuousFieldEmbedder.forward-232"><span class="linenos">232</span></a><span class="sd">        Returns:</span>
</span><span id="ContinuousFieldEmbedder.forward-233"><a href="#ContinuousFieldEmbedder.forward-233"><span class="linenos">233</span></a><span class="sd">            Float[Tensor, &quot;N L F&quot;]: The Fourier features of the input.</span>
</span><span id="ContinuousFieldEmbedder.forward-234"><a href="#ContinuousFieldEmbedder.forward-234"><span class="linenos">234</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ContinuousFieldEmbedder.forward-235"><a href="#ContinuousFieldEmbedder.forward-235"><span class="linenos">235</span></a>
</span><span id="ContinuousFieldEmbedder.forward-236"><a href="#ContinuousFieldEmbedder.forward-236"><span class="linenos">236</span></a>        <span class="n">values</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;values&quot;</span><span class="p">]</span>
</span><span id="ContinuousFieldEmbedder.forward-237"><a href="#ContinuousFieldEmbedder.forward-237"><span class="linenos">237</span></a>        <span class="n">indicators</span> <span class="o">=</span> <span class="n">inputs</span><span class="p">[</span><span class="s2">&quot;lookup&quot;</span><span class="p">]</span>
</span><span id="ContinuousFieldEmbedder.forward-238"><a href="#ContinuousFieldEmbedder.forward-238"><span class="linenos">238</span></a>
</span><span id="ContinuousFieldEmbedder.forward-239"><a href="#ContinuousFieldEmbedder.forward-239"><span class="linenos">239</span></a>        <span class="k">assert</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="n">indicators</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s2">&quot;values and indicators must always have the same shape&quot;</span>
</span><span id="ContinuousFieldEmbedder.forward-240"><a href="#ContinuousFieldEmbedder.forward-240"><span class="linenos">240</span></a>
</span><span id="ContinuousFieldEmbedder.forward-241"><a href="#ContinuousFieldEmbedder.forward-241"><span class="linenos">241</span></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="n">indicators</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span> <span class="s2">&quot;values should be imputed if not null, padded, or masked&quot;</span>
</span><span id="ContinuousFieldEmbedder.forward-242"><a href="#ContinuousFieldEmbedder.forward-242"><span class="linenos">242</span></a>
</span><span id="ContinuousFieldEmbedder.forward-243"><a href="#ContinuousFieldEmbedder.forward-243"><span class="linenos">243</span></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">le</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)),</span> <span class="s2">&quot;values should be less than or equal to 1.0&quot;</span>
</span><span id="ContinuousFieldEmbedder.forward-244"><a href="#ContinuousFieldEmbedder.forward-244"><span class="linenos">244</span></a>
</span><span id="ContinuousFieldEmbedder.forward-245"><a href="#ContinuousFieldEmbedder.forward-245"><span class="linenos">245</span></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">values</span><span class="o">.</span><span class="n">ge</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)),</span> <span class="s2">&quot;values should be greater than or equal to 0.0&quot;</span>
</span><span id="ContinuousFieldEmbedder.forward-246"><a href="#ContinuousFieldEmbedder.forward-246"><span class="linenos">246</span></a>
</span><span id="ContinuousFieldEmbedder.forward-247"><a href="#ContinuousFieldEmbedder.forward-247"><span class="linenos">247</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">L</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">shape</span>
</span><span id="ContinuousFieldEmbedder.forward-248"><a href="#ContinuousFieldEmbedder.forward-248"><span class="linenos">248</span></a>
</span><span id="ContinuousFieldEmbedder.forward-249"><a href="#ContinuousFieldEmbedder.forward-249"><span class="linenos">249</span></a>        <span class="c1"># weight inputs with buffers of precision bands</span>
</span><span id="ContinuousFieldEmbedder.forward-250"><a href="#ContinuousFieldEmbedder.forward-250"><span class="linenos">250</span></a>        <span class="n">weighted</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">mul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">weights</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder.forward-251"><a href="#ContinuousFieldEmbedder.forward-251"><span class="linenos">251</span></a>
</span><span id="ContinuousFieldEmbedder.forward-252"><a href="#ContinuousFieldEmbedder.forward-252"><span class="linenos">252</span></a>        <span class="c1"># apply sine and cosine functions to weighted inputs</span>
</span><span id="ContinuousFieldEmbedder.forward-253"><a href="#ContinuousFieldEmbedder.forward-253"><span class="linenos">253</span></a>        <span class="n">fourier</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">weighted</span><span class="p">),</span> <span class="n">torch</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">weighted</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder.forward-254"><a href="#ContinuousFieldEmbedder.forward-254"><span class="linenos">254</span></a>
</span><span id="ContinuousFieldEmbedder.forward-255"><a href="#ContinuousFieldEmbedder.forward-255"><span class="linenos">255</span></a>        <span class="c1"># project sinusoidal representations with MLP</span>
</span><span id="ContinuousFieldEmbedder.forward-256"><a href="#ContinuousFieldEmbedder.forward-256"><span class="linenos">256</span></a>        <span class="n">projections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">(</span><span class="n">fourier</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder.forward-257"><a href="#ContinuousFieldEmbedder.forward-257"><span class="linenos">257</span></a>
</span><span id="ContinuousFieldEmbedder.forward-258"><a href="#ContinuousFieldEmbedder.forward-258"><span class="linenos">258</span></a>        <span class="c1"># embed null indicators</span>
</span><span id="ContinuousFieldEmbedder.forward-259"><a href="#ContinuousFieldEmbedder.forward-259"><span class="linenos">259</span></a>        <span class="n">positional</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">(</span><span class="n">indicators</span><span class="p">)</span>
</span><span id="ContinuousFieldEmbedder.forward-260"><a href="#ContinuousFieldEmbedder.forward-260"><span class="linenos">260</span></a>
</span><span id="ContinuousFieldEmbedder.forward-261"><a href="#ContinuousFieldEmbedder.forward-261"><span class="linenos">261</span></a>        <span class="k">return</span> <span class="n">projections</span> <span class="o">+</span> <span class="n">positional</span>
</span></pre></div>


            <div class="docstring"><p>Performs the forward pass of the FourierFeatureEncoder.</p>

<p>Args:
    inputs (Float[Tensor, "N L"]): The input tensor.</p>

<p>Returns:
    Float[Tensor, "N L F"]: The Fourier features of the input.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="ContinuousFieldEmbedder.dump_patches" class="variable">dump_patches</dd>
                <dd id="ContinuousFieldEmbedder.training" class="variable">training</dd>
                <dd id="ContinuousFieldEmbedder.call_super_init" class="variable">call_super_init</dd>
                <dd id="ContinuousFieldEmbedder.register_buffer" class="function">register_buffer</dd>
                <dd id="ContinuousFieldEmbedder.register_parameter" class="function">register_parameter</dd>
                <dd id="ContinuousFieldEmbedder.add_module" class="function">add_module</dd>
                <dd id="ContinuousFieldEmbedder.register_module" class="function">register_module</dd>
                <dd id="ContinuousFieldEmbedder.get_submodule" class="function">get_submodule</dd>
                <dd id="ContinuousFieldEmbedder.get_parameter" class="function">get_parameter</dd>
                <dd id="ContinuousFieldEmbedder.get_buffer" class="function">get_buffer</dd>
                <dd id="ContinuousFieldEmbedder.get_extra_state" class="function">get_extra_state</dd>
                <dd id="ContinuousFieldEmbedder.set_extra_state" class="function">set_extra_state</dd>
                <dd id="ContinuousFieldEmbedder.apply" class="function">apply</dd>
                <dd id="ContinuousFieldEmbedder.cuda" class="function">cuda</dd>
                <dd id="ContinuousFieldEmbedder.ipu" class="function">ipu</dd>
                <dd id="ContinuousFieldEmbedder.xpu" class="function">xpu</dd>
                <dd id="ContinuousFieldEmbedder.cpu" class="function">cpu</dd>
                <dd id="ContinuousFieldEmbedder.type" class="function">type</dd>
                <dd id="ContinuousFieldEmbedder.float" class="function">float</dd>
                <dd id="ContinuousFieldEmbedder.double" class="function">double</dd>
                <dd id="ContinuousFieldEmbedder.half" class="function">half</dd>
                <dd id="ContinuousFieldEmbedder.bfloat16" class="function">bfloat16</dd>
                <dd id="ContinuousFieldEmbedder.to_empty" class="function">to_empty</dd>
                <dd id="ContinuousFieldEmbedder.to" class="function">to</dd>
                <dd id="ContinuousFieldEmbedder.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="ContinuousFieldEmbedder.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="ContinuousFieldEmbedder.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="ContinuousFieldEmbedder.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="ContinuousFieldEmbedder.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="ContinuousFieldEmbedder.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="ContinuousFieldEmbedder.state_dict" class="function">state_dict</dd>
                <dd id="ContinuousFieldEmbedder.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="ContinuousFieldEmbedder.load_state_dict" class="function">load_state_dict</dd>
                <dd id="ContinuousFieldEmbedder.parameters" class="function">parameters</dd>
                <dd id="ContinuousFieldEmbedder.named_parameters" class="function">named_parameters</dd>
                <dd id="ContinuousFieldEmbedder.buffers" class="function">buffers</dd>
                <dd id="ContinuousFieldEmbedder.named_buffers" class="function">named_buffers</dd>
                <dd id="ContinuousFieldEmbedder.children" class="function">children</dd>
                <dd id="ContinuousFieldEmbedder.named_children" class="function">named_children</dd>
                <dd id="ContinuousFieldEmbedder.modules" class="function">modules</dd>
                <dd id="ContinuousFieldEmbedder.named_modules" class="function">named_modules</dd>
                <dd id="ContinuousFieldEmbedder.train" class="function">train</dd>
                <dd id="ContinuousFieldEmbedder.eval" class="function">eval</dd>
                <dd id="ContinuousFieldEmbedder.requires_grad_" class="function">requires_grad_</dd>
                <dd id="ContinuousFieldEmbedder.zero_grad" class="function">zero_grad</dd>
                <dd id="ContinuousFieldEmbedder.share_memory" class="function">share_memory</dd>
                <dd id="ContinuousFieldEmbedder.extra_repr" class="function">extra_repr</dd>
                <dd id="ContinuousFieldEmbedder.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="ModularAttributeEmbeddingSystem">
                            <input id="ModularAttributeEmbeddingSystem-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">ModularAttributeEmbeddingSystem</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="ModularAttributeEmbeddingSystem-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ModularAttributeEmbeddingSystem"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ModularAttributeEmbeddingSystem-264"><a href="#ModularAttributeEmbeddingSystem-264"><span class="linenos">264</span></a><span class="k">class</span> <span class="nc">ModularAttributeEmbeddingSystem</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="ModularAttributeEmbeddingSystem-265"><a href="#ModularAttributeEmbeddingSystem-265"><span class="linenos">265</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem-266"><a href="#ModularAttributeEmbeddingSystem-266"><span class="linenos">266</span></a><span class="sd">    ModularAttributeEmbeddingSystem is a PyTorch module for embedding fields.</span>
</span><span id="ModularAttributeEmbeddingSystem-267"><a href="#ModularAttributeEmbeddingSystem-267"><span class="linenos">267</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem-268"><a href="#ModularAttributeEmbeddingSystem-268"><span class="linenos">268</span></a>
</span><span id="ModularAttributeEmbeddingSystem-269"><a href="#ModularAttributeEmbeddingSystem-269"><span class="linenos">269</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="ModularAttributeEmbeddingSystem-270"><a href="#ModularAttributeEmbeddingSystem-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem-271"><a href="#ModularAttributeEmbeddingSystem-271"><span class="linenos">271</span></a><span class="sd">        Initialize moduler field embedder.</span>
</span><span id="ModularAttributeEmbeddingSystem-272"><a href="#ModularAttributeEmbeddingSystem-272"><span class="linenos">272</span></a>
</span><span id="ModularAttributeEmbeddingSystem-273"><a href="#ModularAttributeEmbeddingSystem-273"><span class="linenos">273</span></a><span class="sd">        Args:</span>
</span><span id="ModularAttributeEmbeddingSystem-274"><a href="#ModularAttributeEmbeddingSystem-274"><span class="linenos">274</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="ModularAttributeEmbeddingSystem-275"><a href="#ModularAttributeEmbeddingSystem-275"><span class="linenos">275</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem-276"><a href="#ModularAttributeEmbeddingSystem-276"><span class="linenos">276</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="ModularAttributeEmbeddingSystem-277"><a href="#ModularAttributeEmbeddingSystem-277"><span class="linenos">277</span></a>
</span><span id="ModularAttributeEmbeddingSystem-278"><a href="#ModularAttributeEmbeddingSystem-278"><span class="linenos">278</span></a>        <span class="n">embedders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ModularAttributeEmbeddingSystem-279"><a href="#ModularAttributeEmbeddingSystem-279"><span class="linenos">279</span></a>
</span><span id="ModularAttributeEmbeddingSystem-280"><a href="#ModularAttributeEmbeddingSystem-280"><span class="linenos">280</span></a>        <span class="n">encoders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ModularAttributeEmbeddingSystem-281"><a href="#ModularAttributeEmbeddingSystem-281"><span class="linenos">281</span></a>            <span class="n">discrete</span><span class="o">=</span><span class="n">DiscreteFieldEmbedder</span><span class="p">,</span>
</span><span id="ModularAttributeEmbeddingSystem-282"><a href="#ModularAttributeEmbeddingSystem-282"><span class="linenos">282</span></a>            <span class="n">continuous</span><span class="o">=</span><span class="n">ContinuousFieldEmbedder</span><span class="p">,</span>
</span><span id="ModularAttributeEmbeddingSystem-283"><a href="#ModularAttributeEmbeddingSystem-283"><span class="linenos">283</span></a>            <span class="n">entity</span><span class="o">=</span><span class="n">EntityFieldEmbedder</span><span class="p">,</span>
</span><span id="ModularAttributeEmbeddingSystem-284"><a href="#ModularAttributeEmbeddingSystem-284"><span class="linenos">284</span></a>        <span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem-285"><a href="#ModularAttributeEmbeddingSystem-285"><span class="linenos">285</span></a>
</span><span id="ModularAttributeEmbeddingSystem-286"><a href="#ModularAttributeEmbeddingSystem-286"><span class="linenos">286</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
</span><span id="ModularAttributeEmbeddingSystem-287"><a href="#ModularAttributeEmbeddingSystem-287"><span class="linenos">287</span></a>            <span class="n">embedders</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoders</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">](</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem-288"><a href="#ModularAttributeEmbeddingSystem-288"><span class="linenos">288</span></a>
</span><span id="ModularAttributeEmbeddingSystem-289"><a href="#ModularAttributeEmbeddingSystem-289"><span class="linenos">289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">embedders</span><span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem-290"><a href="#ModularAttributeEmbeddingSystem-290"><span class="linenos">290</span></a>
</span><span id="ModularAttributeEmbeddingSystem-291"><a href="#ModularAttributeEmbeddingSystem-291"><span class="linenos">291</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem-292"><a href="#ModularAttributeEmbeddingSystem-292"><span class="linenos">292</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L F C&quot;</span><span class="p">]:</span>
</span><span id="ModularAttributeEmbeddingSystem-293"><a href="#ModularAttributeEmbeddingSystem-293"><span class="linenos">293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem-294"><a href="#ModularAttributeEmbeddingSystem-294"><span class="linenos">294</span></a><span class="sd">        Performs the forward pass of the ModularAttributeEmbeddingSystem.</span>
</span><span id="ModularAttributeEmbeddingSystem-295"><a href="#ModularAttributeEmbeddingSystem-295"><span class="linenos">295</span></a>
</span><span id="ModularAttributeEmbeddingSystem-296"><a href="#ModularAttributeEmbeddingSystem-296"><span class="linenos">296</span></a><span class="sd">        Args:</span>
</span><span id="ModularAttributeEmbeddingSystem-297"><a href="#ModularAttributeEmbeddingSystem-297"><span class="linenos">297</span></a><span class="sd">            inputs (TensorDict[Float[Tensor, &quot;N L&quot;] | Int[Tensor, &quot;N L&quot;]]): The input tensor.</span>
</span><span id="ModularAttributeEmbeddingSystem-298"><a href="#ModularAttributeEmbeddingSystem-298"><span class="linenos">298</span></a>
</span><span id="ModularAttributeEmbeddingSystem-299"><a href="#ModularAttributeEmbeddingSystem-299"><span class="linenos">299</span></a><span class="sd">        Returns:</span>
</span><span id="ModularAttributeEmbeddingSystem-300"><a href="#ModularAttributeEmbeddingSystem-300"><span class="linenos">300</span></a><span class="sd">            Float[Tensor, &quot;N L F&quot;]: The embedded fields.</span>
</span><span id="ModularAttributeEmbeddingSystem-301"><a href="#ModularAttributeEmbeddingSystem-301"><span class="linenos">301</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem-302"><a href="#ModularAttributeEmbeddingSystem-302"><span class="linenos">302</span></a>
</span><span id="ModularAttributeEmbeddingSystem-303"><a href="#ModularAttributeEmbeddingSystem-303"><span class="linenos">303</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ModularAttributeEmbeddingSystem-304"><a href="#ModularAttributeEmbeddingSystem-304"><span class="linenos">304</span></a>
</span><span id="ModularAttributeEmbeddingSystem-305"><a href="#ModularAttributeEmbeddingSystem-305"><span class="linenos">305</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ModularAttributeEmbeddingSystem-306"><a href="#ModularAttributeEmbeddingSystem-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ModularAttributeEmbeddingSystem-307"><a href="#ModularAttributeEmbeddingSystem-307"><span class="linenos">307</span></a>                <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span><span class="p">[</span><span class="n">field</span><span class="p">](</span><span class="n">inputs</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
</span><span id="ModularAttributeEmbeddingSystem-308"><a href="#ModularAttributeEmbeddingSystem-308"><span class="linenos">308</span></a>                <span class="n">embeddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem-309"><a href="#ModularAttributeEmbeddingSystem-309"><span class="linenos">309</span></a>
</span><span id="ModularAttributeEmbeddingSystem-310"><a href="#ModularAttributeEmbeddingSystem-310"><span class="linenos">310</span></a>        <span class="c1"># N L C F</span>
</span><span id="ModularAttributeEmbeddingSystem-311"><a href="#ModularAttributeEmbeddingSystem-311"><span class="linenos">311</span></a>        <span class="n">stacked</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem-312"><a href="#ModularAttributeEmbeddingSystem-312"><span class="linenos">312</span></a>
</span><span id="ModularAttributeEmbeddingSystem-313"><a href="#ModularAttributeEmbeddingSystem-313"><span class="linenos">313</span></a>        <span class="c1"># N L F C</span>
</span><span id="ModularAttributeEmbeddingSystem-314"><a href="#ModularAttributeEmbeddingSystem-314"><span class="linenos">314</span></a>        <span class="k">return</span> <span class="n">stacked</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>ModularAttributeEmbeddingSystem is a PyTorch module for embedding fields.</p>
</div>


                            <div id="ModularAttributeEmbeddingSystem.__init__" class="classattr">
                                        <input id="ModularAttributeEmbeddingSystem.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">ModularAttributeEmbeddingSystem</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span></span>)</span>

                <label class="view-source-button" for="ModularAttributeEmbeddingSystem.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ModularAttributeEmbeddingSystem.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ModularAttributeEmbeddingSystem.__init__-269"><a href="#ModularAttributeEmbeddingSystem.__init__-269"><span class="linenos">269</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-270"><a href="#ModularAttributeEmbeddingSystem.__init__-270"><span class="linenos">270</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-271"><a href="#ModularAttributeEmbeddingSystem.__init__-271"><span class="linenos">271</span></a><span class="sd">        Initialize moduler field embedder.</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-272"><a href="#ModularAttributeEmbeddingSystem.__init__-272"><span class="linenos">272</span></a>
</span><span id="ModularAttributeEmbeddingSystem.__init__-273"><a href="#ModularAttributeEmbeddingSystem.__init__-273"><span class="linenos">273</span></a><span class="sd">        Args:</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-274"><a href="#ModularAttributeEmbeddingSystem.__init__-274"><span class="linenos">274</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-275"><a href="#ModularAttributeEmbeddingSystem.__init__-275"><span class="linenos">275</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-276"><a href="#ModularAttributeEmbeddingSystem.__init__-276"><span class="linenos">276</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-277"><a href="#ModularAttributeEmbeddingSystem.__init__-277"><span class="linenos">277</span></a>
</span><span id="ModularAttributeEmbeddingSystem.__init__-278"><a href="#ModularAttributeEmbeddingSystem.__init__-278"><span class="linenos">278</span></a>        <span class="n">embedders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-279"><a href="#ModularAttributeEmbeddingSystem.__init__-279"><span class="linenos">279</span></a>
</span><span id="ModularAttributeEmbeddingSystem.__init__-280"><a href="#ModularAttributeEmbeddingSystem.__init__-280"><span class="linenos">280</span></a>        <span class="n">encoders</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-281"><a href="#ModularAttributeEmbeddingSystem.__init__-281"><span class="linenos">281</span></a>            <span class="n">discrete</span><span class="o">=</span><span class="n">DiscreteFieldEmbedder</span><span class="p">,</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-282"><a href="#ModularAttributeEmbeddingSystem.__init__-282"><span class="linenos">282</span></a>            <span class="n">continuous</span><span class="o">=</span><span class="n">ContinuousFieldEmbedder</span><span class="p">,</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-283"><a href="#ModularAttributeEmbeddingSystem.__init__-283"><span class="linenos">283</span></a>            <span class="n">entity</span><span class="o">=</span><span class="n">EntityFieldEmbedder</span><span class="p">,</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-284"><a href="#ModularAttributeEmbeddingSystem.__init__-284"><span class="linenos">284</span></a>        <span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-285"><a href="#ModularAttributeEmbeddingSystem.__init__-285"><span class="linenos">285</span></a>
</span><span id="ModularAttributeEmbeddingSystem.__init__-286"><a href="#ModularAttributeEmbeddingSystem.__init__-286"><span class="linenos">286</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-287"><a href="#ModularAttributeEmbeddingSystem.__init__-287"><span class="linenos">287</span></a>            <span class="n">embedders</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">encoders</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">](</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span> <span class="n">field</span><span class="o">=</span><span class="n">field</span><span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem.__init__-288"><a href="#ModularAttributeEmbeddingSystem.__init__-288"><span class="linenos">288</span></a>
</span><span id="ModularAttributeEmbeddingSystem.__init__-289"><a href="#ModularAttributeEmbeddingSystem.__init__-289"><span class="linenos">289</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">embedders</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize moduler field embedder.</p>

<p>Args:
    params (Hyperparameters): The hyperparameters for the architecture.</p>
</div>


                            </div>
                            <div id="ModularAttributeEmbeddingSystem.embedders" class="classattr">
                                <div class="attr variable">
            <span class="name">embedders</span>

        
    </div>
    <a class="headerlink" href="#ModularAttributeEmbeddingSystem.embedders"></a>
    
    

                            </div>
                            <div id="ModularAttributeEmbeddingSystem.forward" class="classattr">
                                        <input id="ModularAttributeEmbeddingSystem.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jaxtyped(typechecker=beartype)</div>

        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">inputs</span><span class="p">:</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span></span><span class="return-annotation">) -> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L F C&#39;</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="ModularAttributeEmbeddingSystem.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#ModularAttributeEmbeddingSystem.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="ModularAttributeEmbeddingSystem.forward-291"><a href="#ModularAttributeEmbeddingSystem.forward-291"><span class="linenos">291</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-292"><a href="#ModularAttributeEmbeddingSystem.forward-292"><span class="linenos">292</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L F C&quot;</span><span class="p">]:</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-293"><a href="#ModularAttributeEmbeddingSystem.forward-293"><span class="linenos">293</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-294"><a href="#ModularAttributeEmbeddingSystem.forward-294"><span class="linenos">294</span></a><span class="sd">        Performs the forward pass of the ModularAttributeEmbeddingSystem.</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-295"><a href="#ModularAttributeEmbeddingSystem.forward-295"><span class="linenos">295</span></a>
</span><span id="ModularAttributeEmbeddingSystem.forward-296"><a href="#ModularAttributeEmbeddingSystem.forward-296"><span class="linenos">296</span></a><span class="sd">        Args:</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-297"><a href="#ModularAttributeEmbeddingSystem.forward-297"><span class="linenos">297</span></a><span class="sd">            inputs (TensorDict[Float[Tensor, &quot;N L&quot;] | Int[Tensor, &quot;N L&quot;]]): The input tensor.</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-298"><a href="#ModularAttributeEmbeddingSystem.forward-298"><span class="linenos">298</span></a>
</span><span id="ModularAttributeEmbeddingSystem.forward-299"><a href="#ModularAttributeEmbeddingSystem.forward-299"><span class="linenos">299</span></a><span class="sd">        Returns:</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-300"><a href="#ModularAttributeEmbeddingSystem.forward-300"><span class="linenos">300</span></a><span class="sd">            Float[Tensor, &quot;N L F&quot;]: The embedded fields.</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-301"><a href="#ModularAttributeEmbeddingSystem.forward-301"><span class="linenos">301</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-302"><a href="#ModularAttributeEmbeddingSystem.forward-302"><span class="linenos">302</span></a>
</span><span id="ModularAttributeEmbeddingSystem.forward-303"><a href="#ModularAttributeEmbeddingSystem.forward-303"><span class="linenos">303</span></a>        <span class="n">embeddings</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-304"><a href="#ModularAttributeEmbeddingSystem.forward-304"><span class="linenos">304</span></a>
</span><span id="ModularAttributeEmbeddingSystem.forward-305"><a href="#ModularAttributeEmbeddingSystem.forward-305"><span class="linenos">305</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">inputs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-306"><a href="#ModularAttributeEmbeddingSystem.forward-306"><span class="linenos">306</span></a>            <span class="k">if</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-307"><a href="#ModularAttributeEmbeddingSystem.forward-307"><span class="linenos">307</span></a>                <span class="n">embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">embedders</span><span class="p">[</span><span class="n">field</span><span class="p">](</span><span class="n">inputs</span><span class="p">[</span><span class="n">field</span><span class="p">])</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-308"><a href="#ModularAttributeEmbeddingSystem.forward-308"><span class="linenos">308</span></a>                <span class="n">embeddings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">embedding</span><span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-309"><a href="#ModularAttributeEmbeddingSystem.forward-309"><span class="linenos">309</span></a>
</span><span id="ModularAttributeEmbeddingSystem.forward-310"><a href="#ModularAttributeEmbeddingSystem.forward-310"><span class="linenos">310</span></a>        <span class="c1"># N L C F</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-311"><a href="#ModularAttributeEmbeddingSystem.forward-311"><span class="linenos">311</span></a>        <span class="n">stacked</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">embeddings</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-312"><a href="#ModularAttributeEmbeddingSystem.forward-312"><span class="linenos">312</span></a>
</span><span id="ModularAttributeEmbeddingSystem.forward-313"><a href="#ModularAttributeEmbeddingSystem.forward-313"><span class="linenos">313</span></a>        <span class="c1"># N L F C</span>
</span><span id="ModularAttributeEmbeddingSystem.forward-314"><a href="#ModularAttributeEmbeddingSystem.forward-314"><span class="linenos">314</span></a>        <span class="k">return</span> <span class="n">stacked</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Performs the forward pass of the ModularAttributeEmbeddingSystem.</p>

<p>Args:
    inputs (TensorDict[Float[Tensor, "N L"] | Int[Tensor, "N L"]]): The input tensor.</p>

<p>Returns:
    Float[Tensor, "N L F"]: The embedded fields.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="ModularAttributeEmbeddingSystem.dump_patches" class="variable">dump_patches</dd>
                <dd id="ModularAttributeEmbeddingSystem.training" class="variable">training</dd>
                <dd id="ModularAttributeEmbeddingSystem.call_super_init" class="variable">call_super_init</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_buffer" class="function">register_buffer</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_parameter" class="function">register_parameter</dd>
                <dd id="ModularAttributeEmbeddingSystem.add_module" class="function">add_module</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_module" class="function">register_module</dd>
                <dd id="ModularAttributeEmbeddingSystem.get_submodule" class="function">get_submodule</dd>
                <dd id="ModularAttributeEmbeddingSystem.get_parameter" class="function">get_parameter</dd>
                <dd id="ModularAttributeEmbeddingSystem.get_buffer" class="function">get_buffer</dd>
                <dd id="ModularAttributeEmbeddingSystem.get_extra_state" class="function">get_extra_state</dd>
                <dd id="ModularAttributeEmbeddingSystem.set_extra_state" class="function">set_extra_state</dd>
                <dd id="ModularAttributeEmbeddingSystem.apply" class="function">apply</dd>
                <dd id="ModularAttributeEmbeddingSystem.cuda" class="function">cuda</dd>
                <dd id="ModularAttributeEmbeddingSystem.ipu" class="function">ipu</dd>
                <dd id="ModularAttributeEmbeddingSystem.xpu" class="function">xpu</dd>
                <dd id="ModularAttributeEmbeddingSystem.cpu" class="function">cpu</dd>
                <dd id="ModularAttributeEmbeddingSystem.type" class="function">type</dd>
                <dd id="ModularAttributeEmbeddingSystem.float" class="function">float</dd>
                <dd id="ModularAttributeEmbeddingSystem.double" class="function">double</dd>
                <dd id="ModularAttributeEmbeddingSystem.half" class="function">half</dd>
                <dd id="ModularAttributeEmbeddingSystem.bfloat16" class="function">bfloat16</dd>
                <dd id="ModularAttributeEmbeddingSystem.to_empty" class="function">to_empty</dd>
                <dd id="ModularAttributeEmbeddingSystem.to" class="function">to</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="ModularAttributeEmbeddingSystem.state_dict" class="function">state_dict</dd>
                <dd id="ModularAttributeEmbeddingSystem.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="ModularAttributeEmbeddingSystem.load_state_dict" class="function">load_state_dict</dd>
                <dd id="ModularAttributeEmbeddingSystem.parameters" class="function">parameters</dd>
                <dd id="ModularAttributeEmbeddingSystem.named_parameters" class="function">named_parameters</dd>
                <dd id="ModularAttributeEmbeddingSystem.buffers" class="function">buffers</dd>
                <dd id="ModularAttributeEmbeddingSystem.named_buffers" class="function">named_buffers</dd>
                <dd id="ModularAttributeEmbeddingSystem.children" class="function">children</dd>
                <dd id="ModularAttributeEmbeddingSystem.named_children" class="function">named_children</dd>
                <dd id="ModularAttributeEmbeddingSystem.modules" class="function">modules</dd>
                <dd id="ModularAttributeEmbeddingSystem.named_modules" class="function">named_modules</dd>
                <dd id="ModularAttributeEmbeddingSystem.train" class="function">train</dd>
                <dd id="ModularAttributeEmbeddingSystem.eval" class="function">eval</dd>
                <dd id="ModularAttributeEmbeddingSystem.requires_grad_" class="function">requires_grad_</dd>
                <dd id="ModularAttributeEmbeddingSystem.zero_grad" class="function">zero_grad</dd>
                <dd id="ModularAttributeEmbeddingSystem.share_memory" class="function">share_memory</dd>
                <dd id="ModularAttributeEmbeddingSystem.extra_repr" class="function">extra_repr</dd>
                <dd id="ModularAttributeEmbeddingSystem.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="FieldEncoder">
                            <input id="FieldEncoder-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">FieldEncoder</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="FieldEncoder-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FieldEncoder"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FieldEncoder-317"><a href="#FieldEncoder-317"><span class="linenos">317</span></a><span class="k">class</span> <span class="nc">FieldEncoder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="FieldEncoder-318"><a href="#FieldEncoder-318"><span class="linenos">318</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FieldEncoder-319"><a href="#FieldEncoder-319"><span class="linenos">319</span></a><span class="sd">    FieldEncoder is a PyTorch module for encoding fields.</span>
</span><span id="FieldEncoder-320"><a href="#FieldEncoder-320"><span class="linenos">320</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="FieldEncoder-321"><a href="#FieldEncoder-321"><span class="linenos">321</span></a>
</span><span id="FieldEncoder-322"><a href="#FieldEncoder-322"><span class="linenos">322</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="FieldEncoder-323"><a href="#FieldEncoder-323"><span class="linenos">323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FieldEncoder-324"><a href="#FieldEncoder-324"><span class="linenos">324</span></a><span class="sd">        Initialize field transformer encoder.</span>
</span><span id="FieldEncoder-325"><a href="#FieldEncoder-325"><span class="linenos">325</span></a>
</span><span id="FieldEncoder-326"><a href="#FieldEncoder-326"><span class="linenos">326</span></a><span class="sd">        Args:</span>
</span><span id="FieldEncoder-327"><a href="#FieldEncoder-327"><span class="linenos">327</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="FieldEncoder-328"><a href="#FieldEncoder-328"><span class="linenos">328</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FieldEncoder-329"><a href="#FieldEncoder-329"><span class="linenos">329</span></a>
</span><span id="FieldEncoder-330"><a href="#FieldEncoder-330"><span class="linenos">330</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="FieldEncoder-331"><a href="#FieldEncoder-331"><span class="linenos">331</span></a>
</span><span id="FieldEncoder-332"><a href="#FieldEncoder-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_heads_field_encoder</span>
</span><span id="FieldEncoder-333"><a href="#FieldEncoder-333"><span class="linenos">333</span></a>
</span><span id="FieldEncoder-334"><a href="#FieldEncoder-334"><span class="linenos">334</span></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="FieldEncoder-335"><a href="#FieldEncoder-335"><span class="linenos">335</span></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="FieldEncoder-336"><a href="#FieldEncoder-336"><span class="linenos">336</span></a>            <span class="n">nhead</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_field_encoder</span><span class="p">,</span>
</span><span id="FieldEncoder-337"><a href="#FieldEncoder-337"><span class="linenos">337</span></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FieldEncoder-338"><a href="#FieldEncoder-338"><span class="linenos">338</span></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
</span><span id="FieldEncoder-339"><a href="#FieldEncoder-339"><span class="linenos">339</span></a>        <span class="p">)</span>
</span><span id="FieldEncoder-340"><a href="#FieldEncoder-340"><span class="linenos">340</span></a>
</span><span id="FieldEncoder-341"><a href="#FieldEncoder-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_field_encoder</span><span class="p">)</span>
</span><span id="FieldEncoder-342"><a href="#FieldEncoder-342"><span class="linenos">342</span></a>
</span><span id="FieldEncoder-343"><a href="#FieldEncoder-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">LearnedTensor</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="FieldEncoder-344"><a href="#FieldEncoder-344"><span class="linenos">344</span></a>
</span><span id="FieldEncoder-345"><a href="#FieldEncoder-345"><span class="linenos">345</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="FieldEncoder-346"><a href="#FieldEncoder-346"><span class="linenos">346</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="FieldEncoder-347"><a href="#FieldEncoder-347"><span class="linenos">347</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="FieldEncoder-348"><a href="#FieldEncoder-348"><span class="linenos">348</span></a>        <span class="n">fields</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L F C&quot;</span><span class="p">],</span>
</span><span id="FieldEncoder-349"><a href="#FieldEncoder-349"><span class="linenos">349</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Bool</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;NL F F&quot;</span><span class="p">],</span>
</span><span id="FieldEncoder-350"><a href="#FieldEncoder-350"><span class="linenos">350</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">]:</span>
</span><span id="FieldEncoder-351"><a href="#FieldEncoder-351"><span class="linenos">351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FieldEncoder-352"><a href="#FieldEncoder-352"><span class="linenos">352</span></a><span class="sd">        Performs the forward pass of the FieldEncoder.</span>
</span><span id="FieldEncoder-353"><a href="#FieldEncoder-353"><span class="linenos">353</span></a>
</span><span id="FieldEncoder-354"><a href="#FieldEncoder-354"><span class="linenos">354</span></a><span class="sd">        Args:</span>
</span><span id="FieldEncoder-355"><a href="#FieldEncoder-355"><span class="linenos">355</span></a><span class="sd">            inputs (Float[Tensor, &quot;N L F C&quot;]): The input tensor.</span>
</span><span id="FieldEncoder-356"><a href="#FieldEncoder-356"><span class="linenos">356</span></a>
</span><span id="FieldEncoder-357"><a href="#FieldEncoder-357"><span class="linenos">357</span></a><span class="sd">        Returns:</span>
</span><span id="FieldEncoder-358"><a href="#FieldEncoder-358"><span class="linenos">358</span></a><span class="sd">            Float[Tensor, &quot;N L F C&quot;]: The encoded fields.</span>
</span><span id="FieldEncoder-359"><a href="#FieldEncoder-359"><span class="linenos">359</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FieldEncoder-360"><a href="#FieldEncoder-360"><span class="linenos">360</span></a>
</span><span id="FieldEncoder-361"><a href="#FieldEncoder-361"><span class="linenos">361</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">shape</span>
</span><span id="FieldEncoder-362"><a href="#FieldEncoder-362"><span class="linenos">362</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
</span><span id="FieldEncoder-363"><a href="#FieldEncoder-363"><span class="linenos">363</span></a>
</span><span id="FieldEncoder-364"><a href="#FieldEncoder-364"><span class="linenos">364</span></a>        <span class="c1"># NL F C</span>
</span><span id="FieldEncoder-365"><a href="#FieldEncoder-365"><span class="linenos">365</span></a>        <span class="n">batched</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span id="FieldEncoder-366"><a href="#FieldEncoder-366"><span class="linenos">366</span></a>
</span><span id="FieldEncoder-367"><a href="#FieldEncoder-367"><span class="linenos">367</span></a>        <span class="c1"># NL F C</span>
</span><span id="FieldEncoder-368"><a href="#FieldEncoder-368"><span class="linenos">368</span></a>        <span class="n">batched</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span id="FieldEncoder-369"><a href="#FieldEncoder-369"><span class="linenos">369</span></a>
</span><span id="FieldEncoder-370"><a href="#FieldEncoder-370"><span class="linenos">370</span></a>        <span class="c1"># NLH F F</span>
</span><span id="FieldEncoder-371"><a href="#FieldEncoder-371"><span class="linenos">371</span></a>        <span class="n">identity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">((</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span> <span class="o">*</span> <span class="n">H</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>
</span><span id="FieldEncoder-372"><a href="#FieldEncoder-372"><span class="linenos">372</span></a>
</span><span id="FieldEncoder-373"><a href="#FieldEncoder-373"><span class="linenos">373</span></a>        <span class="c1"># NLH F F</span>
</span><span id="FieldEncoder-374"><a href="#FieldEncoder-374"><span class="linenos">374</span></a>        <span class="n">masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">identity</span>
</span><span id="FieldEncoder-375"><a href="#FieldEncoder-375"><span class="linenos">375</span></a>
</span><span id="FieldEncoder-376"><a href="#FieldEncoder-376"><span class="linenos">376</span></a>        <span class="c1"># NL F C</span>
</span><span id="FieldEncoder-377"><a href="#FieldEncoder-377"><span class="linenos">377</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">batched</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">masks</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span> <span class="o">*</span> <span class="n">C</span><span class="p">)</span>
</span><span id="FieldEncoder-378"><a href="#FieldEncoder-378"><span class="linenos">378</span></a>
</span><span id="FieldEncoder-379"><a href="#FieldEncoder-379"><span class="linenos">379</span></a>        <span class="c1"># N L FC</span>
</span><span id="FieldEncoder-380"><a href="#FieldEncoder-380"><span class="linenos">380</span></a>        <span class="k">return</span> <span class="n">events</span>
</span></pre></div>


            <div class="docstring"><p>FieldEncoder is a PyTorch module for encoding fields.</p>
</div>


                            <div id="FieldEncoder.__init__" class="classattr">
                                        <input id="FieldEncoder.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">FieldEncoder</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span></span>)</span>

                <label class="view-source-button" for="FieldEncoder.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FieldEncoder.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FieldEncoder.__init__-322"><a href="#FieldEncoder.__init__-322"><span class="linenos">322</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="FieldEncoder.__init__-323"><a href="#FieldEncoder.__init__-323"><span class="linenos">323</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FieldEncoder.__init__-324"><a href="#FieldEncoder.__init__-324"><span class="linenos">324</span></a><span class="sd">        Initialize field transformer encoder.</span>
</span><span id="FieldEncoder.__init__-325"><a href="#FieldEncoder.__init__-325"><span class="linenos">325</span></a>
</span><span id="FieldEncoder.__init__-326"><a href="#FieldEncoder.__init__-326"><span class="linenos">326</span></a><span class="sd">        Args:</span>
</span><span id="FieldEncoder.__init__-327"><a href="#FieldEncoder.__init__-327"><span class="linenos">327</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="FieldEncoder.__init__-328"><a href="#FieldEncoder.__init__-328"><span class="linenos">328</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FieldEncoder.__init__-329"><a href="#FieldEncoder.__init__-329"><span class="linenos">329</span></a>
</span><span id="FieldEncoder.__init__-330"><a href="#FieldEncoder.__init__-330"><span class="linenos">330</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="FieldEncoder.__init__-331"><a href="#FieldEncoder.__init__-331"><span class="linenos">331</span></a>
</span><span id="FieldEncoder.__init__-332"><a href="#FieldEncoder.__init__-332"><span class="linenos">332</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_heads_field_encoder</span>
</span><span id="FieldEncoder.__init__-333"><a href="#FieldEncoder.__init__-333"><span class="linenos">333</span></a>
</span><span id="FieldEncoder.__init__-334"><a href="#FieldEncoder.__init__-334"><span class="linenos">334</span></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="FieldEncoder.__init__-335"><a href="#FieldEncoder.__init__-335"><span class="linenos">335</span></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="FieldEncoder.__init__-336"><a href="#FieldEncoder.__init__-336"><span class="linenos">336</span></a>            <span class="n">nhead</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_field_encoder</span><span class="p">,</span>
</span><span id="FieldEncoder.__init__-337"><a href="#FieldEncoder.__init__-337"><span class="linenos">337</span></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="FieldEncoder.__init__-338"><a href="#FieldEncoder.__init__-338"><span class="linenos">338</span></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
</span><span id="FieldEncoder.__init__-339"><a href="#FieldEncoder.__init__-339"><span class="linenos">339</span></a>        <span class="p">)</span>
</span><span id="FieldEncoder.__init__-340"><a href="#FieldEncoder.__init__-340"><span class="linenos">340</span></a>
</span><span id="FieldEncoder.__init__-341"><a href="#FieldEncoder.__init__-341"><span class="linenos">341</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_field_encoder</span><span class="p">)</span>
</span><span id="FieldEncoder.__init__-342"><a href="#FieldEncoder.__init__-342"><span class="linenos">342</span></a>
</span><span id="FieldEncoder.__init__-343"><a href="#FieldEncoder.__init__-343"><span class="linenos">343</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">LearnedTensor</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize field transformer encoder.</p>

<p>Args:
    params (Hyperparameters): The hyperparameters for the architecture.</p>
</div>


                            </div>
                            <div id="FieldEncoder.H" class="classattr">
                                <div class="attr variable">
            <span class="name">H</span>

        
    </div>
    <a class="headerlink" href="#FieldEncoder.H"></a>
    
    

                            </div>
                            <div id="FieldEncoder.encoder" class="classattr">
                                <div class="attr variable">
            <span class="name">encoder</span>

        
    </div>
    <a class="headerlink" href="#FieldEncoder.encoder"></a>
    
    

                            </div>
                            <div id="FieldEncoder.positional" class="classattr">
                                <div class="attr variable">
            <span class="name">positional</span>

        
    </div>
    <a class="headerlink" href="#FieldEncoder.positional"></a>
    
    

                            </div>
                            <div id="FieldEncoder.forward" class="classattr">
                                        <input id="FieldEncoder.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jaxtyped(typechecker=beartype)</div>

        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">fields</span><span class="p">:</span> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L F C&#39;</span><span class="p">]</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Bool</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;NL F F&#39;</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L FC&#39;</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="FieldEncoder.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#FieldEncoder.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="FieldEncoder.forward-345"><a href="#FieldEncoder.forward-345"><span class="linenos">345</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="FieldEncoder.forward-346"><a href="#FieldEncoder.forward-346"><span class="linenos">346</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="FieldEncoder.forward-347"><a href="#FieldEncoder.forward-347"><span class="linenos">347</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="FieldEncoder.forward-348"><a href="#FieldEncoder.forward-348"><span class="linenos">348</span></a>        <span class="n">fields</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L F C&quot;</span><span class="p">],</span>
</span><span id="FieldEncoder.forward-349"><a href="#FieldEncoder.forward-349"><span class="linenos">349</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Bool</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;NL F F&quot;</span><span class="p">],</span>
</span><span id="FieldEncoder.forward-350"><a href="#FieldEncoder.forward-350"><span class="linenos">350</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">]:</span>
</span><span id="FieldEncoder.forward-351"><a href="#FieldEncoder.forward-351"><span class="linenos">351</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="FieldEncoder.forward-352"><a href="#FieldEncoder.forward-352"><span class="linenos">352</span></a><span class="sd">        Performs the forward pass of the FieldEncoder.</span>
</span><span id="FieldEncoder.forward-353"><a href="#FieldEncoder.forward-353"><span class="linenos">353</span></a>
</span><span id="FieldEncoder.forward-354"><a href="#FieldEncoder.forward-354"><span class="linenos">354</span></a><span class="sd">        Args:</span>
</span><span id="FieldEncoder.forward-355"><a href="#FieldEncoder.forward-355"><span class="linenos">355</span></a><span class="sd">            inputs (Float[Tensor, &quot;N L F C&quot;]): The input tensor.</span>
</span><span id="FieldEncoder.forward-356"><a href="#FieldEncoder.forward-356"><span class="linenos">356</span></a>
</span><span id="FieldEncoder.forward-357"><a href="#FieldEncoder.forward-357"><span class="linenos">357</span></a><span class="sd">        Returns:</span>
</span><span id="FieldEncoder.forward-358"><a href="#FieldEncoder.forward-358"><span class="linenos">358</span></a><span class="sd">            Float[Tensor, &quot;N L F C&quot;]: The encoded fields.</span>
</span><span id="FieldEncoder.forward-359"><a href="#FieldEncoder.forward-359"><span class="linenos">359</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="FieldEncoder.forward-360"><a href="#FieldEncoder.forward-360"><span class="linenos">360</span></a>
</span><span id="FieldEncoder.forward-361"><a href="#FieldEncoder.forward-361"><span class="linenos">361</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">C</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">shape</span>
</span><span id="FieldEncoder.forward-362"><a href="#FieldEncoder.forward-362"><span class="linenos">362</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
</span><span id="FieldEncoder.forward-363"><a href="#FieldEncoder.forward-363"><span class="linenos">363</span></a>
</span><span id="FieldEncoder.forward-364"><a href="#FieldEncoder.forward-364"><span class="linenos">364</span></a>        <span class="c1"># NL F C</span>
</span><span id="FieldEncoder.forward-365"><a href="#FieldEncoder.forward-365"><span class="linenos">365</span></a>        <span class="n">batched</span> <span class="o">=</span> <span class="n">fields</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span id="FieldEncoder.forward-366"><a href="#FieldEncoder.forward-366"><span class="linenos">366</span></a>
</span><span id="FieldEncoder.forward-367"><a href="#FieldEncoder.forward-367"><span class="linenos">367</span></a>        <span class="c1"># NL F C</span>
</span><span id="FieldEncoder.forward-368"><a href="#FieldEncoder.forward-368"><span class="linenos">368</span></a>        <span class="n">batched</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">C</span><span class="p">)</span>
</span><span id="FieldEncoder.forward-369"><a href="#FieldEncoder.forward-369"><span class="linenos">369</span></a>
</span><span id="FieldEncoder.forward-370"><a href="#FieldEncoder.forward-370"><span class="linenos">370</span></a>        <span class="c1"># NLH F F</span>
</span><span id="FieldEncoder.forward-371"><a href="#FieldEncoder.forward-371"><span class="linenos">371</span></a>        <span class="n">identity</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">F</span><span class="p">)</span><span class="o">.</span><span class="n">bool</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">((</span><span class="n">N</span> <span class="o">*</span> <span class="n">L</span> <span class="o">*</span> <span class="n">H</span><span class="p">,</span> <span class="n">F</span><span class="p">,</span> <span class="n">F</span><span class="p">))</span>
</span><span id="FieldEncoder.forward-372"><a href="#FieldEncoder.forward-372"><span class="linenos">372</span></a>
</span><span id="FieldEncoder.forward-373"><a href="#FieldEncoder.forward-373"><span class="linenos">373</span></a>        <span class="c1"># NLH F F</span>
</span><span id="FieldEncoder.forward-374"><a href="#FieldEncoder.forward-374"><span class="linenos">374</span></a>        <span class="n">masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">identity</span>
</span><span id="FieldEncoder.forward-375"><a href="#FieldEncoder.forward-375"><span class="linenos">375</span></a>
</span><span id="FieldEncoder.forward-376"><a href="#FieldEncoder.forward-376"><span class="linenos">376</span></a>        <span class="c1"># NL F C</span>
</span><span id="FieldEncoder.forward-377"><a href="#FieldEncoder.forward-377"><span class="linenos">377</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">batched</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">masks</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">F</span> <span class="o">*</span> <span class="n">C</span><span class="p">)</span>
</span><span id="FieldEncoder.forward-378"><a href="#FieldEncoder.forward-378"><span class="linenos">378</span></a>
</span><span id="FieldEncoder.forward-379"><a href="#FieldEncoder.forward-379"><span class="linenos">379</span></a>        <span class="c1"># N L FC</span>
</span><span id="FieldEncoder.forward-380"><a href="#FieldEncoder.forward-380"><span class="linenos">380</span></a>        <span class="k">return</span> <span class="n">events</span>
</span></pre></div>


            <div class="docstring"><p>Performs the forward pass of the FieldEncoder.</p>

<p>Args:
    inputs (Float[Tensor, "N L F C"]): The input tensor.</p>

<p>Returns:
    Float[Tensor, "N L F C"]: The encoded fields.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="FieldEncoder.dump_patches" class="variable">dump_patches</dd>
                <dd id="FieldEncoder.training" class="variable">training</dd>
                <dd id="FieldEncoder.call_super_init" class="variable">call_super_init</dd>
                <dd id="FieldEncoder.register_buffer" class="function">register_buffer</dd>
                <dd id="FieldEncoder.register_parameter" class="function">register_parameter</dd>
                <dd id="FieldEncoder.add_module" class="function">add_module</dd>
                <dd id="FieldEncoder.register_module" class="function">register_module</dd>
                <dd id="FieldEncoder.get_submodule" class="function">get_submodule</dd>
                <dd id="FieldEncoder.get_parameter" class="function">get_parameter</dd>
                <dd id="FieldEncoder.get_buffer" class="function">get_buffer</dd>
                <dd id="FieldEncoder.get_extra_state" class="function">get_extra_state</dd>
                <dd id="FieldEncoder.set_extra_state" class="function">set_extra_state</dd>
                <dd id="FieldEncoder.apply" class="function">apply</dd>
                <dd id="FieldEncoder.cuda" class="function">cuda</dd>
                <dd id="FieldEncoder.ipu" class="function">ipu</dd>
                <dd id="FieldEncoder.xpu" class="function">xpu</dd>
                <dd id="FieldEncoder.cpu" class="function">cpu</dd>
                <dd id="FieldEncoder.type" class="function">type</dd>
                <dd id="FieldEncoder.float" class="function">float</dd>
                <dd id="FieldEncoder.double" class="function">double</dd>
                <dd id="FieldEncoder.half" class="function">half</dd>
                <dd id="FieldEncoder.bfloat16" class="function">bfloat16</dd>
                <dd id="FieldEncoder.to_empty" class="function">to_empty</dd>
                <dd id="FieldEncoder.to" class="function">to</dd>
                <dd id="FieldEncoder.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="FieldEncoder.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="FieldEncoder.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="FieldEncoder.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="FieldEncoder.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="FieldEncoder.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="FieldEncoder.state_dict" class="function">state_dict</dd>
                <dd id="FieldEncoder.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="FieldEncoder.load_state_dict" class="function">load_state_dict</dd>
                <dd id="FieldEncoder.parameters" class="function">parameters</dd>
                <dd id="FieldEncoder.named_parameters" class="function">named_parameters</dd>
                <dd id="FieldEncoder.buffers" class="function">buffers</dd>
                <dd id="FieldEncoder.named_buffers" class="function">named_buffers</dd>
                <dd id="FieldEncoder.children" class="function">children</dd>
                <dd id="FieldEncoder.named_children" class="function">named_children</dd>
                <dd id="FieldEncoder.modules" class="function">modules</dd>
                <dd id="FieldEncoder.named_modules" class="function">named_modules</dd>
                <dd id="FieldEncoder.train" class="function">train</dd>
                <dd id="FieldEncoder.eval" class="function">eval</dd>
                <dd id="FieldEncoder.requires_grad_" class="function">requires_grad_</dd>
                <dd id="FieldEncoder.zero_grad" class="function">zero_grad</dd>
                <dd id="FieldEncoder.share_memory" class="function">share_memory</dd>
                <dd id="FieldEncoder.extra_repr" class="function">extra_repr</dd>
                <dd id="FieldEncoder.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="EventEncoder">
                            <input id="EventEncoder-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EventEncoder</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="EventEncoder-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventEncoder"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventEncoder-383"><a href="#EventEncoder-383"><span class="linenos">383</span></a><span class="k">class</span> <span class="nc">EventEncoder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="EventEncoder-384"><a href="#EventEncoder-384"><span class="linenos">384</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventEncoder-385"><a href="#EventEncoder-385"><span class="linenos">385</span></a><span class="sd">    EventEncoder is a PyTorch module for encoding events.</span>
</span><span id="EventEncoder-386"><a href="#EventEncoder-386"><span class="linenos">386</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="EventEncoder-387"><a href="#EventEncoder-387"><span class="linenos">387</span></a>
</span><span id="EventEncoder-388"><a href="#EventEncoder-388"><span class="linenos">388</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="EventEncoder-389"><a href="#EventEncoder-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventEncoder-390"><a href="#EventEncoder-390"><span class="linenos">390</span></a><span class="sd">        Initialize the event transformer encoder.</span>
</span><span id="EventEncoder-391"><a href="#EventEncoder-391"><span class="linenos">391</span></a>
</span><span id="EventEncoder-392"><a href="#EventEncoder-392"><span class="linenos">392</span></a><span class="sd">        Args:</span>
</span><span id="EventEncoder-393"><a href="#EventEncoder-393"><span class="linenos">393</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="EventEncoder-394"><a href="#EventEncoder-394"><span class="linenos">394</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventEncoder-395"><a href="#EventEncoder-395"><span class="linenos">395</span></a>
</span><span id="EventEncoder-396"><a href="#EventEncoder-396"><span class="linenos">396</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="EventEncoder-397"><a href="#EventEncoder-397"><span class="linenos">397</span></a>
</span><span id="EventEncoder-398"><a href="#EventEncoder-398"><span class="linenos">398</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_heads_event_encoder</span>
</span><span id="EventEncoder-399"><a href="#EventEncoder-399"><span class="linenos">399</span></a>
</span><span id="EventEncoder-400"><a href="#EventEncoder-400"><span class="linenos">400</span></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="EventEncoder-401"><a href="#EventEncoder-401"><span class="linenos">401</span></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="EventEncoder-402"><a href="#EventEncoder-402"><span class="linenos">402</span></a>            <span class="n">nhead</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_event_encoder</span><span class="p">,</span>
</span><span id="EventEncoder-403"><a href="#EventEncoder-403"><span class="linenos">403</span></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="EventEncoder-404"><a href="#EventEncoder-404"><span class="linenos">404</span></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
</span><span id="EventEncoder-405"><a href="#EventEncoder-405"><span class="linenos">405</span></a>        <span class="p">)</span>
</span><span id="EventEncoder-406"><a href="#EventEncoder-406"><span class="linenos">406</span></a>
</span><span id="EventEncoder-407"><a href="#EventEncoder-407"><span class="linenos">407</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_event_encoder</span><span class="p">)</span>
</span><span id="EventEncoder-408"><a href="#EventEncoder-408"><span class="linenos">408</span></a>
</span><span id="EventEncoder-409"><a href="#EventEncoder-409"><span class="linenos">409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">LearnedTensor</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_context</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="EventEncoder-410"><a href="#EventEncoder-410"><span class="linenos">410</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">class_token</span> <span class="o">=</span> <span class="n">LearnedTensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="EventEncoder-411"><a href="#EventEncoder-411"><span class="linenos">411</span></a>
</span><span id="EventEncoder-412"><a href="#EventEncoder-412"><span class="linenos">412</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="EventEncoder-413"><a href="#EventEncoder-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="EventEncoder-414"><a href="#EventEncoder-414"><span class="linenos">414</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventEncoder-415"><a href="#EventEncoder-415"><span class="linenos">415</span></a>        <span class="n">events</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">],</span>
</span><span id="EventEncoder-416"><a href="#EventEncoder-416"><span class="linenos">416</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Bool</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L L&quot;</span><span class="p">],</span>
</span><span id="EventEncoder-417"><a href="#EventEncoder-417"><span class="linenos">417</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
</span><span id="EventEncoder-418"><a href="#EventEncoder-418"><span class="linenos">418</span></a>        <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N FC&quot;</span><span class="p">],</span>
</span><span id="EventEncoder-419"><a href="#EventEncoder-419"><span class="linenos">419</span></a>        <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">],</span>
</span><span id="EventEncoder-420"><a href="#EventEncoder-420"><span class="linenos">420</span></a>    <span class="p">]:</span>
</span><span id="EventEncoder-421"><a href="#EventEncoder-421"><span class="linenos">421</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">FC</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">shape</span>
</span><span id="EventEncoder-422"><a href="#EventEncoder-422"><span class="linenos">422</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
</span><span id="EventEncoder-423"><a href="#EventEncoder-423"><span class="linenos">423</span></a>
</span><span id="EventEncoder-424"><a href="#EventEncoder-424"><span class="linenos">424</span></a>        <span class="c1"># N L FC</span>
</span><span id="EventEncoder-425"><a href="#EventEncoder-425"><span class="linenos">425</span></a>        <span class="n">events</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">FC</span><span class="p">)</span>
</span><span id="EventEncoder-426"><a href="#EventEncoder-426"><span class="linenos">426</span></a>
</span><span id="EventEncoder-427"><a href="#EventEncoder-427"><span class="linenos">427</span></a>        <span class="c1"># N 1 FC</span>
</span><span id="EventEncoder-428"><a href="#EventEncoder-428"><span class="linenos">428</span></a>        <span class="n">class_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_token</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FC</span><span class="p">)</span>
</span><span id="EventEncoder-429"><a href="#EventEncoder-429"><span class="linenos">429</span></a>
</span><span id="EventEncoder-430"><a href="#EventEncoder-430"><span class="linenos">430</span></a>        <span class="c1"># N L+1 FC</span>
</span><span id="EventEncoder-431"><a href="#EventEncoder-431"><span class="linenos">431</span></a>        <span class="n">concatenated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">class_token</span><span class="p">,</span> <span class="n">events</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventEncoder-432"><a href="#EventEncoder-432"><span class="linenos">432</span></a>
</span><span id="EventEncoder-433"><a href="#EventEncoder-433"><span class="linenos">433</span></a>        <span class="c1"># NH L+1 L+1</span>
</span><span id="EventEncoder-434"><a href="#EventEncoder-434"><span class="linenos">434</span></a>        <span class="n">masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="EventEncoder-435"><a href="#EventEncoder-435"><span class="linenos">435</span></a>
</span><span id="EventEncoder-436"><a href="#EventEncoder-436"><span class="linenos">436</span></a>        <span class="c1"># N L+1 FC</span>
</span><span id="EventEncoder-437"><a href="#EventEncoder-437"><span class="linenos">437</span></a>        <span class="n">encoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">concatenated</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">masks</span><span class="p">)</span>
</span><span id="EventEncoder-438"><a href="#EventEncoder-438"><span class="linenos">438</span></a>
</span><span id="EventEncoder-439"><a href="#EventEncoder-439"><span class="linenos">439</span></a>        <span class="c1"># (N 1 FC), (N L FC)</span>
</span><span id="EventEncoder-440"><a href="#EventEncoder-440"><span class="linenos">440</span></a>        <span class="n">sequence</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="n">encoded</span><span class="o">.</span><span class="n">split</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventEncoder-441"><a href="#EventEncoder-441"><span class="linenos">441</span></a>
</span><span id="EventEncoder-442"><a href="#EventEncoder-442"><span class="linenos">442</span></a>        <span class="k">return</span> <span class="n">sequence</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">events</span>
</span></pre></div>


            <div class="docstring"><p>EventEncoder is a PyTorch module for encoding events.</p>
</div>


                            <div id="EventEncoder.__init__" class="classattr">
                                        <input id="EventEncoder.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">EventEncoder</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span></span>)</span>

                <label class="view-source-button" for="EventEncoder.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventEncoder.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventEncoder.__init__-388"><a href="#EventEncoder.__init__-388"><span class="linenos">388</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="EventEncoder.__init__-389"><a href="#EventEncoder.__init__-389"><span class="linenos">389</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventEncoder.__init__-390"><a href="#EventEncoder.__init__-390"><span class="linenos">390</span></a><span class="sd">        Initialize the event transformer encoder.</span>
</span><span id="EventEncoder.__init__-391"><a href="#EventEncoder.__init__-391"><span class="linenos">391</span></a>
</span><span id="EventEncoder.__init__-392"><a href="#EventEncoder.__init__-392"><span class="linenos">392</span></a><span class="sd">        Args:</span>
</span><span id="EventEncoder.__init__-393"><a href="#EventEncoder.__init__-393"><span class="linenos">393</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="EventEncoder.__init__-394"><a href="#EventEncoder.__init__-394"><span class="linenos">394</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventEncoder.__init__-395"><a href="#EventEncoder.__init__-395"><span class="linenos">395</span></a>
</span><span id="EventEncoder.__init__-396"><a href="#EventEncoder.__init__-396"><span class="linenos">396</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="EventEncoder.__init__-397"><a href="#EventEncoder.__init__-397"><span class="linenos">397</span></a>
</span><span id="EventEncoder.__init__-398"><a href="#EventEncoder.__init__-398"><span class="linenos">398</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_heads_event_encoder</span>
</span><span id="EventEncoder.__init__-399"><a href="#EventEncoder.__init__-399"><span class="linenos">399</span></a>
</span><span id="EventEncoder.__init__-400"><a href="#EventEncoder.__init__-400"><span class="linenos">400</span></a>        <span class="n">layer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span>
</span><span id="EventEncoder.__init__-401"><a href="#EventEncoder.__init__-401"><span class="linenos">401</span></a>            <span class="n">d_model</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="EventEncoder.__init__-402"><a href="#EventEncoder.__init__-402"><span class="linenos">402</span></a>            <span class="n">nhead</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_heads_event_encoder</span><span class="p">,</span>
</span><span id="EventEncoder.__init__-403"><a href="#EventEncoder.__init__-403"><span class="linenos">403</span></a>            <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="EventEncoder.__init__-404"><a href="#EventEncoder.__init__-404"><span class="linenos">404</span></a>            <span class="n">dropout</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">dropout</span><span class="p">,</span>
</span><span id="EventEncoder.__init__-405"><a href="#EventEncoder.__init__-405"><span class="linenos">405</span></a>        <span class="p">)</span>
</span><span id="EventEncoder.__init__-406"><a href="#EventEncoder.__init__-406"><span class="linenos">406</span></a>
</span><span id="EventEncoder.__init__-407"><a href="#EventEncoder.__init__-407"><span class="linenos">407</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span><span class="n">layer</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_layers_event_encoder</span><span class="p">)</span>
</span><span id="EventEncoder.__init__-408"><a href="#EventEncoder.__init__-408"><span class="linenos">408</span></a>
</span><span id="EventEncoder.__init__-409"><a href="#EventEncoder.__init__-409"><span class="linenos">409</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="n">LearnedTensor</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_context</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span><span id="EventEncoder.__init__-410"><a href="#EventEncoder.__init__-410"><span class="linenos">410</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">class_token</span> <span class="o">=</span> <span class="n">LearnedTensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the event transformer encoder.</p>

<p>Args:
    params (Hyperparameters): The hyperparameters for the architecture.</p>
</div>


                            </div>
                            <div id="EventEncoder.H" class="classattr">
                                <div class="attr variable">
            <span class="name">H</span>

        
    </div>
    <a class="headerlink" href="#EventEncoder.H"></a>
    
    

                            </div>
                            <div id="EventEncoder.encoder" class="classattr">
                                <div class="attr variable">
            <span class="name">encoder</span>

        
    </div>
    <a class="headerlink" href="#EventEncoder.encoder"></a>
    
    

                            </div>
                            <div id="EventEncoder.positional" class="classattr">
                                <div class="attr variable">
            <span class="name">positional</span>

        
    </div>
    <a class="headerlink" href="#EventEncoder.positional"></a>
    
    

                            </div>
                            <div id="EventEncoder.class_token" class="classattr">
                                <div class="attr variable">
            <span class="name">class_token</span>

        
    </div>
    <a class="headerlink" href="#EventEncoder.class_token"></a>
    
    

                            </div>
                            <div id="EventEncoder.forward" class="classattr">
                                        <input id="EventEncoder.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jaxtyped(typechecker=beartype)</div>

        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">events</span><span class="p">:</span> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L FC&#39;</span><span class="p">]</span>,</span><span class="param">	<span class="n">mask</span><span class="p">:</span> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Bool</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L L&#39;</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N FC&#39;</span><span class="p">],</span> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L FC&#39;</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="EventEncoder.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventEncoder.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventEncoder.forward-412"><a href="#EventEncoder.forward-412"><span class="linenos">412</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="EventEncoder.forward-413"><a href="#EventEncoder.forward-413"><span class="linenos">413</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="EventEncoder.forward-414"><a href="#EventEncoder.forward-414"><span class="linenos">414</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventEncoder.forward-415"><a href="#EventEncoder.forward-415"><span class="linenos">415</span></a>        <span class="n">events</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">],</span>
</span><span id="EventEncoder.forward-416"><a href="#EventEncoder.forward-416"><span class="linenos">416</span></a>        <span class="n">mask</span><span class="p">:</span> <span class="n">Bool</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L L&quot;</span><span class="p">],</span>
</span><span id="EventEncoder.forward-417"><a href="#EventEncoder.forward-417"><span class="linenos">417</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span>
</span><span id="EventEncoder.forward-418"><a href="#EventEncoder.forward-418"><span class="linenos">418</span></a>        <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N FC&quot;</span><span class="p">],</span>
</span><span id="EventEncoder.forward-419"><a href="#EventEncoder.forward-419"><span class="linenos">419</span></a>        <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">],</span>
</span><span id="EventEncoder.forward-420"><a href="#EventEncoder.forward-420"><span class="linenos">420</span></a>    <span class="p">]:</span>
</span><span id="EventEncoder.forward-421"><a href="#EventEncoder.forward-421"><span class="linenos">421</span></a>        <span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">FC</span> <span class="o">=</span> <span class="n">events</span><span class="o">.</span><span class="n">shape</span>
</span><span id="EventEncoder.forward-422"><a href="#EventEncoder.forward-422"><span class="linenos">422</span></a>        <span class="n">H</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">H</span>
</span><span id="EventEncoder.forward-423"><a href="#EventEncoder.forward-423"><span class="linenos">423</span></a>
</span><span id="EventEncoder.forward-424"><a href="#EventEncoder.forward-424"><span class="linenos">424</span></a>        <span class="c1"># N L FC</span>
</span><span id="EventEncoder.forward-425"><a href="#EventEncoder.forward-425"><span class="linenos">425</span></a>        <span class="n">events</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">L</span><span class="p">,</span> <span class="n">FC</span><span class="p">)</span>
</span><span id="EventEncoder.forward-426"><a href="#EventEncoder.forward-426"><span class="linenos">426</span></a>
</span><span id="EventEncoder.forward-427"><a href="#EventEncoder.forward-427"><span class="linenos">427</span></a>        <span class="c1"># N 1 FC</span>
</span><span id="EventEncoder.forward-428"><a href="#EventEncoder.forward-428"><span class="linenos">428</span></a>        <span class="n">class_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_token</span><span class="p">()</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">FC</span><span class="p">)</span>
</span><span id="EventEncoder.forward-429"><a href="#EventEncoder.forward-429"><span class="linenos">429</span></a>
</span><span id="EventEncoder.forward-430"><a href="#EventEncoder.forward-430"><span class="linenos">430</span></a>        <span class="c1"># N L+1 FC</span>
</span><span id="EventEncoder.forward-431"><a href="#EventEncoder.forward-431"><span class="linenos">431</span></a>        <span class="n">concatenated</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">class_token</span><span class="p">,</span> <span class="n">events</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventEncoder.forward-432"><a href="#EventEncoder.forward-432"><span class="linenos">432</span></a>
</span><span id="EventEncoder.forward-433"><a href="#EventEncoder.forward-433"><span class="linenos">433</span></a>        <span class="c1"># NH L+1 L+1</span>
</span><span id="EventEncoder.forward-434"><a href="#EventEncoder.forward-434"><span class="linenos">434</span></a>        <span class="n">masks</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat_interleave</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="EventEncoder.forward-435"><a href="#EventEncoder.forward-435"><span class="linenos">435</span></a>
</span><span id="EventEncoder.forward-436"><a href="#EventEncoder.forward-436"><span class="linenos">436</span></a>        <span class="c1"># N L+1 FC</span>
</span><span id="EventEncoder.forward-437"><a href="#EventEncoder.forward-437"><span class="linenos">437</span></a>        <span class="n">encoded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">concatenated</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">masks</span><span class="p">)</span>
</span><span id="EventEncoder.forward-438"><a href="#EventEncoder.forward-438"><span class="linenos">438</span></a>
</span><span id="EventEncoder.forward-439"><a href="#EventEncoder.forward-439"><span class="linenos">439</span></a>        <span class="c1"># (N 1 FC), (N L FC)</span>
</span><span id="EventEncoder.forward-440"><a href="#EventEncoder.forward-440"><span class="linenos">440</span></a>        <span class="n">sequence</span><span class="p">,</span> <span class="n">events</span> <span class="o">=</span> <span class="n">encoded</span><span class="o">.</span><span class="n">split</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">L</span><span class="p">),</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventEncoder.forward-441"><a href="#EventEncoder.forward-441"><span class="linenos">441</span></a>
</span><span id="EventEncoder.forward-442"><a href="#EventEncoder.forward-442"><span class="linenos">442</span></a>        <span class="k">return</span> <span class="n">sequence</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">events</span>
</span></pre></div>


            <div class="docstring"><p>Define the computation performed at every call.</p>

<p>Should be overridden by all subclasses.</p>

<div class="pdoc-alert pdoc-alert-note">

<p>Although the recipe for forward pass needs to be defined within
this function, one should call the <code>Module</code> instance afterwards
instead of this since the former takes care of running the
registered hooks while the latter silently ignores them.</p>

</div>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="EventEncoder.dump_patches" class="variable">dump_patches</dd>
                <dd id="EventEncoder.training" class="variable">training</dd>
                <dd id="EventEncoder.call_super_init" class="variable">call_super_init</dd>
                <dd id="EventEncoder.register_buffer" class="function">register_buffer</dd>
                <dd id="EventEncoder.register_parameter" class="function">register_parameter</dd>
                <dd id="EventEncoder.add_module" class="function">add_module</dd>
                <dd id="EventEncoder.register_module" class="function">register_module</dd>
                <dd id="EventEncoder.get_submodule" class="function">get_submodule</dd>
                <dd id="EventEncoder.get_parameter" class="function">get_parameter</dd>
                <dd id="EventEncoder.get_buffer" class="function">get_buffer</dd>
                <dd id="EventEncoder.get_extra_state" class="function">get_extra_state</dd>
                <dd id="EventEncoder.set_extra_state" class="function">set_extra_state</dd>
                <dd id="EventEncoder.apply" class="function">apply</dd>
                <dd id="EventEncoder.cuda" class="function">cuda</dd>
                <dd id="EventEncoder.ipu" class="function">ipu</dd>
                <dd id="EventEncoder.xpu" class="function">xpu</dd>
                <dd id="EventEncoder.cpu" class="function">cpu</dd>
                <dd id="EventEncoder.type" class="function">type</dd>
                <dd id="EventEncoder.float" class="function">float</dd>
                <dd id="EventEncoder.double" class="function">double</dd>
                <dd id="EventEncoder.half" class="function">half</dd>
                <dd id="EventEncoder.bfloat16" class="function">bfloat16</dd>
                <dd id="EventEncoder.to_empty" class="function">to_empty</dd>
                <dd id="EventEncoder.to" class="function">to</dd>
                <dd id="EventEncoder.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="EventEncoder.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="EventEncoder.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="EventEncoder.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="EventEncoder.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="EventEncoder.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="EventEncoder.state_dict" class="function">state_dict</dd>
                <dd id="EventEncoder.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="EventEncoder.load_state_dict" class="function">load_state_dict</dd>
                <dd id="EventEncoder.parameters" class="function">parameters</dd>
                <dd id="EventEncoder.named_parameters" class="function">named_parameters</dd>
                <dd id="EventEncoder.buffers" class="function">buffers</dd>
                <dd id="EventEncoder.named_buffers" class="function">named_buffers</dd>
                <dd id="EventEncoder.children" class="function">children</dd>
                <dd id="EventEncoder.named_children" class="function">named_children</dd>
                <dd id="EventEncoder.modules" class="function">modules</dd>
                <dd id="EventEncoder.named_modules" class="function">named_modules</dd>
                <dd id="EventEncoder.train" class="function">train</dd>
                <dd id="EventEncoder.eval" class="function">eval</dd>
                <dd id="EventEncoder.requires_grad_" class="function">requires_grad_</dd>
                <dd id="EventEncoder.zero_grad" class="function">zero_grad</dd>
                <dd id="EventEncoder.share_memory" class="function">share_memory</dd>
                <dd id="EventEncoder.extra_repr" class="function">extra_repr</dd>
                <dd id="EventEncoder.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="EventDecoder">
                            <input id="EventDecoder-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">EventDecoder</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="EventDecoder-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventDecoder"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventDecoder-445"><a href="#EventDecoder-445"><span class="linenos">445</span></a><span class="k">class</span> <span class="nc">EventDecoder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="EventDecoder-446"><a href="#EventDecoder-446"><span class="linenos">446</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventDecoder-447"><a href="#EventDecoder-447"><span class="linenos">447</span></a><span class="sd">    EventDecoder is a PyTorch module for decoding masked events from their contextualized representations.</span>
</span><span id="EventDecoder-448"><a href="#EventDecoder-448"><span class="linenos">448</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="EventDecoder-449"><a href="#EventDecoder-449"><span class="linenos">449</span></a>
</span><span id="EventDecoder-450"><a href="#EventDecoder-450"><span class="linenos">450</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="EventDecoder-451"><a href="#EventDecoder-451"><span class="linenos">451</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventDecoder-452"><a href="#EventDecoder-452"><span class="linenos">452</span></a><span class="sd">        Initialize the event decoder.</span>
</span><span id="EventDecoder-453"><a href="#EventDecoder-453"><span class="linenos">453</span></a>
</span><span id="EventDecoder-454"><a href="#EventDecoder-454"><span class="linenos">454</span></a><span class="sd">        Args:</span>
</span><span id="EventDecoder-455"><a href="#EventDecoder-455"><span class="linenos">455</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="EventDecoder-456"><a href="#EventDecoder-456"><span class="linenos">456</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventDecoder-457"><a href="#EventDecoder-457"><span class="linenos">457</span></a>
</span><span id="EventDecoder-458"><a href="#EventDecoder-458"><span class="linenos">458</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="EventDecoder-459"><a href="#EventDecoder-459"><span class="linenos">459</span></a>
</span><span id="EventDecoder-460"><a href="#EventDecoder-460"><span class="linenos">460</span></a>        <span class="n">projections</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="EventDecoder-461"><a href="#EventDecoder-461"><span class="linenos">461</span></a>
</span><span id="EventDecoder-462"><a href="#EventDecoder-462"><span class="linenos">462</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
</span><span id="EventDecoder-463"><a href="#EventDecoder-463"><span class="linenos">463</span></a>            <span class="k">match</span> <span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
</span><span id="EventDecoder-464"><a href="#EventDecoder-464"><span class="linenos">464</span></a>                <span class="k">case</span> <span class="s2">&quot;discrete&quot;</span><span class="p">:</span>
</span><span id="EventDecoder-465"><a href="#EventDecoder-465"><span class="linenos">465</span></a>                    <span class="n">d_target</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">n_levels</span>
</span><span id="EventDecoder-466"><a href="#EventDecoder-466"><span class="linenos">466</span></a>
</span><span id="EventDecoder-467"><a href="#EventDecoder-467"><span class="linenos">467</span></a>                <span class="k">case</span> <span class="s2">&quot;entity&quot;</span><span class="p">:</span>
</span><span id="EventDecoder-468"><a href="#EventDecoder-468"><span class="linenos">468</span></a>                    <span class="n">d_target</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_context</span>
</span><span id="EventDecoder-469"><a href="#EventDecoder-469"><span class="linenos">469</span></a>
</span><span id="EventDecoder-470"><a href="#EventDecoder-470"><span class="linenos">470</span></a>                <span class="k">case</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="EventDecoder-471"><a href="#EventDecoder-471"><span class="linenos">471</span></a>                    <span class="n">d_target</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_quantiles</span>
</span><span id="EventDecoder-472"><a href="#EventDecoder-472"><span class="linenos">472</span></a>
</span><span id="EventDecoder-473"><a href="#EventDecoder-473"><span class="linenos">473</span></a>            <span class="n">projections</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span>
</span><span id="EventDecoder-474"><a href="#EventDecoder-474"><span class="linenos">474</span></a>                <span class="n">in_channels</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="EventDecoder-475"><a href="#EventDecoder-475"><span class="linenos">475</span></a>                <span class="n">out_channels</span><span class="o">=</span><span class="n">d_target</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span>
</span><span id="EventDecoder-476"><a href="#EventDecoder-476"><span class="linenos">476</span></a>                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="EventDecoder-477"><a href="#EventDecoder-477"><span class="linenos">477</span></a>            <span class="p">)</span>
</span><span id="EventDecoder-478"><a href="#EventDecoder-478"><span class="linenos">478</span></a>
</span><span id="EventDecoder-479"><a href="#EventDecoder-479"><span class="linenos">479</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">projections</span><span class="p">)</span>
</span><span id="EventDecoder-480"><a href="#EventDecoder-480"><span class="linenos">480</span></a>
</span><span id="EventDecoder-481"><a href="#EventDecoder-481"><span class="linenos">481</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="EventDecoder-482"><a href="#EventDecoder-482"><span class="linenos">482</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="EventDecoder-483"><a href="#EventDecoder-483"><span class="linenos">483</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventDecoder-484"><a href="#EventDecoder-484"><span class="linenos">484</span></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">],</span>
</span><span id="EventDecoder-485"><a href="#EventDecoder-485"><span class="linenos">485</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDict</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L ?&quot;</span><span class="p">]]:</span>
</span><span id="EventDecoder-486"><a href="#EventDecoder-486"><span class="linenos">486</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventDecoder-487"><a href="#EventDecoder-487"><span class="linenos">487</span></a><span class="sd">        Performs the forward pass of the EventDecoder.</span>
</span><span id="EventDecoder-488"><a href="#EventDecoder-488"><span class="linenos">488</span></a>
</span><span id="EventDecoder-489"><a href="#EventDecoder-489"><span class="linenos">489</span></a><span class="sd">        Args:</span>
</span><span id="EventDecoder-490"><a href="#EventDecoder-490"><span class="linenos">490</span></a><span class="sd">            inputs (Float[Tensor, &quot;N L FC&quot;]): The input tensor.</span>
</span><span id="EventDecoder-491"><a href="#EventDecoder-491"><span class="linenos">491</span></a>
</span><span id="EventDecoder-492"><a href="#EventDecoder-492"><span class="linenos">492</span></a><span class="sd">        Returns:</span>
</span><span id="EventDecoder-493"><a href="#EventDecoder-493"><span class="linenos">493</span></a><span class="sd">            TensorDict[Float[Tensor, &quot;N L ?&quot;]]: A dictionary of output tensors for each field.</span>
</span><span id="EventDecoder-494"><a href="#EventDecoder-494"><span class="linenos">494</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventDecoder-495"><a href="#EventDecoder-495"><span class="linenos">495</span></a>
</span><span id="EventDecoder-496"><a href="#EventDecoder-496"><span class="linenos">496</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="EventDecoder-497"><a href="#EventDecoder-497"><span class="linenos">497</span></a>
</span><span id="EventDecoder-498"><a href="#EventDecoder-498"><span class="linenos">498</span></a>        <span class="c1"># N, FC, L</span>
</span><span id="EventDecoder-499"><a href="#EventDecoder-499"><span class="linenos">499</span></a>        <span class="n">permuted</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EventDecoder-500"><a href="#EventDecoder-500"><span class="linenos">500</span></a>
</span><span id="EventDecoder-501"><a href="#EventDecoder-501"><span class="linenos">501</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="EventDecoder-502"><a href="#EventDecoder-502"><span class="linenos">502</span></a>
</span><span id="EventDecoder-503"><a href="#EventDecoder-503"><span class="linenos">503</span></a>        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">projection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="EventDecoder-504"><a href="#EventDecoder-504"><span class="linenos">504</span></a>            <span class="n">projected</span> <span class="o">=</span> <span class="n">projection</span><span class="p">(</span><span class="n">permuted</span><span class="p">)</span>
</span><span id="EventDecoder-505"><a href="#EventDecoder-505"><span class="linenos">505</span></a>            <span class="n">events</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">projected</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventDecoder-506"><a href="#EventDecoder-506"><span class="linenos">506</span></a>
</span><span id="EventDecoder-507"><a href="#EventDecoder-507"><span class="linenos">507</span></a>        <span class="c1"># N L ?</span>
</span><span id="EventDecoder-508"><a href="#EventDecoder-508"><span class="linenos">508</span></a>        <span class="k">return</span> <span class="n">TensorDict</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>EventDecoder is a PyTorch module for decoding masked events from their contextualized representations.</p>
</div>


                            <div id="EventDecoder.__init__" class="classattr">
                                        <input id="EventDecoder.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">EventDecoder</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span></span>)</span>

                <label class="view-source-button" for="EventDecoder.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventDecoder.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventDecoder.__init__-450"><a href="#EventDecoder.__init__-450"><span class="linenos">450</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="EventDecoder.__init__-451"><a href="#EventDecoder.__init__-451"><span class="linenos">451</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventDecoder.__init__-452"><a href="#EventDecoder.__init__-452"><span class="linenos">452</span></a><span class="sd">        Initialize the event decoder.</span>
</span><span id="EventDecoder.__init__-453"><a href="#EventDecoder.__init__-453"><span class="linenos">453</span></a>
</span><span id="EventDecoder.__init__-454"><a href="#EventDecoder.__init__-454"><span class="linenos">454</span></a><span class="sd">        Args:</span>
</span><span id="EventDecoder.__init__-455"><a href="#EventDecoder.__init__-455"><span class="linenos">455</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="EventDecoder.__init__-456"><a href="#EventDecoder.__init__-456"><span class="linenos">456</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventDecoder.__init__-457"><a href="#EventDecoder.__init__-457"><span class="linenos">457</span></a>
</span><span id="EventDecoder.__init__-458"><a href="#EventDecoder.__init__-458"><span class="linenos">458</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="EventDecoder.__init__-459"><a href="#EventDecoder.__init__-459"><span class="linenos">459</span></a>
</span><span id="EventDecoder.__init__-460"><a href="#EventDecoder.__init__-460"><span class="linenos">460</span></a>        <span class="n">projections</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="EventDecoder.__init__-461"><a href="#EventDecoder.__init__-461"><span class="linenos">461</span></a>
</span><span id="EventDecoder.__init__-462"><a href="#EventDecoder.__init__-462"><span class="linenos">462</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
</span><span id="EventDecoder.__init__-463"><a href="#EventDecoder.__init__-463"><span class="linenos">463</span></a>            <span class="k">match</span> <span class="n">field</span><span class="o">.</span><span class="n">dtype</span><span class="p">:</span>
</span><span id="EventDecoder.__init__-464"><a href="#EventDecoder.__init__-464"><span class="linenos">464</span></a>                <span class="k">case</span> <span class="s2">&quot;discrete&quot;</span><span class="p">:</span>
</span><span id="EventDecoder.__init__-465"><a href="#EventDecoder.__init__-465"><span class="linenos">465</span></a>                    <span class="n">d_target</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">n_levels</span>
</span><span id="EventDecoder.__init__-466"><a href="#EventDecoder.__init__-466"><span class="linenos">466</span></a>
</span><span id="EventDecoder.__init__-467"><a href="#EventDecoder.__init__-467"><span class="linenos">467</span></a>                <span class="k">case</span> <span class="s2">&quot;entity&quot;</span><span class="p">:</span>
</span><span id="EventDecoder.__init__-468"><a href="#EventDecoder.__init__-468"><span class="linenos">468</span></a>                    <span class="n">d_target</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_context</span>
</span><span id="EventDecoder.__init__-469"><a href="#EventDecoder.__init__-469"><span class="linenos">469</span></a>
</span><span id="EventDecoder.__init__-470"><a href="#EventDecoder.__init__-470"><span class="linenos">470</span></a>                <span class="k">case</span> <span class="s2">&quot;continuous&quot;</span><span class="p">:</span>
</span><span id="EventDecoder.__init__-471"><a href="#EventDecoder.__init__-471"><span class="linenos">471</span></a>                    <span class="n">d_target</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">n_quantiles</span>
</span><span id="EventDecoder.__init__-472"><a href="#EventDecoder.__init__-472"><span class="linenos">472</span></a>
</span><span id="EventDecoder.__init__-473"><a href="#EventDecoder.__init__-473"><span class="linenos">473</span></a>            <span class="n">projections</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span>
</span><span id="EventDecoder.__init__-474"><a href="#EventDecoder.__init__-474"><span class="linenos">474</span></a>                <span class="n">in_channels</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span>
</span><span id="EventDecoder.__init__-475"><a href="#EventDecoder.__init__-475"><span class="linenos">475</span></a>                <span class="n">out_channels</span><span class="o">=</span><span class="n">d_target</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">SPECIAL_TOKENS</span><span class="p">),</span>
</span><span id="EventDecoder.__init__-476"><a href="#EventDecoder.__init__-476"><span class="linenos">476</span></a>                <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
</span><span id="EventDecoder.__init__-477"><a href="#EventDecoder.__init__-477"><span class="linenos">477</span></a>            <span class="p">)</span>
</span><span id="EventDecoder.__init__-478"><a href="#EventDecoder.__init__-478"><span class="linenos">478</span></a>
</span><span id="EventDecoder.__init__-479"><a href="#EventDecoder.__init__-479"><span class="linenos">479</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span><span class="n">projections</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize the event decoder.</p>

<p>Args:
    params (Hyperparameters): The hyperparameters for the architecture.</p>
</div>


                            </div>
                            <div id="EventDecoder.projections" class="classattr">
                                <div class="attr variable">
            <span class="name">projections</span>

        
    </div>
    <a class="headerlink" href="#EventDecoder.projections"></a>
    
    

                            </div>
                            <div id="EventDecoder.forward" class="classattr">
                                        <input id="EventDecoder.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jaxtyped(typechecker=beartype)</div>

        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">inputs</span><span class="p">:</span> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L FC&#39;</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span><span class="p">[</span><span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N L ?&#39;</span><span class="p">]]</span>:</span></span>

                <label class="view-source-button" for="EventDecoder.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#EventDecoder.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="EventDecoder.forward-481"><a href="#EventDecoder.forward-481"><span class="linenos">481</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="EventDecoder.forward-482"><a href="#EventDecoder.forward-482"><span class="linenos">482</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span>
</span><span id="EventDecoder.forward-483"><a href="#EventDecoder.forward-483"><span class="linenos">483</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="EventDecoder.forward-484"><a href="#EventDecoder.forward-484"><span class="linenos">484</span></a>        <span class="n">inputs</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L FC&quot;</span><span class="p">],</span>
</span><span id="EventDecoder.forward-485"><a href="#EventDecoder.forward-485"><span class="linenos">485</span></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">TensorDict</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N L ?&quot;</span><span class="p">]]:</span>
</span><span id="EventDecoder.forward-486"><a href="#EventDecoder.forward-486"><span class="linenos">486</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="EventDecoder.forward-487"><a href="#EventDecoder.forward-487"><span class="linenos">487</span></a><span class="sd">        Performs the forward pass of the EventDecoder.</span>
</span><span id="EventDecoder.forward-488"><a href="#EventDecoder.forward-488"><span class="linenos">488</span></a>
</span><span id="EventDecoder.forward-489"><a href="#EventDecoder.forward-489"><span class="linenos">489</span></a><span class="sd">        Args:</span>
</span><span id="EventDecoder.forward-490"><a href="#EventDecoder.forward-490"><span class="linenos">490</span></a><span class="sd">            inputs (Float[Tensor, &quot;N L FC&quot;]): The input tensor.</span>
</span><span id="EventDecoder.forward-491"><a href="#EventDecoder.forward-491"><span class="linenos">491</span></a>
</span><span id="EventDecoder.forward-492"><a href="#EventDecoder.forward-492"><span class="linenos">492</span></a><span class="sd">        Returns:</span>
</span><span id="EventDecoder.forward-493"><a href="#EventDecoder.forward-493"><span class="linenos">493</span></a><span class="sd">            TensorDict[Float[Tensor, &quot;N L ?&quot;]]: A dictionary of output tensors for each field.</span>
</span><span id="EventDecoder.forward-494"><a href="#EventDecoder.forward-494"><span class="linenos">494</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="EventDecoder.forward-495"><a href="#EventDecoder.forward-495"><span class="linenos">495</span></a>
</span><span id="EventDecoder.forward-496"><a href="#EventDecoder.forward-496"><span class="linenos">496</span></a>        <span class="n">N</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="EventDecoder.forward-497"><a href="#EventDecoder.forward-497"><span class="linenos">497</span></a>
</span><span id="EventDecoder.forward-498"><a href="#EventDecoder.forward-498"><span class="linenos">498</span></a>        <span class="c1"># N, FC, L</span>
</span><span id="EventDecoder.forward-499"><a href="#EventDecoder.forward-499"><span class="linenos">499</span></a>        <span class="n">permuted</span> <span class="o">=</span> <span class="n">inputs</span><span class="o">.</span><span class="n">permute</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span><span id="EventDecoder.forward-500"><a href="#EventDecoder.forward-500"><span class="linenos">500</span></a>
</span><span id="EventDecoder.forward-501"><a href="#EventDecoder.forward-501"><span class="linenos">501</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="EventDecoder.forward-502"><a href="#EventDecoder.forward-502"><span class="linenos">502</span></a>
</span><span id="EventDecoder.forward-503"><a href="#EventDecoder.forward-503"><span class="linenos">503</span></a>        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">projection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="EventDecoder.forward-504"><a href="#EventDecoder.forward-504"><span class="linenos">504</span></a>            <span class="n">projected</span> <span class="o">=</span> <span class="n">projection</span><span class="p">(</span><span class="n">permuted</span><span class="p">)</span>
</span><span id="EventDecoder.forward-505"><a href="#EventDecoder.forward-505"><span class="linenos">505</span></a>            <span class="n">events</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">projected</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span><span id="EventDecoder.forward-506"><a href="#EventDecoder.forward-506"><span class="linenos">506</span></a>
</span><span id="EventDecoder.forward-507"><a href="#EventDecoder.forward-507"><span class="linenos">507</span></a>        <span class="c1"># N L ?</span>
</span><span id="EventDecoder.forward-508"><a href="#EventDecoder.forward-508"><span class="linenos">508</span></a>        <span class="k">return</span> <span class="n">TensorDict</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Performs the forward pass of the EventDecoder.</p>

<p>Args:
    inputs (Float[Tensor, "N L FC"]): The input tensor.</p>

<p>Returns:
    TensorDict[Float[Tensor, "N L ?"]]: A dictionary of output tensors for each field.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="EventDecoder.dump_patches" class="variable">dump_patches</dd>
                <dd id="EventDecoder.training" class="variable">training</dd>
                <dd id="EventDecoder.call_super_init" class="variable">call_super_init</dd>
                <dd id="EventDecoder.register_buffer" class="function">register_buffer</dd>
                <dd id="EventDecoder.register_parameter" class="function">register_parameter</dd>
                <dd id="EventDecoder.add_module" class="function">add_module</dd>
                <dd id="EventDecoder.register_module" class="function">register_module</dd>
                <dd id="EventDecoder.get_submodule" class="function">get_submodule</dd>
                <dd id="EventDecoder.get_parameter" class="function">get_parameter</dd>
                <dd id="EventDecoder.get_buffer" class="function">get_buffer</dd>
                <dd id="EventDecoder.get_extra_state" class="function">get_extra_state</dd>
                <dd id="EventDecoder.set_extra_state" class="function">set_extra_state</dd>
                <dd id="EventDecoder.apply" class="function">apply</dd>
                <dd id="EventDecoder.cuda" class="function">cuda</dd>
                <dd id="EventDecoder.ipu" class="function">ipu</dd>
                <dd id="EventDecoder.xpu" class="function">xpu</dd>
                <dd id="EventDecoder.cpu" class="function">cpu</dd>
                <dd id="EventDecoder.type" class="function">type</dd>
                <dd id="EventDecoder.float" class="function">float</dd>
                <dd id="EventDecoder.double" class="function">double</dd>
                <dd id="EventDecoder.half" class="function">half</dd>
                <dd id="EventDecoder.bfloat16" class="function">bfloat16</dd>
                <dd id="EventDecoder.to_empty" class="function">to_empty</dd>
                <dd id="EventDecoder.to" class="function">to</dd>
                <dd id="EventDecoder.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="EventDecoder.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="EventDecoder.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="EventDecoder.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="EventDecoder.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="EventDecoder.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="EventDecoder.state_dict" class="function">state_dict</dd>
                <dd id="EventDecoder.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="EventDecoder.load_state_dict" class="function">load_state_dict</dd>
                <dd id="EventDecoder.parameters" class="function">parameters</dd>
                <dd id="EventDecoder.named_parameters" class="function">named_parameters</dd>
                <dd id="EventDecoder.buffers" class="function">buffers</dd>
                <dd id="EventDecoder.named_buffers" class="function">named_buffers</dd>
                <dd id="EventDecoder.children" class="function">children</dd>
                <dd id="EventDecoder.named_children" class="function">named_children</dd>
                <dd id="EventDecoder.modules" class="function">modules</dd>
                <dd id="EventDecoder.named_modules" class="function">named_modules</dd>
                <dd id="EventDecoder.train" class="function">train</dd>
                <dd id="EventDecoder.eval" class="function">eval</dd>
                <dd id="EventDecoder.requires_grad_" class="function">requires_grad_</dd>
                <dd id="EventDecoder.zero_grad" class="function">zero_grad</dd>
                <dd id="EventDecoder.share_memory" class="function">share_memory</dd>
                <dd id="EventDecoder.extra_repr" class="function">extra_repr</dd>
                <dd id="EventDecoder.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="DecisionHead">
                            <input id="DecisionHead-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">DecisionHead</span><wbr>(<span class="base">torch.nn.modules.module.Module</span>):

                <label class="view-source-button" for="DecisionHead-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DecisionHead"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DecisionHead-511"><a href="#DecisionHead-511"><span class="linenos">511</span></a><span class="k">class</span> <span class="nc">DecisionHead</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
</span><span id="DecisionHead-512"><a href="#DecisionHead-512"><span class="linenos">512</span></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DecisionHead-513"><a href="#DecisionHead-513"><span class="linenos">513</span></a><span class="sd">    A PyTorch module representing a classification head. This module is used to map the encoded fields to the target classes.</span>
</span><span id="DecisionHead-514"><a href="#DecisionHead-514"><span class="linenos">514</span></a><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="DecisionHead-515"><a href="#DecisionHead-515"><span class="linenos">515</span></a>
</span><span id="DecisionHead-516"><a href="#DecisionHead-516"><span class="linenos">516</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="DecisionHead-517"><a href="#DecisionHead-517"><span class="linenos">517</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DecisionHead-518"><a href="#DecisionHead-518"><span class="linenos">518</span></a><span class="sd">        Initialize classification decision head.</span>
</span><span id="DecisionHead-519"><a href="#DecisionHead-519"><span class="linenos">519</span></a>
</span><span id="DecisionHead-520"><a href="#DecisionHead-520"><span class="linenos">520</span></a><span class="sd">        Args:</span>
</span><span id="DecisionHead-521"><a href="#DecisionHead-521"><span class="linenos">521</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="DecisionHead-522"><a href="#DecisionHead-522"><span class="linenos">522</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DecisionHead-523"><a href="#DecisionHead-523"><span class="linenos">523</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="DecisionHead-524"><a href="#DecisionHead-524"><span class="linenos">524</span></a>
</span><span id="DecisionHead-525"><a href="#DecisionHead-525"><span class="linenos">525</span></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="DecisionHead-526"><a href="#DecisionHead-526"><span class="linenos">526</span></a>            <span class="nb">map</span><span class="p">(</span>
</span><span id="DecisionHead-527"><a href="#DecisionHead-527"><span class="linenos">527</span></a>                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">head_shape_log_base</span><span class="o">**</span><span class="n">x</span><span class="p">,</span>
</span><span id="DecisionHead-528"><a href="#DecisionHead-528"><span class="linenos">528</span></a>                <span class="nb">range</span><span class="p">(</span>
</span><span id="DecisionHead-529"><a href="#DecisionHead-529"><span class="linenos">529</span></a>                    <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_targets</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">head_shape_log_base</span><span class="p">)),</span>
</span><span id="DecisionHead-530"><a href="#DecisionHead-530"><span class="linenos">530</span></a>                    <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">head_shape_log_base</span><span class="p">)),</span>
</span><span id="DecisionHead-531"><a href="#DecisionHead-531"><span class="linenos">531</span></a>                <span class="p">),</span>
</span><span id="DecisionHead-532"><a href="#DecisionHead-532"><span class="linenos">532</span></a>            <span class="p">)</span>
</span><span id="DecisionHead-533"><a href="#DecisionHead-533"><span class="linenos">533</span></a>        <span class="p">)</span>
</span><span id="DecisionHead-534"><a href="#DecisionHead-534"><span class="linenos">534</span></a>
</span><span id="DecisionHead-535"><a href="#DecisionHead-535"><span class="linenos">535</span></a>        <span class="n">hidden</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="DecisionHead-536"><a href="#DecisionHead-536"><span class="linenos">536</span></a>
</span><span id="DecisionHead-537"><a href="#DecisionHead-537"><span class="linenos">537</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span> <span class="o">*</span><span class="n">hidden</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">n_targets</span><span class="p">]</span>
</span><span id="DecisionHead-538"><a href="#DecisionHead-538"><span class="linenos">538</span></a>
</span><span id="DecisionHead-539"><a href="#DecisionHead-539"><span class="linenos">539</span></a>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DecisionHead-540"><a href="#DecisionHead-540"><span class="linenos">540</span></a>
</span><span id="DecisionHead-541"><a href="#DecisionHead-541"><span class="linenos">541</span></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">sizes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
</span><span id="DecisionHead-542"><a href="#DecisionHead-542"><span class="linenos">542</span></a>            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="DecisionHead-543"><a href="#DecisionHead-543"><span class="linenos">543</span></a>                <span class="n">activation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="DecisionHead-544"><a href="#DecisionHead-544"><span class="linenos">544</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DecisionHead-545"><a href="#DecisionHead-545"><span class="linenos">545</span></a>                <span class="n">activation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
</span><span id="DecisionHead-546"><a href="#DecisionHead-546"><span class="linenos">546</span></a>
</span><span id="DecisionHead-547"><a href="#DecisionHead-547"><span class="linenos">547</span></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="DecisionHead-548"><a href="#DecisionHead-548"><span class="linenos">548</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="DecisionHead-549"><a href="#DecisionHead-549"><span class="linenos">549</span></a>                    <span class="n">OrderedDict</span><span class="p">(</span>
</span><span id="DecisionHead-550"><a href="#DecisionHead-550"><span class="linenos">550</span></a>                        <span class="p">[</span>
</span><span id="DecisionHead-551"><a href="#DecisionHead-551"><span class="linenos">551</span></a>                            <span class="p">(</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="o">*</span><span class="n">sizes</span><span class="p">)),</span>
</span><span id="DecisionHead-552"><a href="#DecisionHead-552"><span class="linenos">552</span></a>                            <span class="p">(</span><span class="s2">&quot;act&quot;</span><span class="p">,</span> <span class="n">activation</span><span class="p">),</span>
</span><span id="DecisionHead-553"><a href="#DecisionHead-553"><span class="linenos">553</span></a>                        <span class="p">]</span>
</span><span id="DecisionHead-554"><a href="#DecisionHead-554"><span class="linenos">554</span></a>                    <span class="p">)</span>
</span><span id="DecisionHead-555"><a href="#DecisionHead-555"><span class="linenos">555</span></a>                <span class="p">)</span>
</span><span id="DecisionHead-556"><a href="#DecisionHead-556"><span class="linenos">556</span></a>            <span class="p">)</span>
</span><span id="DecisionHead-557"><a href="#DecisionHead-557"><span class="linenos">557</span></a>
</span><span id="DecisionHead-558"><a href="#DecisionHead-558"><span class="linenos">558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
</span><span id="DecisionHead-559"><a href="#DecisionHead-559"><span class="linenos">559</span></a>
</span><span id="DecisionHead-560"><a href="#DecisionHead-560"><span class="linenos">560</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N FC&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N T&quot;</span><span class="p">]:</span>
</span><span id="DecisionHead-561"><a href="#DecisionHead-561"><span class="linenos">561</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DecisionHead-562"><a href="#DecisionHead-562"><span class="linenos">562</span></a><span class="sd">        Defines the forward pass of the ClassificationHead.</span>
</span><span id="DecisionHead-563"><a href="#DecisionHead-563"><span class="linenos">563</span></a>
</span><span id="DecisionHead-564"><a href="#DecisionHead-564"><span class="linenos">564</span></a><span class="sd">        Args:</span>
</span><span id="DecisionHead-565"><a href="#DecisionHead-565"><span class="linenos">565</span></a><span class="sd">            inputs (torch.Tensor): The input tensor.</span>
</span><span id="DecisionHead-566"><a href="#DecisionHead-566"><span class="linenos">566</span></a>
</span><span id="DecisionHead-567"><a href="#DecisionHead-567"><span class="linenos">567</span></a><span class="sd">        Returns:</span>
</span><span id="DecisionHead-568"><a href="#DecisionHead-568"><span class="linenos">568</span></a><span class="sd">            torch.Tensor: The output of the MLP.</span>
</span><span id="DecisionHead-569"><a href="#DecisionHead-569"><span class="linenos">569</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DecisionHead-570"><a href="#DecisionHead-570"><span class="linenos">570</span></a>
</span><span id="DecisionHead-571"><a href="#DecisionHead-571"><span class="linenos">571</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>A PyTorch module representing a classification head. This module is used to map the encoded fields to the target classes.</p>
</div>


                            <div id="DecisionHead.__init__" class="classattr">
                                        <input id="DecisionHead.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">DecisionHead</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span></span>)</span>

                <label class="view-source-button" for="DecisionHead.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DecisionHead.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DecisionHead.__init__-516"><a href="#DecisionHead.__init__-516"><span class="linenos">516</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">):</span>
</span><span id="DecisionHead.__init__-517"><a href="#DecisionHead.__init__-517"><span class="linenos">517</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DecisionHead.__init__-518"><a href="#DecisionHead.__init__-518"><span class="linenos">518</span></a><span class="sd">        Initialize classification decision head.</span>
</span><span id="DecisionHead.__init__-519"><a href="#DecisionHead.__init__-519"><span class="linenos">519</span></a>
</span><span id="DecisionHead.__init__-520"><a href="#DecisionHead.__init__-520"><span class="linenos">520</span></a><span class="sd">        Args:</span>
</span><span id="DecisionHead.__init__-521"><a href="#DecisionHead.__init__-521"><span class="linenos">521</span></a><span class="sd">            params (Hyperparameters): The hyperparameters for the architecture.</span>
</span><span id="DecisionHead.__init__-522"><a href="#DecisionHead.__init__-522"><span class="linenos">522</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DecisionHead.__init__-523"><a href="#DecisionHead.__init__-523"><span class="linenos">523</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="DecisionHead.__init__-524"><a href="#DecisionHead.__init__-524"><span class="linenos">524</span></a>
</span><span id="DecisionHead.__init__-525"><a href="#DecisionHead.__init__-525"><span class="linenos">525</span></a>        <span class="n">hidden</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
</span><span id="DecisionHead.__init__-526"><a href="#DecisionHead.__init__-526"><span class="linenos">526</span></a>            <span class="nb">map</span><span class="p">(</span>
</span><span id="DecisionHead.__init__-527"><a href="#DecisionHead.__init__-527"><span class="linenos">527</span></a>                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">params</span><span class="o">.</span><span class="n">head_shape_log_base</span><span class="o">**</span><span class="n">x</span><span class="p">,</span>
</span><span id="DecisionHead.__init__-528"><a href="#DecisionHead.__init__-528"><span class="linenos">528</span></a>                <span class="nb">range</span><span class="p">(</span>
</span><span id="DecisionHead.__init__-529"><a href="#DecisionHead.__init__-529"><span class="linenos">529</span></a>                    <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_targets</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">head_shape_log_base</span><span class="p">)),</span>
</span><span id="DecisionHead.__init__-530"><a href="#DecisionHead.__init__-530"><span class="linenos">530</span></a>                    <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">head_shape_log_base</span><span class="p">)),</span>
</span><span id="DecisionHead.__init__-531"><a href="#DecisionHead.__init__-531"><span class="linenos">531</span></a>                <span class="p">),</span>
</span><span id="DecisionHead.__init__-532"><a href="#DecisionHead.__init__-532"><span class="linenos">532</span></a>            <span class="p">)</span>
</span><span id="DecisionHead.__init__-533"><a href="#DecisionHead.__init__-533"><span class="linenos">533</span></a>        <span class="p">)</span>
</span><span id="DecisionHead.__init__-534"><a href="#DecisionHead.__init__-534"><span class="linenos">534</span></a>
</span><span id="DecisionHead.__init__-535"><a href="#DecisionHead.__init__-535"><span class="linenos">535</span></a>        <span class="n">hidden</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
</span><span id="DecisionHead.__init__-536"><a href="#DecisionHead.__init__-536"><span class="linenos">536</span></a>
</span><span id="DecisionHead.__init__-537"><a href="#DecisionHead.__init__-537"><span class="linenos">537</span></a>        <span class="n">dims</span> <span class="o">=</span> <span class="p">[</span><span class="n">params</span><span class="o">.</span><span class="n">n_fields</span> <span class="o">*</span> <span class="n">params</span><span class="o">.</span><span class="n">d_field</span><span class="p">,</span> <span class="o">*</span><span class="n">hidden</span><span class="p">,</span> <span class="n">params</span><span class="o">.</span><span class="n">n_targets</span><span class="p">]</span>
</span><span id="DecisionHead.__init__-538"><a href="#DecisionHead.__init__-538"><span class="linenos">538</span></a>
</span><span id="DecisionHead.__init__-539"><a href="#DecisionHead.__init__-539"><span class="linenos">539</span></a>        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="DecisionHead.__init__-540"><a href="#DecisionHead.__init__-540"><span class="linenos">540</span></a>
</span><span id="DecisionHead.__init__-541"><a href="#DecisionHead.__init__-541"><span class="linenos">541</span></a>        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">sizes</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">dims</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">dims</span><span class="p">[</span><span class="mi">1</span><span class="p">:])):</span>
</span><span id="DecisionHead.__init__-542"><a href="#DecisionHead.__init__-542"><span class="linenos">542</span></a>            <span class="k">if</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="DecisionHead.__init__-543"><a href="#DecisionHead.__init__-543"><span class="linenos">543</span></a>                <span class="n">activation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
</span><span id="DecisionHead.__init__-544"><a href="#DecisionHead.__init__-544"><span class="linenos">544</span></a>            <span class="k">else</span><span class="p">:</span>
</span><span id="DecisionHead.__init__-545"><a href="#DecisionHead.__init__-545"><span class="linenos">545</span></a>                <span class="n">activation</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>
</span><span id="DecisionHead.__init__-546"><a href="#DecisionHead.__init__-546"><span class="linenos">546</span></a>
</span><span id="DecisionHead.__init__-547"><a href="#DecisionHead.__init__-547"><span class="linenos">547</span></a>            <span class="n">layers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="DecisionHead.__init__-548"><a href="#DecisionHead.__init__-548"><span class="linenos">548</span></a>                <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
</span><span id="DecisionHead.__init__-549"><a href="#DecisionHead.__init__-549"><span class="linenos">549</span></a>                    <span class="n">OrderedDict</span><span class="p">(</span>
</span><span id="DecisionHead.__init__-550"><a href="#DecisionHead.__init__-550"><span class="linenos">550</span></a>                        <span class="p">[</span>
</span><span id="DecisionHead.__init__-551"><a href="#DecisionHead.__init__-551"><span class="linenos">551</span></a>                            <span class="p">(</span><span class="s2">&quot;dense&quot;</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="o">*</span><span class="n">sizes</span><span class="p">)),</span>
</span><span id="DecisionHead.__init__-552"><a href="#DecisionHead.__init__-552"><span class="linenos">552</span></a>                            <span class="p">(</span><span class="s2">&quot;act&quot;</span><span class="p">,</span> <span class="n">activation</span><span class="p">),</span>
</span><span id="DecisionHead.__init__-553"><a href="#DecisionHead.__init__-553"><span class="linenos">553</span></a>                        <span class="p">]</span>
</span><span id="DecisionHead.__init__-554"><a href="#DecisionHead.__init__-554"><span class="linenos">554</span></a>                    <span class="p">)</span>
</span><span id="DecisionHead.__init__-555"><a href="#DecisionHead.__init__-555"><span class="linenos">555</span></a>                <span class="p">)</span>
</span><span id="DecisionHead.__init__-556"><a href="#DecisionHead.__init__-556"><span class="linenos">556</span></a>            <span class="p">)</span>
</span><span id="DecisionHead.__init__-557"><a href="#DecisionHead.__init__-557"><span class="linenos">557</span></a>
</span><span id="DecisionHead.__init__-558"><a href="#DecisionHead.__init__-558"><span class="linenos">558</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Initialize classification decision head.</p>

<p>Args:
    params (Hyperparameters): The hyperparameters for the architecture.</p>
</div>


                            </div>
                            <div id="DecisionHead.mlp" class="classattr">
                                <div class="attr variable">
            <span class="name">mlp</span>

        
    </div>
    <a class="headerlink" href="#DecisionHead.mlp"></a>
    
    

                            </div>
                            <div id="DecisionHead.forward" class="classattr">
                                        <input id="DecisionHead.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">inputs</span><span class="p">:</span> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N FC&#39;</span><span class="p">]</span></span><span class="return-annotation">) -> <span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N T&#39;</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="DecisionHead.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#DecisionHead.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="DecisionHead.forward-560"><a href="#DecisionHead.forward-560"><span class="linenos">560</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N FC&quot;</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N T&quot;</span><span class="p">]:</span>
</span><span id="DecisionHead.forward-561"><a href="#DecisionHead.forward-561"><span class="linenos">561</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="DecisionHead.forward-562"><a href="#DecisionHead.forward-562"><span class="linenos">562</span></a><span class="sd">        Defines the forward pass of the ClassificationHead.</span>
</span><span id="DecisionHead.forward-563"><a href="#DecisionHead.forward-563"><span class="linenos">563</span></a>
</span><span id="DecisionHead.forward-564"><a href="#DecisionHead.forward-564"><span class="linenos">564</span></a><span class="sd">        Args:</span>
</span><span id="DecisionHead.forward-565"><a href="#DecisionHead.forward-565"><span class="linenos">565</span></a><span class="sd">            inputs (torch.Tensor): The input tensor.</span>
</span><span id="DecisionHead.forward-566"><a href="#DecisionHead.forward-566"><span class="linenos">566</span></a>
</span><span id="DecisionHead.forward-567"><a href="#DecisionHead.forward-567"><span class="linenos">567</span></a><span class="sd">        Returns:</span>
</span><span id="DecisionHead.forward-568"><a href="#DecisionHead.forward-568"><span class="linenos">568</span></a><span class="sd">            torch.Tensor: The output of the MLP.</span>
</span><span id="DecisionHead.forward-569"><a href="#DecisionHead.forward-569"><span class="linenos">569</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="DecisionHead.forward-570"><a href="#DecisionHead.forward-570"><span class="linenos">570</span></a>
</span><span id="DecisionHead.forward-571"><a href="#DecisionHead.forward-571"><span class="linenos">571</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Defines the forward pass of the ClassificationHead.</p>

<p>Args:
    inputs (torch.Tensor): The input tensor.</p>

<p>Returns:
    torch.Tensor: The output of the MLP.</p>
</div>


                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="DecisionHead.dump_patches" class="variable">dump_patches</dd>
                <dd id="DecisionHead.training" class="variable">training</dd>
                <dd id="DecisionHead.call_super_init" class="variable">call_super_init</dd>
                <dd id="DecisionHead.register_buffer" class="function">register_buffer</dd>
                <dd id="DecisionHead.register_parameter" class="function">register_parameter</dd>
                <dd id="DecisionHead.add_module" class="function">add_module</dd>
                <dd id="DecisionHead.register_module" class="function">register_module</dd>
                <dd id="DecisionHead.get_submodule" class="function">get_submodule</dd>
                <dd id="DecisionHead.get_parameter" class="function">get_parameter</dd>
                <dd id="DecisionHead.get_buffer" class="function">get_buffer</dd>
                <dd id="DecisionHead.get_extra_state" class="function">get_extra_state</dd>
                <dd id="DecisionHead.set_extra_state" class="function">set_extra_state</dd>
                <dd id="DecisionHead.apply" class="function">apply</dd>
                <dd id="DecisionHead.cuda" class="function">cuda</dd>
                <dd id="DecisionHead.ipu" class="function">ipu</dd>
                <dd id="DecisionHead.xpu" class="function">xpu</dd>
                <dd id="DecisionHead.cpu" class="function">cpu</dd>
                <dd id="DecisionHead.type" class="function">type</dd>
                <dd id="DecisionHead.float" class="function">float</dd>
                <dd id="DecisionHead.double" class="function">double</dd>
                <dd id="DecisionHead.half" class="function">half</dd>
                <dd id="DecisionHead.bfloat16" class="function">bfloat16</dd>
                <dd id="DecisionHead.to_empty" class="function">to_empty</dd>
                <dd id="DecisionHead.to" class="function">to</dd>
                <dd id="DecisionHead.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="DecisionHead.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="DecisionHead.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="DecisionHead.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="DecisionHead.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="DecisionHead.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="DecisionHead.state_dict" class="function">state_dict</dd>
                <dd id="DecisionHead.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="DecisionHead.load_state_dict" class="function">load_state_dict</dd>
                <dd id="DecisionHead.parameters" class="function">parameters</dd>
                <dd id="DecisionHead.named_parameters" class="function">named_parameters</dd>
                <dd id="DecisionHead.buffers" class="function">buffers</dd>
                <dd id="DecisionHead.named_buffers" class="function">named_buffers</dd>
                <dd id="DecisionHead.children" class="function">children</dd>
                <dd id="DecisionHead.named_children" class="function">named_children</dd>
                <dd id="DecisionHead.modules" class="function">modules</dd>
                <dd id="DecisionHead.named_modules" class="function">named_modules</dd>
                <dd id="DecisionHead.train" class="function">train</dd>
                <dd id="DecisionHead.eval" class="function">eval</dd>
                <dd id="DecisionHead.requires_grad_" class="function">requires_grad_</dd>
                <dd id="DecisionHead.zero_grad" class="function">zero_grad</dd>
                <dd id="DecisionHead.share_memory" class="function">share_memory</dd>
                <dd id="DecisionHead.extra_repr" class="function">extra_repr</dd>
                <dd id="DecisionHead.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
                <section id="create_metrics">
                            <input id="create_metrics-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">create_metrics</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">container</span><span class="o">.</span><span class="n">ModuleDict</span>:</span></span>

                <label class="view-source-button" for="create_metrics-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#create_metrics"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="create_metrics-574"><a href="#create_metrics-574"><span class="linenos">574</span></a><span class="k">def</span> <span class="nf">create_metrics</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">:</span>
</span><span id="create_metrics-575"><a href="#create_metrics-575"><span class="linenos">575</span></a>    <span class="n">metrics</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="create_metrics-576"><a href="#create_metrics-576"><span class="linenos">576</span></a>        <span class="n">ap</span><span class="o">=</span><span class="n">torchmetrics</span><span class="o">.</span><span class="n">AveragePrecision</span><span class="p">,</span>
</span><span id="create_metrics-577"><a href="#create_metrics-577"><span class="linenos">577</span></a>        <span class="n">f1</span><span class="o">=</span><span class="n">torchmetrics</span><span class="o">.</span><span class="n">F1Score</span><span class="p">,</span>
</span><span id="create_metrics-578"><a href="#create_metrics-578"><span class="linenos">578</span></a>        <span class="n">auc</span><span class="o">=</span><span class="n">torchmetrics</span><span class="o">.</span><span class="n">AUROC</span><span class="p">,</span>
</span><span id="create_metrics-579"><a href="#create_metrics-579"><span class="linenos">579</span></a>        <span class="n">acc</span><span class="o">=</span><span class="n">torchmetrics</span><span class="o">.</span><span class="n">Accuracy</span><span class="p">,</span>
</span><span id="create_metrics-580"><a href="#create_metrics-580"><span class="linenos">580</span></a>    <span class="p">)</span>
</span><span id="create_metrics-581"><a href="#create_metrics-581"><span class="linenos">581</span></a>
</span><span id="create_metrics-582"><a href="#create_metrics-582"><span class="linenos">582</span></a>    <span class="n">stratas</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(</span>
</span><span id="create_metrics-583"><a href="#create_metrics-583"><span class="linenos">583</span></a>        <span class="p">{</span>
</span><span id="create_metrics-584"><a href="#create_metrics-584"><span class="linenos">584</span></a>            <span class="s2">&quot;train_metrics&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(),</span>
</span><span id="create_metrics-585"><a href="#create_metrics-585"><span class="linenos">585</span></a>            <span class="s2">&quot;valid_metrics&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(),</span>
</span><span id="create_metrics-586"><a href="#create_metrics-586"><span class="linenos">586</span></a>            <span class="s2">&quot;test_metrics&quot;</span><span class="p">:</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">ModuleDict</span><span class="p">(),</span>
</span><span id="create_metrics-587"><a href="#create_metrics-587"><span class="linenos">587</span></a>        <span class="p">}</span>
</span><span id="create_metrics-588"><a href="#create_metrics-588"><span class="linenos">588</span></a>    <span class="p">)</span>
</span><span id="create_metrics-589"><a href="#create_metrics-589"><span class="linenos">589</span></a>
</span><span id="create_metrics-590"><a href="#create_metrics-590"><span class="linenos">590</span></a>    <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">task</span><span class="o">=</span><span class="s2">&quot;multiclass&quot;</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="n">params</span><span class="o">.</span><span class="n">n_targets</span><span class="p">)</span>
</span><span id="create_metrics-591"><a href="#create_metrics-591"><span class="linenos">591</span></a>
</span><span id="create_metrics-592"><a href="#create_metrics-592"><span class="linenos">592</span></a>    <span class="k">for</span> <span class="n">strata</span> <span class="ow">in</span> <span class="n">stratas</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
</span><span id="create_metrics-593"><a href="#create_metrics-593"><span class="linenos">593</span></a>        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">Metric</span> <span class="ow">in</span> <span class="n">metrics</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="create_metrics-594"><a href="#create_metrics-594"><span class="linenos">594</span></a>            <span class="n">stratas</span><span class="p">[</span><span class="n">strata</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Metric</span><span class="p">(</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>
</span><span id="create_metrics-595"><a href="#create_metrics-595"><span class="linenos">595</span></a>
</span><span id="create_metrics-596"><a href="#create_metrics-596"><span class="linenos">596</span></a>    <span class="k">return</span> <span class="n">stratas</span>
</span></pre></div>


    

                </section>
                <section id="step">
                            <input id="step-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">step</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span><span class="p">:</span> <span class="n"><a href="#SequenceModule">SequenceModule</a></span>,</span><span class="param">	<span class="n">batch</span><span class="p">:</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span> <span class="o">|</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span><span class="p">,</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span><span class="p">]</span>,</span><span class="param">	<span class="n">strata</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">Tensor</span> <span class="o">|</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span>:</span></span>

                <label class="view-source-button" for="step-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#step"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="step-599"><a href="#step-599"><span class="linenos">599</span></a><span class="k">def</span> <span class="nf">step</span><span class="p">(</span>
</span><span id="step-600"><a href="#step-600"><span class="linenos">600</span></a>    <span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;SequenceModule&quot;</span><span class="p">,</span>
</span><span id="step-601"><a href="#step-601"><span class="linenos">601</span></a>    <span class="n">batch</span><span class="p">:</span> <span class="n">TensorDict</span><span class="o">|</span><span class="nb">tuple</span><span class="p">[</span><span class="n">TensorDict</span><span class="p">,</span> <span class="n">TensorDict</span><span class="p">],</span>
</span><span id="step-602"><a href="#step-602"><span class="linenos">602</span></a>    <span class="n">strata</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="step-603"><a href="#step-603"><span class="linenos">603</span></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tensor</span> <span class="o">|</span> <span class="n">TensorDict</span><span class="p">:</span>
</span><span id="step-604"><a href="#step-604"><span class="linenos">604</span></a>    <span class="k">assert</span> <span class="n">strata</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="step-605"><a href="#step-605"><span class="linenos">605</span></a>    
</span><span id="step-606"><a href="#step-606"><span class="linenos">606</span></a>    <span class="n">log</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span>
</span><span id="step-607"><a href="#step-607"><span class="linenos">607</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
</span><span id="step-608"><a href="#step-608"><span class="linenos">608</span></a>        <span class="n">on_step</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="step-609"><a href="#step-609"><span class="linenos">609</span></a>        <span class="n">on_epoch</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="step-610"><a href="#step-610"><span class="linenos">610</span></a>        <span class="n">batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">batch_size</span><span class="p">,</span>
</span><span id="step-611"><a href="#step-611"><span class="linenos">611</span></a>    <span class="p">)</span>
</span><span id="step-612"><a href="#step-612"><span class="linenos">612</span></a>
</span><span id="step-613"><a href="#step-613"><span class="linenos">613</span></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;pretrain&quot;</span><span class="p">:</span>
</span><span id="step-614"><a href="#step-614"><span class="linenos">614</span></a>        <span class="n">masked</span><span class="p">,</span> <span class="n">targets</span> <span class="o">=</span> <span class="n">batch</span>
</span><span id="step-615"><a href="#step-615"><span class="linenos">615</span></a>        <span class="n">_</span><span class="p">,</span> <span class="n">reconstruction</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">masked</span><span class="p">)</span>
</span><span id="step-616"><a href="#step-616"><span class="linenos">616</span></a>
</span><span id="step-617"><a href="#step-617"><span class="linenos">617</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">strata</span> <span class="o">==</span> <span class="s1">&#39;predict&#39;</span><span class="p">):</span>
</span><span id="step-618"><a href="#step-618"><span class="linenos">618</span></a>            <span class="k">return</span> <span class="n">reconstruction</span>
</span><span id="step-619"><a href="#step-619"><span class="linenos">619</span></a>
</span><span id="step-620"><a href="#step-620"><span class="linenos">620</span></a>        <span class="n">losses</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="step-621"><a href="#step-621"><span class="linenos">621</span></a>
</span><span id="step-622"><a href="#step-622"><span class="linenos">622</span></a>        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
</span><span id="step-623"><a href="#step-623"><span class="linenos">623</span></a>            <span class="n">loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">reconstruction</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">],</span> <span class="n">targets</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>
</span><span id="step-624"><a href="#step-624"><span class="linenos">624</span></a>            <span class="n">losses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span>
</span><span id="step-625"><a href="#step-625"><span class="linenos">625</span></a>            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">-loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
</span><span id="step-626"><a href="#step-626"><span class="linenos">626</span></a>
</span><span id="step-627"><a href="#step-627"><span class="linenos">627</span></a>        <span class="n">total_loss</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">losses</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</span><span id="step-628"><a href="#step-628"><span class="linenos">628</span></a>        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">/loss&#39;</span><span class="p">,</span> <span class="n">total_loss</span><span class="p">)</span>
</span><span id="step-629"><a href="#step-629"><span class="linenos">629</span></a>        <span class="k">return</span> <span class="n">total_loss</span>
</span><span id="step-630"><a href="#step-630"><span class="linenos">630</span></a>
</span><span id="step-631"><a href="#step-631"><span class="linenos">631</span></a>    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;finetune&quot;</span><span class="p">:</span>
</span><span id="step-632"><a href="#step-632"><span class="linenos">632</span></a>        <span class="n">representations</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
</span><span id="step-633"><a href="#step-633"><span class="linenos">633</span></a>
</span><span id="step-634"><a href="#step-634"><span class="linenos">634</span></a>        <span class="k">if</span> <span class="p">(</span><span class="n">strata</span> <span class="o">==</span> <span class="s1">&#39;predict&#39;</span><span class="p">):</span>
</span><span id="step-635"><a href="#step-635"><span class="linenos">635</span></a>            <span class="k">return</span> <span class="n">representations</span>
</span><span id="step-636"><a href="#step-636"><span class="linenos">636</span></a>        
</span><span id="step-637"><a href="#step-637"><span class="linenos">637</span></a>        <span class="n">labels</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">]</span>
</span><span id="step-638"><a href="#step-638"><span class="linenos">638</span></a>
</span><span id="step-639"><a href="#step-639"><span class="linenos">639</span></a>        <span class="n">loss</span> <span class="o">=</span> <span class="n">cross_entropy</span><span class="p">(</span><span class="n">representations</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</span><span id="step-640"><a href="#step-640"><span class="linenos">640</span></a>        <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">/loss&#39;</span><span class="p">,</span> <span class="n">loss</span><span class="p">)</span>
</span><span id="step-641"><a href="#step-641"><span class="linenos">641</span></a>        
</span><span id="step-642"><a href="#step-642"><span class="linenos">642</span></a>        <span class="n">logits</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">nn</span><span class="o">.</span><span class="n">functional</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="n">representations</span><span class="p">)</span>
</span><span id="step-643"><a href="#step-643"><span class="linenos">643</span></a>        
</span><span id="step-644"><a href="#step-644"><span class="linenos">644</span></a>        <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">metric</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">_metrics&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="step-645"><a href="#step-645"><span class="linenos">645</span></a>            <span class="n">metric</span><span class="p">(</span><span class="n">logits</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
</span><span id="step-646"><a href="#step-646"><span class="linenos">646</span></a>            <span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="si">}</span><span class="s1">-</span><span class="si">{</span><span class="n">strata</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">title</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
</span><span id="step-647"><a href="#step-647"><span class="linenos">647</span></a>        
</span><span id="step-648"><a href="#step-648"><span class="linenos">648</span></a>        <span class="k">return</span> <span class="n">loss</span>
</span></pre></div>


    

                </section>
                <section id="dataloader">
                            <input id="dataloader-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">dataloader</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span><span class="p">:</span> <span class="n"><a href="#SequenceModule">SequenceModule</a></span>,</span><span class="param">	<span class="n">strata</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">) -> <span class="n">torchdata</span><span class="o">.</span><span class="n">dataloader2</span><span class="o">.</span><span class="n">dataloader2</span><span class="o">.</span><span class="n">DataLoader2</span>:</span></span>

                <label class="view-source-button" for="dataloader-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#dataloader"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="dataloader-652"><a href="#dataloader-652"><span class="linenos">652</span></a><span class="k">def</span> <span class="nf">dataloader</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="s2">&quot;SequenceModule&quot;</span><span class="p">,</span> <span class="n">strata</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">DataLoader2</span><span class="p">:</span>
</span><span id="dataloader-653"><a href="#dataloader-653"><span class="linenos">653</span></a>    <span class="k">assert</span> <span class="n">strata</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="dataloader-654"><a href="#dataloader-654"><span class="linenos">654</span></a>
</span><span id="dataloader-655"><a href="#dataloader-655"><span class="linenos">655</span></a>    <span class="n">pipe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">[</span><span class="n">strata</span><span class="p">]</span>
</span><span id="dataloader-656"><a href="#dataloader-656"><span class="linenos">656</span></a>    <span class="c1"># rs = MultiProcessingReadingService(num_workers=2)</span>
</span><span id="dataloader-657"><a href="#dataloader-657"><span class="linenos">657</span></a>    <span class="n">loader</span> <span class="o">=</span> <span class="n">DataLoader2</span><span class="p">(</span><span class="n">pipe</span><span class="p">)</span> <span class="c1">#, reading_service=rs)</span>
</span><span id="dataloader-658"><a href="#dataloader-658"><span class="linenos">658</span></a>    <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">loader</span><span class="p">)</span>
</span><span id="dataloader-659"><a href="#dataloader-659"><span class="linenos">659</span></a>
</span><span id="dataloader-660"><a href="#dataloader-660"><span class="linenos">660</span></a>    <span class="k">return</span> <span class="n">loader</span>
</span></pre></div>


    

                </section>
                <section id="SequenceModule">
                            <input id="SequenceModule-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr class">
            
    <span class="def">class</span>
    <span class="name">SequenceModule</span><wbr>(<span class="base">lightning.pytorch.core.module.LightningModule</span>):

                <label class="view-source-button" for="SequenceModule-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SequenceModule"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SequenceModule-663"><a href="#SequenceModule-663"><span class="linenos">663</span></a><span class="k">class</span> <span class="nc">SequenceModule</span><span class="p">(</span><span class="n">lit</span><span class="o">.</span><span class="n">LightningModule</span><span class="p">):</span>
</span><span id="SequenceModule-664"><a href="#SequenceModule-664"><span class="linenos">664</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="SequenceModule-665"><a href="#SequenceModule-665"><span class="linenos">665</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SequenceModule-666"><a href="#SequenceModule-666"><span class="linenos">666</span></a>        <span class="n">datapath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span>
</span><span id="SequenceModule-667"><a href="#SequenceModule-667"><span class="linenos">667</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span>
</span><span id="SequenceModule-668"><a href="#SequenceModule-668"><span class="linenos">668</span></a>        <span class="n">digests</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TDigest</span><span class="p">],</span>
</span><span id="SequenceModule-669"><a href="#SequenceModule-669"><span class="linenos">669</span></a>    <span class="p">):</span>
</span><span id="SequenceModule-670"><a href="#SequenceModule-670"><span class="linenos">670</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="SequenceModule-671"><a href="#SequenceModule-671"><span class="linenos">671</span></a>
</span><span id="SequenceModule-672"><a href="#SequenceModule-672"><span class="linenos">672</span></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
</span><span id="SequenceModule-673"><a href="#SequenceModule-673"><span class="linenos">673</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">Hyperparameters</span><span class="p">)</span>
</span><span id="SequenceModule-674"><a href="#SequenceModule-674"><span class="linenos">674</span></a>
</span><span id="SequenceModule-675"><a href="#SequenceModule-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="n">datapath</span>
</span><span id="SequenceModule-676"><a href="#SequenceModule-676"><span class="linenos">676</span></a>
</span><span id="SequenceModule-677"><a href="#SequenceModule-677"><span class="linenos">677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span> <span class="o">=</span> <span class="n">params</span>
</span><span id="SequenceModule-678"><a href="#SequenceModule-678"><span class="linenos">678</span></a>
</span><span id="SequenceModule-679"><a href="#SequenceModule-679"><span class="linenos">679</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modular_field_embedder</span> <span class="o">=</span> <span class="n">ModularAttributeEmbeddingSystem</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule-680"><a href="#SequenceModule-680"><span class="linenos">680</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field_encoder</span> <span class="o">=</span> <span class="n">FieldEncoder</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule-681"><a href="#SequenceModule-681"><span class="linenos">681</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_encoder</span> <span class="o">=</span> <span class="n">EventEncoder</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule-682"><a href="#SequenceModule-682"><span class="linenos">682</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_decoder</span> <span class="o">=</span> <span class="n">EventDecoder</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule-683"><a href="#SequenceModule-683"><span class="linenos">683</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decision_head</span> <span class="o">=</span> <span class="n">DecisionHead</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule-684"><a href="#SequenceModule-684"><span class="linenos">684</span></a>
</span><span id="SequenceModule-685"><a href="#SequenceModule-685"><span class="linenos">685</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">create_metrics</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule-686"><a href="#SequenceModule-686"><span class="linenos">686</span></a>
</span><span id="SequenceModule-687"><a href="#SequenceModule-687"><span class="linenos">687</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pretrain&quot;</span>
</span><span id="SequenceModule-688"><a href="#SequenceModule-688"><span class="linenos">688</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">digests</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TDigest</span><span class="p">]</span> <span class="o">=</span> <span class="n">digests</span>
</span><span id="SequenceModule-689"><a href="#SequenceModule-689"><span class="linenos">689</span></a>
</span><span id="SequenceModule-690"><a href="#SequenceModule-690"><span class="linenos">690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataLoader2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SequenceModule-691"><a href="#SequenceModule-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datapipes</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">IterDataPipe</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SequenceModule-692"><a href="#SequenceModule-692"><span class="linenos">692</span></a>        
</span><span id="SequenceModule-693"><a href="#SequenceModule-693"><span class="linenos">693</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">example_input_array</span> <span class="o">=</span> <span class="n">mock</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule-694"><a href="#SequenceModule-694"><span class="linenos">694</span></a>
</span><span id="SequenceModule-695"><a href="#SequenceModule-695"><span class="linenos">695</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="SequenceModule-696"><a href="#SequenceModule-696"><span class="linenos">696</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N T&quot;</span><span class="p">],</span> <span class="n">TensorDict</span><span class="p">]:</span>
</span><span id="SequenceModule-697"><a href="#SequenceModule-697"><span class="linenos">697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SequenceModule-698"><a href="#SequenceModule-698"><span class="linenos">698</span></a><span class="sd">        Performs the forward pass of the encoder.</span>
</span><span id="SequenceModule-699"><a href="#SequenceModule-699"><span class="linenos">699</span></a>
</span><span id="SequenceModule-700"><a href="#SequenceModule-700"><span class="linenos">700</span></a><span class="sd">        Args:</span>
</span><span id="SequenceModule-701"><a href="#SequenceModule-701"><span class="linenos">701</span></a><span class="sd">            events (Float[Tensor, &quot;N L FC&quot;]): The input tensor.</span>
</span><span id="SequenceModule-702"><a href="#SequenceModule-702"><span class="linenos">702</span></a>
</span><span id="SequenceModule-703"><a href="#SequenceModule-703"><span class="linenos">703</span></a><span class="sd">        Returns:</span>
</span><span id="SequenceModule-704"><a href="#SequenceModule-704"><span class="linenos">704</span></a><span class="sd">            tuple[Tensor, TensorDict]:</span>
</span><span id="SequenceModule-705"><a href="#SequenceModule-705"><span class="linenos">705</span></a><span class="sd">            A tuple containing two tensors. The first tensor represents the supervised classification predictions and the second tensor represents the decoded, reconstructed events.</span>
</span><span id="SequenceModule-706"><a href="#SequenceModule-706"><span class="linenos">706</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SequenceModule-707"><a href="#SequenceModule-707"><span class="linenos">707</span></a>
</span><span id="SequenceModule-708"><a href="#SequenceModule-708"><span class="linenos">708</span></a>        <span class="n">field_mask</span><span class="p">,</span> <span class="n">event_mask</span> <span class="o">=</span> <span class="n">create_attention_masks</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
</span><span id="SequenceModule-709"><a href="#SequenceModule-709"><span class="linenos">709</span></a>
</span><span id="SequenceModule-710"><a href="#SequenceModule-710"><span class="linenos">710</span></a>        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modular_field_embedder</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="SequenceModule-711"><a href="#SequenceModule-711"><span class="linenos">711</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_encoder</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">field_mask</span><span class="p">)</span>
</span><span id="SequenceModule-712"><a href="#SequenceModule-712"><span class="linenos">712</span></a>        <span class="n">sequence</span><span class="p">,</span> <span class="n">representations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_encoder</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">event_mask</span><span class="p">)</span>
</span><span id="SequenceModule-713"><a href="#SequenceModule-713"><span class="linenos">713</span></a>
</span><span id="SequenceModule-714"><a href="#SequenceModule-714"><span class="linenos">714</span></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_head</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
</span><span id="SequenceModule-715"><a href="#SequenceModule-715"><span class="linenos">715</span></a>        <span class="n">reconstructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_decoder</span><span class="p">(</span><span class="n">representations</span><span class="p">)</span>
</span><span id="SequenceModule-716"><a href="#SequenceModule-716"><span class="linenos">716</span></a>
</span><span id="SequenceModule-717"><a href="#SequenceModule-717"><span class="linenos">717</span></a>        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">reconstructions</span>
</span><span id="SequenceModule-718"><a href="#SequenceModule-718"><span class="linenos">718</span></a>
</span><span id="SequenceModule-719"><a href="#SequenceModule-719"><span class="linenos">719</span></a>    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">:</span>
</span><span id="SequenceModule-720"><a href="#SequenceModule-720"><span class="linenos">720</span></a>        
</span><span id="SequenceModule-721"><a href="#SequenceModule-721"><span class="linenos">721</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;pretrain&quot;</span><span class="p">:</span>
</span><span id="SequenceModule-722"><a href="#SequenceModule-722"><span class="linenos">722</span></a>            <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pretrain_lr</span>
</span><span id="SequenceModule-723"><a href="#SequenceModule-723"><span class="linenos">723</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;finetune&quot;</span><span class="p">:</span>
</span><span id="SequenceModule-724"><a href="#SequenceModule-724"><span class="linenos">724</span></a>            <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">finetune_lr</span>
</span><span id="SequenceModule-725"><a href="#SequenceModule-725"><span class="linenos">725</span></a>        
</span><span id="SequenceModule-726"><a href="#SequenceModule-726"><span class="linenos">726</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
</span><span id="SequenceModule-727"><a href="#SequenceModule-727"><span class="linenos">727</span></a>
</span><span id="SequenceModule-728"><a href="#SequenceModule-728"><span class="linenos">728</span></a>    <span class="k">def</span> <span class="nf">complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="SequenceModule-729"><a href="#SequenceModule-729"><span class="linenos">729</span></a>        <span class="n">n_bytes</span> <span class="o">=</span> <span class="n">complexity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule-730"><a href="#SequenceModule-730"><span class="linenos">730</span></a>
</span><span id="SequenceModule-731"><a href="#SequenceModule-731"><span class="linenos">731</span></a>        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
</span><span id="SequenceModule-732"><a href="#SequenceModule-732"><span class="linenos">732</span></a>            <span class="k">return</span> <span class="n">bytesize</span><span class="p">(</span><span class="n">n_bytes</span><span class="p">)</span>
</span><span id="SequenceModule-733"><a href="#SequenceModule-733"><span class="linenos">733</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SequenceModule-734"><a href="#SequenceModule-734"><span class="linenos">734</span></a>            <span class="k">return</span> <span class="n">n_bytes</span>
</span><span id="SequenceModule-735"><a href="#SequenceModule-735"><span class="linenos">735</span></a>
</span><span id="SequenceModule-736"><a href="#SequenceModule-736"><span class="linenos">736</span></a>    <span class="n">training_step</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="SequenceModule-737"><a href="#SequenceModule-737"><span class="linenos">737</span></a>    <span class="n">validation_step</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;validate&quot;</span><span class="p">)</span>
</span><span id="SequenceModule-738"><a href="#SequenceModule-738"><span class="linenos">738</span></a>    <span class="n">testing_step</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</span><span id="SequenceModule-739"><a href="#SequenceModule-739"><span class="linenos">739</span></a>    <span class="n">predict_step</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">step</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
</span><span id="SequenceModule-740"><a href="#SequenceModule-740"><span class="linenos">740</span></a>
</span><span id="SequenceModule-741"><a href="#SequenceModule-741"><span class="linenos">741</span></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SequenceModule-742"><a href="#SequenceModule-742"><span class="linenos">742</span></a>        <span class="n">pipe</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">datapath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">digests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">digests</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule-743"><a href="#SequenceModule-743"><span class="linenos">743</span></a>
</span><span id="SequenceModule-744"><a href="#SequenceModule-744"><span class="linenos">744</span></a>        <span class="k">assert</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="SequenceModule-745"><a href="#SequenceModule-745"><span class="linenos">745</span></a>        
</span><span id="SequenceModule-746"><a href="#SequenceModule-746"><span class="linenos">746</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setting up for stage </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SequenceModule-747"><a href="#SequenceModule-747"><span class="linenos">747</span></a>
</span><span id="SequenceModule-748"><a href="#SequenceModule-748"><span class="linenos">748</span></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="SequenceModule-749"><a href="#SequenceModule-749"><span class="linenos">749</span></a>            <span class="n">fit</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="SequenceModule-750"><a href="#SequenceModule-750"><span class="linenos">750</span></a>            <span class="n">validate</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="SequenceModule-751"><a href="#SequenceModule-751"><span class="linenos">751</span></a>            <span class="n">test</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
</span><span id="SequenceModule-752"><a href="#SequenceModule-752"><span class="linenos">752</span></a>            <span class="n">predict</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">],</span>   
</span><span id="SequenceModule-753"><a href="#SequenceModule-753"><span class="linenos">753</span></a>        <span class="p">)</span>
</span><span id="SequenceModule-754"><a href="#SequenceModule-754"><span class="linenos">754</span></a>
</span><span id="SequenceModule-755"><a href="#SequenceModule-755"><span class="linenos">755</span></a>        <span class="k">for</span> <span class="n">strata</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">stage</span><span class="p">]:</span>
</span><span id="SequenceModule-756"><a href="#SequenceModule-756"><span class="linenos">756</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">[</span><span class="n">strata</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">masks</span><span class="o">=</span><span class="s2">&quot;*.avro&quot;</span><span class="p">)</span>
</span><span id="SequenceModule-757"><a href="#SequenceModule-757"><span class="linenos">757</span></a>
</span><span id="SequenceModule-758"><a href="#SequenceModule-758"><span class="linenos">758</span></a>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SequenceModule-759"><a href="#SequenceModule-759"><span class="linenos">759</span></a>        <span class="k">assert</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="SequenceModule-760"><a href="#SequenceModule-760"><span class="linenos">760</span></a>        
</span><span id="SequenceModule-761"><a href="#SequenceModule-761"><span class="linenos">761</span></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="SequenceModule-762"><a href="#SequenceModule-762"><span class="linenos">762</span></a>            <span class="n">fit</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="SequenceModule-763"><a href="#SequenceModule-763"><span class="linenos">763</span></a>            <span class="n">validate</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="SequenceModule-764"><a href="#SequenceModule-764"><span class="linenos">764</span></a>            <span class="n">test</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
</span><span id="SequenceModule-765"><a href="#SequenceModule-765"><span class="linenos">765</span></a>            <span class="n">predict</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">],</span>   
</span><span id="SequenceModule-766"><a href="#SequenceModule-766"><span class="linenos">766</span></a>        <span class="p">)</span>
</span><span id="SequenceModule-767"><a href="#SequenceModule-767"><span class="linenos">767</span></a>
</span><span id="SequenceModule-768"><a href="#SequenceModule-768"><span class="linenos">768</span></a>        <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">:</span>
</span><span id="SequenceModule-769"><a href="#SequenceModule-769"><span class="linenos">769</span></a>            <span class="n">loader</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</span><span id="SequenceModule-770"><a href="#SequenceModule-770"><span class="linenos">770</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="SequenceModule-771"><a href="#SequenceModule-771"><span class="linenos">771</span></a>        
</span><span id="SequenceModule-772"><a href="#SequenceModule-772"><span class="linenos">772</span></a>        <span class="k">for</span> <span class="n">strata</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">stage</span><span class="p">]:</span>
</span><span id="SequenceModule-773"><a href="#SequenceModule-773"><span class="linenos">773</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">[</span><span class="n">strata</span><span class="p">]</span>
</span><span id="SequenceModule-774"><a href="#SequenceModule-774"><span class="linenos">774</span></a>
</span><span id="SequenceModule-775"><a href="#SequenceModule-775"><span class="linenos">775</span></a>    <span class="n">train_dataloader</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;train&quot;</span><span class="p">)</span>
</span><span id="SequenceModule-776"><a href="#SequenceModule-776"><span class="linenos">776</span></a>    <span class="n">val_dataloader</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;validate&quot;</span><span class="p">)</span>
</span><span id="SequenceModule-777"><a href="#SequenceModule-777"><span class="linenos">777</span></a>    <span class="n">test_dataloader</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;test&quot;</span><span class="p">)</span>
</span><span id="SequenceModule-778"><a href="#SequenceModule-778"><span class="linenos">778</span></a>    <span class="n">predict_dataloader</span> <span class="o">=</span> <span class="n">partialmethod</span><span class="p">(</span><span class="n">dataloader</span><span class="p">,</span> <span class="n">strata</span><span class="o">=</span><span class="s2">&quot;predict&quot;</span><span class="p">)</span>
</span><span id="SequenceModule-779"><a href="#SequenceModule-779"><span class="linenos">779</span></a>
</span><span id="SequenceModule-780"><a href="#SequenceModule-780"><span class="linenos">780</span></a>    <span class="nd">@property</span>
</span><span id="SequenceModule-781"><a href="#SequenceModule-781"><span class="linenos">781</span></a>    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SequenceModule-782"><a href="#SequenceModule-782"><span class="linenos">782</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>
</span><span id="SequenceModule-783"><a href="#SequenceModule-783"><span class="linenos">783</span></a>
</span><span id="SequenceModule-784"><a href="#SequenceModule-784"><span class="linenos">784</span></a>    <span class="nd">@mode</span><span class="o">.</span><span class="n">setter</span>
</span><span id="SequenceModule-785"><a href="#SequenceModule-785"><span class="linenos">785</span></a>    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SequenceModule-786"><a href="#SequenceModule-786"><span class="linenos">786</span></a>        <span class="k">assert</span> <span class="n">mode</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pretrain&quot;</span><span class="p">,</span> <span class="s2">&quot;finetune&quot;</span><span class="p">]</span>
</span><span id="SequenceModule-787"><a href="#SequenceModule-787"><span class="linenos">787</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">=</span> <span class="n">mode</span>
</span></pre></div>


            <div class="docstring"><p>Hooks to be used in LightningModule.</p>
</div>


                            <div id="SequenceModule.__init__" class="classattr">
                                        <input id="SequenceModule.__init__-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="name">SequenceModule</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="n">datapath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span>,</span><span class="param">	<span class="n">params</span><span class="p">:</span> <span class="n">source</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">Hyperparameters</span>,</span><span class="param">	<span class="n">digests</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">tdigest</span><span class="o">.</span><span class="n">tdigest</span><span class="o">.</span><span class="n">TDigest</span><span class="p">]</span></span>)</span>

                <label class="view-source-button" for="SequenceModule.__init__-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SequenceModule.__init__"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SequenceModule.__init__-664"><a href="#SequenceModule.__init__-664"><span class="linenos">664</span></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="SequenceModule.__init__-665"><a href="#SequenceModule.__init__-665"><span class="linenos">665</span></a>        <span class="bp">self</span><span class="p">,</span>
</span><span id="SequenceModule.__init__-666"><a href="#SequenceModule.__init__-666"><span class="linenos">666</span></a>        <span class="n">datapath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span><span class="p">,</span>
</span><span id="SequenceModule.__init__-667"><a href="#SequenceModule.__init__-667"><span class="linenos">667</span></a>        <span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span><span class="p">,</span>
</span><span id="SequenceModule.__init__-668"><a href="#SequenceModule.__init__-668"><span class="linenos">668</span></a>        <span class="n">digests</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TDigest</span><span class="p">],</span>
</span><span id="SequenceModule.__init__-669"><a href="#SequenceModule.__init__-669"><span class="linenos">669</span></a>    <span class="p">):</span>
</span><span id="SequenceModule.__init__-670"><a href="#SequenceModule.__init__-670"><span class="linenos">670</span></a>        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
</span><span id="SequenceModule.__init__-671"><a href="#SequenceModule.__init__-671"><span class="linenos">671</span></a>
</span><span id="SequenceModule.__init__-672"><a href="#SequenceModule.__init__-672"><span class="linenos">672</span></a>        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datapath</span><span class="p">)</span>
</span><span id="SequenceModule.__init__-673"><a href="#SequenceModule.__init__-673"><span class="linenos">673</span></a>        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">Hyperparameters</span><span class="p">)</span>
</span><span id="SequenceModule.__init__-674"><a href="#SequenceModule.__init__-674"><span class="linenos">674</span></a>
</span><span id="SequenceModule.__init__-675"><a href="#SequenceModule.__init__-675"><span class="linenos">675</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">PathLike</span> <span class="o">=</span> <span class="n">datapath</span>
</span><span id="SequenceModule.__init__-676"><a href="#SequenceModule.__init__-676"><span class="linenos">676</span></a>
</span><span id="SequenceModule.__init__-677"><a href="#SequenceModule.__init__-677"><span class="linenos">677</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">:</span> <span class="n">Hyperparameters</span> <span class="o">=</span> <span class="n">params</span>
</span><span id="SequenceModule.__init__-678"><a href="#SequenceModule.__init__-678"><span class="linenos">678</span></a>
</span><span id="SequenceModule.__init__-679"><a href="#SequenceModule.__init__-679"><span class="linenos">679</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">modular_field_embedder</span> <span class="o">=</span> <span class="n">ModularAttributeEmbeddingSystem</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule.__init__-680"><a href="#SequenceModule.__init__-680"><span class="linenos">680</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">field_encoder</span> <span class="o">=</span> <span class="n">FieldEncoder</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule.__init__-681"><a href="#SequenceModule.__init__-681"><span class="linenos">681</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_encoder</span> <span class="o">=</span> <span class="n">EventEncoder</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule.__init__-682"><a href="#SequenceModule.__init__-682"><span class="linenos">682</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">event_decoder</span> <span class="o">=</span> <span class="n">EventDecoder</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule.__init__-683"><a href="#SequenceModule.__init__-683"><span class="linenos">683</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">decision_head</span> <span class="o">=</span> <span class="n">DecisionHead</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule.__init__-684"><a href="#SequenceModule.__init__-684"><span class="linenos">684</span></a>
</span><span id="SequenceModule.__init__-685"><a href="#SequenceModule.__init__-685"><span class="linenos">685</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">metrics</span> <span class="o">=</span> <span class="n">create_metrics</span><span class="p">(</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule.__init__-686"><a href="#SequenceModule.__init__-686"><span class="linenos">686</span></a>
</span><span id="SequenceModule.__init__-687"><a href="#SequenceModule.__init__-687"><span class="linenos">687</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;pretrain&quot;</span>
</span><span id="SequenceModule.__init__-688"><a href="#SequenceModule.__init__-688"><span class="linenos">688</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">digests</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TDigest</span><span class="p">]</span> <span class="o">=</span> <span class="n">digests</span>
</span><span id="SequenceModule.__init__-689"><a href="#SequenceModule.__init__-689"><span class="linenos">689</span></a>
</span><span id="SequenceModule.__init__-690"><a href="#SequenceModule.__init__-690"><span class="linenos">690</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">DataLoader2</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="SequenceModule.__init__-691"><a href="#SequenceModule.__init__-691"><span class="linenos">691</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">datapipes</span><span class="o">.</span><span class="n">iter</span><span class="o">.</span><span class="n">IterDataPipe</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="SequenceModule.__init__-692"><a href="#SequenceModule.__init__-692"><span class="linenos">692</span></a>        
</span><span id="SequenceModule.__init__-693"><a href="#SequenceModule.__init__-693"><span class="linenos">693</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">example_input_array</span> <span class="o">=</span> <span class="n">mock</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Attributes:
    prepare_data_per_node:
        If True, each LOCAL_RANK=0 will call prepare data.
        Otherwise only NODE_RANK=0, LOCAL_RANK=0 will prepare data.
    allow_zero_length_dataloader_with_multiple_devices:
        If True, dataloader with zero length within local rank is allowed.
        Default value is False.</p>
</div>


                            </div>
                            <div id="SequenceModule.datapath" class="classattr">
                                <div class="attr variable">
            <span class="name">datapath</span><span class="annotation">: str | os.PathLike</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.datapath"></a>
    
    

                            </div>
                            <div id="SequenceModule.params" class="classattr">
                                <div class="attr variable">
            <span class="name">params</span><span class="annotation">: source.core.schema.Hyperparameters</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.params"></a>
    
    

                            </div>
                            <div id="SequenceModule.modular_field_embedder" class="classattr">
                                <div class="attr variable">
            <span class="name">modular_field_embedder</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.modular_field_embedder"></a>
    
    

                            </div>
                            <div id="SequenceModule.field_encoder" class="classattr">
                                <div class="attr variable">
            <span class="name">field_encoder</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.field_encoder"></a>
    
    

                            </div>
                            <div id="SequenceModule.event_encoder" class="classattr">
                                <div class="attr variable">
            <span class="name">event_encoder</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.event_encoder"></a>
    
    

                            </div>
                            <div id="SequenceModule.event_decoder" class="classattr">
                                <div class="attr variable">
            <span class="name">event_decoder</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.event_decoder"></a>
    
    

                            </div>
                            <div id="SequenceModule.decision_head" class="classattr">
                                <div class="attr variable">
            <span class="name">decision_head</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.decision_head"></a>
    
    

                            </div>
                            <div id="SequenceModule.metrics" class="classattr">
                                <div class="attr variable">
            <span class="name">metrics</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.metrics"></a>
    
    

                            </div>
                            <div id="SequenceModule.digests" class="classattr">
                                <div class="attr variable">
            <span class="name">digests</span><span class="annotation">: dict[str, tdigest.tdigest.TDigest]</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.digests"></a>
    
    

                            </div>
                            <div id="SequenceModule.loaders" class="classattr">
                                <div class="attr variable">
            <span class="name">loaders</span><span class="annotation">: list[torchdata.dataloader2.dataloader2.DataLoader2]</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.loaders"></a>
    
    

                            </div>
                            <div id="SequenceModule.pipes" class="classattr">
                                <div class="attr variable">
            <span class="name">pipes</span><span class="annotation">: dict[str, torch.utils.data.datapipes.datapipe.IterDataPipe]</span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.pipes"></a>
    
    

                            </div>
                            <div id="SequenceModule.example_input_array" class="classattr">
                                        <input id="SequenceModule.example_input_array-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">example_input_array</span><span class="annotation">: Union[torch.Tensor, Tuple, Dict, NoneType]</span>

                <label class="view-source-button" for="SequenceModule.example_input_array-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SequenceModule.example_input_array"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SequenceModule.example_input_array-239"><a href="#SequenceModule.example_input_array-239"><span class="linenos">239</span></a>    <span class="nd">@property</span>
</span><span id="SequenceModule.example_input_array-240"><a href="#SequenceModule.example_input_array-240"><span class="linenos">240</span></a>    <span class="k">def</span> <span class="nf">example_input_array</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]]:</span>
</span><span id="SequenceModule.example_input_array-241"><a href="#SequenceModule.example_input_array-241"><span class="linenos">241</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;The example input array is a specification of what the module can consume in the :meth:`forward` method. The</span>
</span><span id="SequenceModule.example_input_array-242"><a href="#SequenceModule.example_input_array-242"><span class="linenos">242</span></a><span class="sd">        return type is interpreted as follows:</span>
</span><span id="SequenceModule.example_input_array-243"><a href="#SequenceModule.example_input_array-243"><span class="linenos">243</span></a>
</span><span id="SequenceModule.example_input_array-244"><a href="#SequenceModule.example_input_array-244"><span class="linenos">244</span></a><span class="sd">        -   Single tensor: It is assumed the model takes a single argument, i.e.,</span>
</span><span id="SequenceModule.example_input_array-245"><a href="#SequenceModule.example_input_array-245"><span class="linenos">245</span></a><span class="sd">            ``model.forward(model.example_input_array)``</span>
</span><span id="SequenceModule.example_input_array-246"><a href="#SequenceModule.example_input_array-246"><span class="linenos">246</span></a><span class="sd">        -   Tuple: The input array should be interpreted as a sequence of positional arguments, i.e.,</span>
</span><span id="SequenceModule.example_input_array-247"><a href="#SequenceModule.example_input_array-247"><span class="linenos">247</span></a><span class="sd">            ``model.forward(*model.example_input_array)``</span>
</span><span id="SequenceModule.example_input_array-248"><a href="#SequenceModule.example_input_array-248"><span class="linenos">248</span></a><span class="sd">        -   Dict: The input array represents named keyword arguments, i.e.,</span>
</span><span id="SequenceModule.example_input_array-249"><a href="#SequenceModule.example_input_array-249"><span class="linenos">249</span></a><span class="sd">            ``model.forward(**model.example_input_array)``</span>
</span><span id="SequenceModule.example_input_array-250"><a href="#SequenceModule.example_input_array-250"><span class="linenos">250</span></a>
</span><span id="SequenceModule.example_input_array-251"><a href="#SequenceModule.example_input_array-251"><span class="linenos">251</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SequenceModule.example_input_array-252"><a href="#SequenceModule.example_input_array-252"><span class="linenos">252</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_example_input_array</span>
</span></pre></div>


            <div class="docstring"><p>The example input array is a specification of what the module can consume in the <code><a href="#SequenceModule.forward">forward()</a></code> method. The
return type is interpreted as follows:</p>

<ul>
<li>Single tensor: It is assumed the model takes a single argument, i.e.,
<code>model.forward(model.example_input_array)</code></li>
<li>Tuple: The input array should be interpreted as a sequence of positional arguments, i.e.,
<code>model.forward(*model.example_input_array)</code></li>
<li>Dict: The input array represents named keyword arguments, i.e.,
<code>model.forward(**model.example_input_array)</code></li>
</ul>
</div>


                            </div>
                            <div id="SequenceModule.forward" class="classattr">
                                        <input id="SequenceModule.forward-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
                    <div class="decorator">@jaxtyped(typechecker=beartype)</div>

        <span class="def">def</span>
        <span class="name">forward</span><span class="signature pdoc-code multiline">(<span class="param">	<span class="bp">self</span>,</span><span class="param">	<span class="n">inputs</span><span class="p">:</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span></span><span class="return-annotation">) -> <span class="nb">tuple</span><span class="p">[</span><span class="n">jaxtyping</span><span class="o">.</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s1">&#39;N T&#39;</span><span class="p">],</span> <span class="n">tensordict</span><span class="o">.</span><span class="n">_td</span><span class="o">.</span><span class="n">TensorDict</span><span class="p">]</span>:</span></span>

                <label class="view-source-button" for="SequenceModule.forward-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SequenceModule.forward"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SequenceModule.forward-695"><a href="#SequenceModule.forward-695"><span class="linenos">695</span></a>    <span class="nd">@jaxtyped</span><span class="p">(</span><span class="n">typechecker</span><span class="o">=</span><span class="n">beartype</span><span class="p">)</span>
</span><span id="SequenceModule.forward-696"><a href="#SequenceModule.forward-696"><span class="linenos">696</span></a>    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">inputs</span><span class="p">:</span> <span class="n">TensorDict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">tuple</span><span class="p">[</span><span class="n">Float</span><span class="p">[</span><span class="n">Tensor</span><span class="p">,</span> <span class="s2">&quot;N T&quot;</span><span class="p">],</span> <span class="n">TensorDict</span><span class="p">]:</span>
</span><span id="SequenceModule.forward-697"><a href="#SequenceModule.forward-697"><span class="linenos">697</span></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="SequenceModule.forward-698"><a href="#SequenceModule.forward-698"><span class="linenos">698</span></a><span class="sd">        Performs the forward pass of the encoder.</span>
</span><span id="SequenceModule.forward-699"><a href="#SequenceModule.forward-699"><span class="linenos">699</span></a>
</span><span id="SequenceModule.forward-700"><a href="#SequenceModule.forward-700"><span class="linenos">700</span></a><span class="sd">        Args:</span>
</span><span id="SequenceModule.forward-701"><a href="#SequenceModule.forward-701"><span class="linenos">701</span></a><span class="sd">            events (Float[Tensor, &quot;N L FC&quot;]): The input tensor.</span>
</span><span id="SequenceModule.forward-702"><a href="#SequenceModule.forward-702"><span class="linenos">702</span></a>
</span><span id="SequenceModule.forward-703"><a href="#SequenceModule.forward-703"><span class="linenos">703</span></a><span class="sd">        Returns:</span>
</span><span id="SequenceModule.forward-704"><a href="#SequenceModule.forward-704"><span class="linenos">704</span></a><span class="sd">            tuple[Tensor, TensorDict]:</span>
</span><span id="SequenceModule.forward-705"><a href="#SequenceModule.forward-705"><span class="linenos">705</span></a><span class="sd">            A tuple containing two tensors. The first tensor represents the supervised classification predictions and the second tensor represents the decoded, reconstructed events.</span>
</span><span id="SequenceModule.forward-706"><a href="#SequenceModule.forward-706"><span class="linenos">706</span></a><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="SequenceModule.forward-707"><a href="#SequenceModule.forward-707"><span class="linenos">707</span></a>
</span><span id="SequenceModule.forward-708"><a href="#SequenceModule.forward-708"><span class="linenos">708</span></a>        <span class="n">field_mask</span><span class="p">,</span> <span class="n">event_mask</span> <span class="o">=</span> <span class="n">create_attention_masks</span><span class="p">(</span><span class="n">inputs</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span>
</span><span id="SequenceModule.forward-709"><a href="#SequenceModule.forward-709"><span class="linenos">709</span></a>
</span><span id="SequenceModule.forward-710"><a href="#SequenceModule.forward-710"><span class="linenos">710</span></a>        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">modular_field_embedder</span><span class="p">(</span><span class="n">inputs</span><span class="p">)</span>
</span><span id="SequenceModule.forward-711"><a href="#SequenceModule.forward-711"><span class="linenos">711</span></a>        <span class="n">events</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">field_encoder</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">field_mask</span><span class="p">)</span>
</span><span id="SequenceModule.forward-712"><a href="#SequenceModule.forward-712"><span class="linenos">712</span></a>        <span class="n">sequence</span><span class="p">,</span> <span class="n">representations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_encoder</span><span class="p">(</span><span class="n">events</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">event_mask</span><span class="p">)</span>
</span><span id="SequenceModule.forward-713"><a href="#SequenceModule.forward-713"><span class="linenos">713</span></a>
</span><span id="SequenceModule.forward-714"><a href="#SequenceModule.forward-714"><span class="linenos">714</span></a>        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decision_head</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
</span><span id="SequenceModule.forward-715"><a href="#SequenceModule.forward-715"><span class="linenos">715</span></a>        <span class="n">reconstructions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_decoder</span><span class="p">(</span><span class="n">representations</span><span class="p">)</span>
</span><span id="SequenceModule.forward-716"><a href="#SequenceModule.forward-716"><span class="linenos">716</span></a>
</span><span id="SequenceModule.forward-717"><a href="#SequenceModule.forward-717"><span class="linenos">717</span></a>        <span class="k">return</span> <span class="n">predictions</span><span class="p">,</span> <span class="n">reconstructions</span>
</span></pre></div>


            <div class="docstring"><p>Performs the forward pass of the encoder.</p>

<p>Args:
    events (Float[Tensor, "N L FC"]): The input tensor.</p>

<p>Returns:
    tuple[Tensor, TensorDict]:
    A tuple containing two tensors. The first tensor represents the supervised classification predictions and the second tensor represents the decoded, reconstructed events.</p>
</div>


                            </div>
                            <div id="SequenceModule.configure_optimizers" class="classattr">
                                        <input id="SequenceModule.configure_optimizers-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">configure_optimizers</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span></span><span class="return-annotation">) -> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">adamw</span><span class="o">.</span><span class="n">AdamW</span>:</span></span>

                <label class="view-source-button" for="SequenceModule.configure_optimizers-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SequenceModule.configure_optimizers"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SequenceModule.configure_optimizers-719"><a href="#SequenceModule.configure_optimizers-719"><span class="linenos">719</span></a>    <span class="k">def</span> <span class="nf">configure_optimizers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">:</span>
</span><span id="SequenceModule.configure_optimizers-720"><a href="#SequenceModule.configure_optimizers-720"><span class="linenos">720</span></a>        
</span><span id="SequenceModule.configure_optimizers-721"><a href="#SequenceModule.configure_optimizers-721"><span class="linenos">721</span></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;pretrain&quot;</span><span class="p">:</span>
</span><span id="SequenceModule.configure_optimizers-722"><a href="#SequenceModule.configure_optimizers-722"><span class="linenos">722</span></a>            <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">pretrain_lr</span>
</span><span id="SequenceModule.configure_optimizers-723"><a href="#SequenceModule.configure_optimizers-723"><span class="linenos">723</span></a>        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span> <span class="o">==</span> <span class="s2">&quot;finetune&quot;</span><span class="p">:</span>
</span><span id="SequenceModule.configure_optimizers-724"><a href="#SequenceModule.configure_optimizers-724"><span class="linenos">724</span></a>            <span class="n">lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">finetune_lr</span>
</span><span id="SequenceModule.configure_optimizers-725"><a href="#SequenceModule.configure_optimizers-725"><span class="linenos">725</span></a>        
</span><span id="SequenceModule.configure_optimizers-726"><a href="#SequenceModule.configure_optimizers-726"><span class="linenos">726</span></a>        <span class="k">return</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">AdamW</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="n">lr</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Choose what optimizers and learning-rate schedulers to use in your optimization. Normally you'd need one.
But in the case of GANs or similar you might have multiple. Optimization with multiple optimizers only works in
the manual optimization mode.</p>

<p>Return:
    Any of these 6 options.</p>

<pre><code>- **Single optimizer**.
- **List or Tuple** of optimizers.
- **Two lists** - The first list has multiple optimizers, and the second has multiple LR schedulers
  (or multiple ``lr_scheduler_config``).
- **Dictionary**, with an ``"optimizer"`` key, and (optionally) a ``"lr_scheduler"``
  key whose value is a single LR scheduler or ``lr_scheduler_config``.
- **None** - Fit will run without any optimizer.
</code></pre>

<p>The <code>lr_scheduler_config</code> is a dictionary which contains the scheduler and its associated configuration.
The default configuration is shown below.</p>

<div class="pdoc-code codehilite">
<pre><span></span><code><span class="n">lr_scheduler_config</span> <span class="o">=</span> <span class="p">{</span>
    <span class="c1"># REQUIRED: The scheduler instance</span>
    <span class="s2">&quot;scheduler&quot;</span><span class="p">:</span> <span class="n">lr_scheduler</span><span class="p">,</span>
    <span class="c1"># The unit of the scheduler&#39;s step size, could also be &#39;step&#39;.</span>
    <span class="c1"># &#39;epoch&#39; updates the scheduler on epoch end whereas &#39;step&#39;</span>
    <span class="c1"># updates it after a optimizer update.</span>
    <span class="s2">&quot;interval&quot;</span><span class="p">:</span> <span class="s2">&quot;epoch&quot;</span><span class="p">,</span>
    <span class="c1"># How many epochs/steps should pass between calls to</span>
    <span class="c1"># `scheduler.step()`. 1 corresponds to updating the learning</span>
    <span class="c1"># rate after every epoch/step.</span>
    <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="c1"># Metric to to monitor for schedulers like `ReduceLROnPlateau`</span>
    <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="s2">&quot;val_loss&quot;</span><span class="p">,</span>
    <span class="c1"># If set to `True`, will enforce that the value specified &#39;monitor&#39;</span>
    <span class="c1"># is available when the scheduler is updated, thus stopping</span>
    <span class="c1"># training if not found. If set to `False`, it will only produce a warning</span>
    <span class="s2">&quot;strict&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="c1"># If using the `LearningRateMonitor` callback to monitor the</span>
    <span class="c1"># learning rate progress, this keyword can be used to specify</span>
    <span class="c1"># a custom logged name</span>
    <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">}</span>
</code></pre>
</div>

<p>When there are schedulers in which the <code>.step()</code> method is conditioned on a value, such as the
<code>torch.optim.lr_scheduler.ReduceLROnPlateau</code> scheduler, Lightning requires that the
<code>lr_scheduler_config</code> contains the keyword <code>"monitor"</code> set to the metric name that the scheduler
should be conditioned on.</p>

<p>.. testcode::</p>

<pre><code># The ReduceLROnPlateau scheduler requires a monitor
def configure_optimizers(self):
    optimizer = Adam(...)
    return {
        "optimizer": optimizer,
        "lr_scheduler": {
            "scheduler": ReduceLROnPlateau(optimizer, ...),
            "monitor": "metric_to_track",
            "frequency": "indicates how often the metric is updated",
            # If "monitor" references validation metrics, then "frequency" should be set to a
            # multiple of "trainer.check_val_every_n_epoch".
        },
    }


# In the case of two optimizers, only one using the ReduceLROnPlateau scheduler
def configure_optimizers(self):
    optimizer1 = Adam(...)
    optimizer2 = SGD(...)
    scheduler1 = ReduceLROnPlateau(optimizer1, ...)
    scheduler2 = LambdaLR(optimizer2, ...)
    return (
        {
            "optimizer": optimizer1,
            "lr_scheduler": {
                "scheduler": scheduler1,
                "monitor": "metric_to_track",
            },
        },
        {"optimizer": optimizer2, "lr_scheduler": scheduler2},
    )
</code></pre>

<p>Metrics can be made available to monitor by simply logging it using
<code>self.log('metric_to_track', metric_val)</code> in your <code>~lightning.pytorch.core.LightningModule</code>.</p>

<p>Note:
    Some things to know:</p>

<pre><code>- Lightning calls ``.backward()`` and ``.step()`` automatically in case of automatic optimization.
- If a learning rate scheduler is specified in ``configure_optimizers()`` with key
  ``"interval"`` (default "epoch") in the scheduler configuration, Lightning will call
  the scheduler's ``.step()`` method automatically in case of automatic optimization.
- If you use 16-bit precision (``precision=16``), Lightning will automatically handle the optimizer.
- If you use `torch.optim.LBFGS`, Lightning handles the closure function automatically for you.
- If you use multiple optimizers, you will have to switch to 'manual optimization' mode and step them
  yourself.
- If you need to control how often the optimizer steps, override the `optimizer_step()` hook.
</code></pre>
</div>


                            </div>
                            <div id="SequenceModule.complexity" class="classattr">
                                        <input id="SequenceModule.complexity-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">complexity</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="nb">format</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span></span><span class="return-annotation">) -> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span>:</span></span>

                <label class="view-source-button" for="SequenceModule.complexity-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SequenceModule.complexity"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SequenceModule.complexity-728"><a href="#SequenceModule.complexity-728"><span class="linenos">728</span></a>    <span class="k">def</span> <span class="nf">complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">format</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span> <span class="o">|</span> <span class="nb">int</span><span class="p">:</span>
</span><span id="SequenceModule.complexity-729"><a href="#SequenceModule.complexity-729"><span class="linenos">729</span></a>        <span class="n">n_bytes</span> <span class="o">=</span> <span class="n">complexity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule.complexity-730"><a href="#SequenceModule.complexity-730"><span class="linenos">730</span></a>
</span><span id="SequenceModule.complexity-731"><a href="#SequenceModule.complexity-731"><span class="linenos">731</span></a>        <span class="k">if</span> <span class="nb">format</span><span class="p">:</span>
</span><span id="SequenceModule.complexity-732"><a href="#SequenceModule.complexity-732"><span class="linenos">732</span></a>            <span class="k">return</span> <span class="n">bytesize</span><span class="p">(</span><span class="n">n_bytes</span><span class="p">)</span>
</span><span id="SequenceModule.complexity-733"><a href="#SequenceModule.complexity-733"><span class="linenos">733</span></a>        <span class="k">else</span><span class="p">:</span>
</span><span id="SequenceModule.complexity-734"><a href="#SequenceModule.complexity-734"><span class="linenos">734</span></a>            <span class="k">return</span> <span class="n">n_bytes</span>
</span></pre></div>


    

                            </div>
                            <div id="SequenceModule.training_step" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">training_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.training_step"></a>
    
            <div class="docstring"><p>Method descriptor with partial application of the given arguments
and keywords.</p>

<p>Supports wrapping existing descriptors and handles non-descriptor
callables as instance methods.</p>
</div>


                            </div>
                            <div id="SequenceModule.validation_step" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">validation_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.validation_step"></a>
    
            <div class="docstring"><p>Method descriptor with partial application of the given arguments
and keywords.</p>

<p>Supports wrapping existing descriptors and handles non-descriptor
callables as instance methods.</p>
</div>


                            </div>
                            <div id="SequenceModule.testing_step" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">testing_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.testing_step"></a>
    
            <div class="docstring"><p>Method descriptor with partial application of the given arguments
and keywords.</p>

<p>Supports wrapping existing descriptors and handles non-descriptor
callables as instance methods.</p>
</div>


                            </div>
                            <div id="SequenceModule.predict_step" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">predict_step</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.predict_step"></a>
    
            <div class="docstring"><p>Method descriptor with partial application of the given arguments
and keywords.</p>

<p>Supports wrapping existing descriptors and handles non-descriptor
callables as instance methods.</p>
</div>


                            </div>
                            <div id="SequenceModule.setup" class="classattr">
                                        <input id="SequenceModule.setup-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">setup</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stage</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SequenceModule.setup-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SequenceModule.setup"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SequenceModule.setup-741"><a href="#SequenceModule.setup-741"><span class="linenos">741</span></a>    <span class="k">def</span> <span class="nf">setup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SequenceModule.setup-742"><a href="#SequenceModule.setup-742"><span class="linenos">742</span></a>        <span class="n">pipe</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">datapath</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">datapath</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_mode</span><span class="p">,</span> <span class="n">digests</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">digests</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">)</span>
</span><span id="SequenceModule.setup-743"><a href="#SequenceModule.setup-743"><span class="linenos">743</span></a>
</span><span id="SequenceModule.setup-744"><a href="#SequenceModule.setup-744"><span class="linenos">744</span></a>        <span class="k">assert</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="SequenceModule.setup-745"><a href="#SequenceModule.setup-745"><span class="linenos">745</span></a>        
</span><span id="SequenceModule.setup-746"><a href="#SequenceModule.setup-746"><span class="linenos">746</span></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;setting up for stage </span><span class="si">{</span><span class="n">stage</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
</span><span id="SequenceModule.setup-747"><a href="#SequenceModule.setup-747"><span class="linenos">747</span></a>
</span><span id="SequenceModule.setup-748"><a href="#SequenceModule.setup-748"><span class="linenos">748</span></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="SequenceModule.setup-749"><a href="#SequenceModule.setup-749"><span class="linenos">749</span></a>            <span class="n">fit</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="SequenceModule.setup-750"><a href="#SequenceModule.setup-750"><span class="linenos">750</span></a>            <span class="n">validate</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="SequenceModule.setup-751"><a href="#SequenceModule.setup-751"><span class="linenos">751</span></a>            <span class="n">test</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
</span><span id="SequenceModule.setup-752"><a href="#SequenceModule.setup-752"><span class="linenos">752</span></a>            <span class="n">predict</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">],</span>   
</span><span id="SequenceModule.setup-753"><a href="#SequenceModule.setup-753"><span class="linenos">753</span></a>        <span class="p">)</span>
</span><span id="SequenceModule.setup-754"><a href="#SequenceModule.setup-754"><span class="linenos">754</span></a>
</span><span id="SequenceModule.setup-755"><a href="#SequenceModule.setup-755"><span class="linenos">755</span></a>        <span class="k">for</span> <span class="n">strata</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">stage</span><span class="p">]:</span>
</span><span id="SequenceModule.setup-756"><a href="#SequenceModule.setup-756"><span class="linenos">756</span></a>            <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">[</span><span class="n">strata</span><span class="p">]</span> <span class="o">=</span> <span class="n">pipe</span><span class="p">(</span><span class="n">masks</span><span class="o">=</span><span class="s2">&quot;*.avro&quot;</span><span class="p">)</span>
</span></pre></div>


            <div class="docstring"><p>Called at the beginning of fit (train + validate), validate, test, or predict. This is a good hook when you
need to build models dynamically or adjust something about them. This hook is called on every process when
using DDP.</p>

<p>Args:
    stage: either <code>'fit'</code>, <code>'validate'</code>, <code>'test'</code>, or <code>'predict'</code></p>

<p>Example::</p>

<pre><code>class LitModel(...):
    def __init__(self):
        self.l1 = None

    def prepare_data(self):
        download_data()
        tokenize()

        # don't do this
        self.something = else

    def setup(self, stage):
        data = load_data(...)
        self.l1 = nn.Linear(28, data.num_classes)
</code></pre>
</div>


                            </div>
                            <div id="SequenceModule.teardown" class="classattr">
                                        <input id="SequenceModule.teardown-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr function">
            
        <span class="def">def</span>
        <span class="name">teardown</span><span class="signature pdoc-code condensed">(<span class="param"><span class="bp">self</span>, </span><span class="param"><span class="n">stage</span><span class="p">:</span> <span class="nb">str</span></span><span class="return-annotation">):</span></span>

                <label class="view-source-button" for="SequenceModule.teardown-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SequenceModule.teardown"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SequenceModule.teardown-758"><a href="#SequenceModule.teardown-758"><span class="linenos">758</span></a>    <span class="k">def</span> <span class="nf">teardown</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stage</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="SequenceModule.teardown-759"><a href="#SequenceModule.teardown-759"><span class="linenos">759</span></a>        <span class="k">assert</span> <span class="n">stage</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fit&quot;</span><span class="p">,</span> <span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;predict&quot;</span><span class="p">]</span>
</span><span id="SequenceModule.teardown-760"><a href="#SequenceModule.teardown-760"><span class="linenos">760</span></a>        
</span><span id="SequenceModule.teardown-761"><a href="#SequenceModule.teardown-761"><span class="linenos">761</span></a>        <span class="n">mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
</span><span id="SequenceModule.teardown-762"><a href="#SequenceModule.teardown-762"><span class="linenos">762</span></a>            <span class="n">fit</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;train&#39;</span><span class="p">,</span> <span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="SequenceModule.teardown-763"><a href="#SequenceModule.teardown-763"><span class="linenos">763</span></a>            <span class="n">validate</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;validate&#39;</span><span class="p">],</span>
</span><span id="SequenceModule.teardown-764"><a href="#SequenceModule.teardown-764"><span class="linenos">764</span></a>            <span class="n">test</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;test&#39;</span><span class="p">],</span>
</span><span id="SequenceModule.teardown-765"><a href="#SequenceModule.teardown-765"><span class="linenos">765</span></a>            <span class="n">predict</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;predict&#39;</span><span class="p">],</span>   
</span><span id="SequenceModule.teardown-766"><a href="#SequenceModule.teardown-766"><span class="linenos">766</span></a>        <span class="p">)</span>
</span><span id="SequenceModule.teardown-767"><a href="#SequenceModule.teardown-767"><span class="linenos">767</span></a>
</span><span id="SequenceModule.teardown-768"><a href="#SequenceModule.teardown-768"><span class="linenos">768</span></a>        <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="p">:</span>
</span><span id="SequenceModule.teardown-769"><a href="#SequenceModule.teardown-769"><span class="linenos">769</span></a>            <span class="n">loader</span><span class="o">.</span><span class="n">shutdown</span><span class="p">()</span>
</span><span id="SequenceModule.teardown-770"><a href="#SequenceModule.teardown-770"><span class="linenos">770</span></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loaders</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</span><span id="SequenceModule.teardown-771"><a href="#SequenceModule.teardown-771"><span class="linenos">771</span></a>        
</span><span id="SequenceModule.teardown-772"><a href="#SequenceModule.teardown-772"><span class="linenos">772</span></a>        <span class="k">for</span> <span class="n">strata</span> <span class="ow">in</span> <span class="n">mapping</span><span class="p">[</span><span class="n">stage</span><span class="p">]:</span>
</span><span id="SequenceModule.teardown-773"><a href="#SequenceModule.teardown-773"><span class="linenos">773</span></a>            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipes</span><span class="p">[</span><span class="n">strata</span><span class="p">]</span>
</span></pre></div>


            <div class="docstring"><p>Called at the end of fit (train + validate), validate, test, or predict.</p>

<p>Args:
    stage: either <code>'fit'</code>, <code>'validate'</code>, <code>'test'</code>, or <code>'predict'</code></p>
</div>


                            </div>
                            <div id="SequenceModule.train_dataloader" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">train_dataloader</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.train_dataloader"></a>
    
            <div class="docstring"><p>Method descriptor with partial application of the given arguments
and keywords.</p>

<p>Supports wrapping existing descriptors and handles non-descriptor
callables as instance methods.</p>
</div>


                            </div>
                            <div id="SequenceModule.val_dataloader" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">val_dataloader</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.val_dataloader"></a>
    
            <div class="docstring"><p>Method descriptor with partial application of the given arguments
and keywords.</p>

<p>Supports wrapping existing descriptors and handles non-descriptor
callables as instance methods.</p>
</div>


                            </div>
                            <div id="SequenceModule.test_dataloader" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">test_dataloader</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.test_dataloader"></a>
    
            <div class="docstring"><p>Method descriptor with partial application of the given arguments
and keywords.</p>

<p>Supports wrapping existing descriptors and handles non-descriptor
callables as instance methods.</p>
</div>


                            </div>
                            <div id="SequenceModule.predict_dataloader" class="classattr">
                                <div class="attr function">
            
        <span class="def">def</span>
        <span class="name">predict_dataloader</span><span class="signature pdoc-code condensed">(<span class="param"><span class="n">unknown</span></span><span class="return-annotation">):</span></span>

        
    </div>
    <a class="headerlink" href="#SequenceModule.predict_dataloader"></a>
    
            <div class="docstring"><p>Method descriptor with partial application of the given arguments
and keywords.</p>

<p>Supports wrapping existing descriptors and handles non-descriptor
callables as instance methods.</p>
</div>


                            </div>
                            <div id="SequenceModule.mode" class="classattr">
                                        <input id="SequenceModule.mode-view-source" class="view-source-toggle-state" type="checkbox" aria-hidden="true" tabindex="-1">
<div class="attr variable">
            <span class="name">mode</span>

                <label class="view-source-button" for="SequenceModule.mode-view-source"><span>View Source</span></label>

    </div>
    <a class="headerlink" href="#SequenceModule.mode"></a>
            <div class="pdoc-code codehilite"><pre><span></span><span id="SequenceModule.mode-780"><a href="#SequenceModule.mode-780"><span class="linenos">780</span></a>    <span class="nd">@property</span>
</span><span id="SequenceModule.mode-781"><a href="#SequenceModule.mode-781"><span class="linenos">781</span></a>    <span class="k">def</span> <span class="nf">mode</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span><span id="SequenceModule.mode-782"><a href="#SequenceModule.mode-782"><span class="linenos">782</span></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mode</span>
</span></pre></div>


    

                            </div>
                            <div class="inherited">
                                <h5>Inherited Members</h5>
                                <dl>
                                    <div><dt>lightning.pytorch.core.module.LightningModule</dt>
                                <dd id="SequenceModule.CHECKPOINT_HYPER_PARAMS_KEY" class="variable">CHECKPOINT_HYPER_PARAMS_KEY</dd>
                <dd id="SequenceModule.CHECKPOINT_HYPER_PARAMS_NAME" class="variable">CHECKPOINT_HYPER_PARAMS_NAME</dd>
                <dd id="SequenceModule.CHECKPOINT_HYPER_PARAMS_TYPE" class="variable">CHECKPOINT_HYPER_PARAMS_TYPE</dd>
                <dd id="SequenceModule.optimizers" class="function">optimizers</dd>
                <dd id="SequenceModule.lr_schedulers" class="function">lr_schedulers</dd>
                <dd id="SequenceModule.trainer" class="variable">trainer</dd>
                <dd id="SequenceModule.fabric" class="variable">fabric</dd>
                <dd id="SequenceModule.current_epoch" class="variable">current_epoch</dd>
                <dd id="SequenceModule.global_step" class="variable">global_step</dd>
                <dd id="SequenceModule.global_rank" class="variable">global_rank</dd>
                <dd id="SequenceModule.local_rank" class="variable">local_rank</dd>
                <dd id="SequenceModule.on_gpu" class="variable">on_gpu</dd>
                <dd id="SequenceModule.automatic_optimization" class="variable">automatic_optimization</dd>
                <dd id="SequenceModule.strict_loading" class="variable">strict_loading</dd>
                <dd id="SequenceModule.logger" class="variable">logger</dd>
                <dd id="SequenceModule.loggers" class="variable">loggers</dd>
                <dd id="SequenceModule.print" class="function">print</dd>
                <dd id="SequenceModule.log" class="function">log</dd>
                <dd id="SequenceModule.log_dict" class="function">log_dict</dd>
                <dd id="SequenceModule.all_gather" class="function">all_gather</dd>
                <dd id="SequenceModule.test_step" class="function">test_step</dd>
                <dd id="SequenceModule.configure_callbacks" class="function">configure_callbacks</dd>
                <dd id="SequenceModule.manual_backward" class="function">manual_backward</dd>
                <dd id="SequenceModule.backward" class="function">backward</dd>
                <dd id="SequenceModule.toggle_optimizer" class="function">toggle_optimizer</dd>
                <dd id="SequenceModule.untoggle_optimizer" class="function">untoggle_optimizer</dd>
                <dd id="SequenceModule.clip_gradients" class="function">clip_gradients</dd>
                <dd id="SequenceModule.configure_gradient_clipping" class="function">configure_gradient_clipping</dd>
                <dd id="SequenceModule.lr_scheduler_step" class="function">lr_scheduler_step</dd>
                <dd id="SequenceModule.optimizer_step" class="function">optimizer_step</dd>
                <dd id="SequenceModule.optimizer_zero_grad" class="function">optimizer_zero_grad</dd>
                <dd id="SequenceModule.freeze" class="function">freeze</dd>
                <dd id="SequenceModule.unfreeze" class="function">unfreeze</dd>
                <dd id="SequenceModule.to_onnx" class="function">to_onnx</dd>
                <dd id="SequenceModule.to_torchscript" class="function">to_torchscript</dd>
                <dd id="SequenceModule.load_from_checkpoint" class="function">load_from_checkpoint</dd>

            </div>
            <div><dt>lightning.fabric.utilities.device_dtype_mixin._DeviceDtypeModuleMixin</dt>
                                <dd id="SequenceModule.dtype" class="variable">dtype</dd>
                <dd id="SequenceModule.device" class="variable">device</dd>
                <dd id="SequenceModule.to" class="function">to</dd>
                <dd id="SequenceModule.cuda" class="function">cuda</dd>
                <dd id="SequenceModule.cpu" class="function">cpu</dd>
                <dd id="SequenceModule.type" class="function">type</dd>
                <dd id="SequenceModule.float" class="function">float</dd>
                <dd id="SequenceModule.double" class="function">double</dd>
                <dd id="SequenceModule.half" class="function">half</dd>

            </div>
            <div><dt>lightning.pytorch.core.mixins.hparams_mixin.HyperparametersMixin</dt>
                                <dd id="SequenceModule.save_hyperparameters" class="function">save_hyperparameters</dd>
                <dd id="SequenceModule.hparams" class="variable">hparams</dd>
                <dd id="SequenceModule.hparams_initial" class="variable">hparams_initial</dd>

            </div>
            <div><dt>lightning.pytorch.core.hooks.ModelHooks</dt>
                                <dd id="SequenceModule.on_fit_start" class="function">on_fit_start</dd>
                <dd id="SequenceModule.on_fit_end" class="function">on_fit_end</dd>
                <dd id="SequenceModule.on_train_start" class="function">on_train_start</dd>
                <dd id="SequenceModule.on_train_end" class="function">on_train_end</dd>
                <dd id="SequenceModule.on_validation_start" class="function">on_validation_start</dd>
                <dd id="SequenceModule.on_validation_end" class="function">on_validation_end</dd>
                <dd id="SequenceModule.on_test_start" class="function">on_test_start</dd>
                <dd id="SequenceModule.on_test_end" class="function">on_test_end</dd>
                <dd id="SequenceModule.on_predict_start" class="function">on_predict_start</dd>
                <dd id="SequenceModule.on_predict_end" class="function">on_predict_end</dd>
                <dd id="SequenceModule.on_train_batch_start" class="function">on_train_batch_start</dd>
                <dd id="SequenceModule.on_train_batch_end" class="function">on_train_batch_end</dd>
                <dd id="SequenceModule.on_validation_batch_start" class="function">on_validation_batch_start</dd>
                <dd id="SequenceModule.on_validation_batch_end" class="function">on_validation_batch_end</dd>
                <dd id="SequenceModule.on_test_batch_start" class="function">on_test_batch_start</dd>
                <dd id="SequenceModule.on_test_batch_end" class="function">on_test_batch_end</dd>
                <dd id="SequenceModule.on_predict_batch_start" class="function">on_predict_batch_start</dd>
                <dd id="SequenceModule.on_predict_batch_end" class="function">on_predict_batch_end</dd>
                <dd id="SequenceModule.on_validation_model_zero_grad" class="function">on_validation_model_zero_grad</dd>
                <dd id="SequenceModule.on_validation_model_eval" class="function">on_validation_model_eval</dd>
                <dd id="SequenceModule.on_validation_model_train" class="function">on_validation_model_train</dd>
                <dd id="SequenceModule.on_test_model_eval" class="function">on_test_model_eval</dd>
                <dd id="SequenceModule.on_test_model_train" class="function">on_test_model_train</dd>
                <dd id="SequenceModule.on_predict_model_eval" class="function">on_predict_model_eval</dd>
                <dd id="SequenceModule.on_train_epoch_start" class="function">on_train_epoch_start</dd>
                <dd id="SequenceModule.on_train_epoch_end" class="function">on_train_epoch_end</dd>
                <dd id="SequenceModule.on_validation_epoch_start" class="function">on_validation_epoch_start</dd>
                <dd id="SequenceModule.on_validation_epoch_end" class="function">on_validation_epoch_end</dd>
                <dd id="SequenceModule.on_test_epoch_start" class="function">on_test_epoch_start</dd>
                <dd id="SequenceModule.on_test_epoch_end" class="function">on_test_epoch_end</dd>
                <dd id="SequenceModule.on_predict_epoch_start" class="function">on_predict_epoch_start</dd>
                <dd id="SequenceModule.on_predict_epoch_end" class="function">on_predict_epoch_end</dd>
                <dd id="SequenceModule.on_before_zero_grad" class="function">on_before_zero_grad</dd>
                <dd id="SequenceModule.on_before_backward" class="function">on_before_backward</dd>
                <dd id="SequenceModule.on_after_backward" class="function">on_after_backward</dd>
                <dd id="SequenceModule.on_before_optimizer_step" class="function">on_before_optimizer_step</dd>
                <dd id="SequenceModule.configure_sharded_model" class="function">configure_sharded_model</dd>
                <dd id="SequenceModule.configure_model" class="function">configure_model</dd>

            </div>
            <div><dt>lightning.pytorch.core.hooks.DataHooks</dt>
                                <dd id="SequenceModule.prepare_data_per_node" class="variable">prepare_data_per_node</dd>
                <dd id="SequenceModule.allow_zero_length_dataloader_with_multiple_devices" class="variable">allow_zero_length_dataloader_with_multiple_devices</dd>
                <dd id="SequenceModule.prepare_data" class="function">prepare_data</dd>
                <dd id="SequenceModule.transfer_batch_to_device" class="function">transfer_batch_to_device</dd>
                <dd id="SequenceModule.on_before_batch_transfer" class="function">on_before_batch_transfer</dd>
                <dd id="SequenceModule.on_after_batch_transfer" class="function">on_after_batch_transfer</dd>

            </div>
            <div><dt>lightning.pytorch.core.hooks.CheckpointHooks</dt>
                                <dd id="SequenceModule.on_load_checkpoint" class="function">on_load_checkpoint</dd>
                <dd id="SequenceModule.on_save_checkpoint" class="function">on_save_checkpoint</dd>

            </div>
            <div><dt>torch.nn.modules.module.Module</dt>
                                <dd id="SequenceModule.dump_patches" class="variable">dump_patches</dd>
                <dd id="SequenceModule.training" class="variable">training</dd>
                <dd id="SequenceModule.call_super_init" class="variable">call_super_init</dd>
                <dd id="SequenceModule.register_buffer" class="function">register_buffer</dd>
                <dd id="SequenceModule.register_parameter" class="function">register_parameter</dd>
                <dd id="SequenceModule.add_module" class="function">add_module</dd>
                <dd id="SequenceModule.register_module" class="function">register_module</dd>
                <dd id="SequenceModule.get_submodule" class="function">get_submodule</dd>
                <dd id="SequenceModule.get_parameter" class="function">get_parameter</dd>
                <dd id="SequenceModule.get_buffer" class="function">get_buffer</dd>
                <dd id="SequenceModule.get_extra_state" class="function">get_extra_state</dd>
                <dd id="SequenceModule.set_extra_state" class="function">set_extra_state</dd>
                <dd id="SequenceModule.apply" class="function">apply</dd>
                <dd id="SequenceModule.ipu" class="function">ipu</dd>
                <dd id="SequenceModule.xpu" class="function">xpu</dd>
                <dd id="SequenceModule.bfloat16" class="function">bfloat16</dd>
                <dd id="SequenceModule.to_empty" class="function">to_empty</dd>
                <dd id="SequenceModule.register_full_backward_pre_hook" class="function">register_full_backward_pre_hook</dd>
                <dd id="SequenceModule.register_backward_hook" class="function">register_backward_hook</dd>
                <dd id="SequenceModule.register_full_backward_hook" class="function">register_full_backward_hook</dd>
                <dd id="SequenceModule.register_forward_pre_hook" class="function">register_forward_pre_hook</dd>
                <dd id="SequenceModule.register_forward_hook" class="function">register_forward_hook</dd>
                <dd id="SequenceModule.register_state_dict_pre_hook" class="function">register_state_dict_pre_hook</dd>
                <dd id="SequenceModule.state_dict" class="function">state_dict</dd>
                <dd id="SequenceModule.register_load_state_dict_post_hook" class="function">register_load_state_dict_post_hook</dd>
                <dd id="SequenceModule.load_state_dict" class="function">load_state_dict</dd>
                <dd id="SequenceModule.parameters" class="function">parameters</dd>
                <dd id="SequenceModule.named_parameters" class="function">named_parameters</dd>
                <dd id="SequenceModule.buffers" class="function">buffers</dd>
                <dd id="SequenceModule.named_buffers" class="function">named_buffers</dd>
                <dd id="SequenceModule.children" class="function">children</dd>
                <dd id="SequenceModule.named_children" class="function">named_children</dd>
                <dd id="SequenceModule.modules" class="function">modules</dd>
                <dd id="SequenceModule.named_modules" class="function">named_modules</dd>
                <dd id="SequenceModule.train" class="function">train</dd>
                <dd id="SequenceModule.eval" class="function">eval</dd>
                <dd id="SequenceModule.requires_grad_" class="function">requires_grad_</dd>
                <dd id="SequenceModule.zero_grad" class="function">zero_grad</dd>
                <dd id="SequenceModule.share_memory" class="function">share_memory</dd>
                <dd id="SequenceModule.extra_repr" class="function">extra_repr</dd>
                <dd id="SequenceModule.compile" class="function">compile</dd>

            </div>
                                </dl>
                            </div>
                </section>
    </main>
</body>
</html>